=== Project Merge Report: 2025. 12. 29. ì˜¤ì „ 12:28:54 ===
=== Total Files Found: 20 ===



// ==========================================
// [1/20] FILE: .env
// ==========================================

# .env íŒŒì¼ ë‚´ìš©

# ì„œë²„ í¬íŠ¸ (ê¸°ë³¸ 3000)
PORT=3000

# 1. MongoDB ì—°ê²° ì£¼ì†Œ (ë”°ì˜´í‘œ ì—†ì´ ì…ë ¥)
# ì˜ˆì‹œ: mongodb+srv://<ì•„ì´ë””>:<ë¹„ë°€ë²ˆí˜¸>@cluster0.abcde.mongodb.net/inventoryDB
MONGO_URI=mongodb+srv://admin:Angelious1@cluster0.38gttwb.mongodb.net/?appName=Cluster0

# 2. Redis ì—°ê²° ì£¼ì†Œ
# ì˜ˆì‹œ: redis://default:<ë¹„ë°€ë²ˆí˜¸>@redis-12345.c1.asia-northeast1-1.gce.cloud.redislabs.com:12345
REDIS_HOST=redis-15868.c270.us-east-1-3.ec2.cloud.redislabs.com
REDIS_PORT=15868
REDIS_PASSWORD=UMXqfzWuxz0LTtg8pczf4994WFm2okGt

# 3. ì„¸ì…˜ ì•”í˜¸í™” í‚¤ (ì•„ë¬´ ê¸€ìë‚˜ ê¸¸ê²Œ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤)
SESSION_SECRET=Angelious1
DATA_GO_KR_KEY=7846696c8c000983af2191f052860ee31fd633d8196abd6b5fc51ed08caf96d0


// --- END OF FILE: .env ---


// ==========================================
// [2/20] FILE: config\redis.js
// ==========================================

const { createClient } = require("redis");
const dotenv = require("dotenv");

dotenv.config();

// .envì— ìˆëŠ” ì •ë³´ë“¤ì„ ì¡°í•©í•´ì„œ ì ‘ì† ì£¼ì†Œ(URL)ë¥¼ ë§Œë“­ë‹ˆë‹¤.
// í˜•ì‹: redis://default:ë¹„ë°€ë²ˆí˜¸@ì£¼ì†Œ:í¬íŠ¸
const redisUrl = `redis://default:${process.env.REDIS_PASSWORD}@${process.env.REDIS_HOST}:${process.env.REDIS_PORT}`;

// Redis í´ë¼ì´ì–¸íŠ¸ ìƒì„±
const client = createClient({
  url: redisUrl,
});

client.on("error", (err) => console.error("âŒ Redis Client Error", err));
client.on("connect", () => console.log("âœ… Redis ì—°ê²° ì„±ê³µ!"));

// ì—°ê²° ì‹œì‘ í•¨ìˆ˜
const connectRedis = async () => {
  if (!client.isOpen) {
    await client.connect();
  }
};

// ì—°ê²° ì‹¤í–‰
connectRedis();

module.exports = client;


// --- END OF FILE: config\redis.js ---


// ==========================================
// [3/20] FILE: merge.js
// ==========================================

const fs = require("fs");
const path = require("path");

// --- ì„¤ì • ---
const TARGET_DIR = "./"; // í˜„ì¬ í´ë” ì „ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•¨
const OUTPUT_FILE = "merged_code_report.txt";
const EXTENSIONS = [".js", ".json", ".html", ".css", ".env"]; // í¬í•¨í•  í™•ì¥ì (.cs ì œê±°, .env/.css ì¶”ê°€)

// ì œì™¸í•  í´ë” ë° íŒŒì¼ ëª©ë¡
const EXCLUDE_NAMES = [
  "node_modules",
  "Library",
  ".git",
  "package-lock.json", // ë³‘í•© ì‹œ ë„ˆë¬´ ê¸¸ì–´ì§€ë¯€ë¡œ ì œì™¸ ê¶Œì¥
  OUTPUT_FILE, // ìê¸° ìì‹ (ê²°ê³¼ íŒŒì¼) ì œì™¸
];

function readFiles(dir, allFiles = []) {
  if (!fs.existsSync(dir)) return allFiles;

  const files = fs.readdirSync(dir);
  files.forEach((file) => {
    const filePath = path.join(dir, file);
    const stats = fs.statSync(filePath);

    // 1. ì œì™¸ ëª©ë¡ì— í¬í•¨ëœ ì´ë¦„ì´ë©´ ê±´ë„ˆëœ€
    if (EXCLUDE_NAMES.includes(file)) return;

    if (stats.isDirectory()) {
      // 2. ì¬ê·€ì ìœ¼ë¡œ í•˜ìœ„ í´ë” íƒìƒ‰
      readFiles(filePath, allFiles);
    } else {
      // 3. í™•ì¥ì ì²´í¬ í›„ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
      if (EXTENSIONS.includes(path.extname(file)) || file === ".env") {
        allFiles.push(filePath);
      }
    }
  });
  return allFiles;
}

function mergeFiles() {
  try {
    console.log("ğŸ” íŒŒì¼ì„ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...");
    const files = readFiles(TARGET_DIR);

    let combinedContent = `=== Project Merge Report: ${new Date().toLocaleString()} ===\n`;
    combinedContent += `=== Total Files Found: ${files.length} ===\n\n`;

    files.forEach((file, index) => {
      const content = fs.readFileSync(file, "utf8");
      combinedContent += `\n\n// ==========================================\n`;
      combinedContent += `// [${index + 1}/${files.length}] FILE: ${file}\n`;
      combinedContent += `// ==========================================\n\n`;
      combinedContent += content;
      combinedContent += `\n\n// --- END OF FILE: ${file} ---\n`;
      console.log(`âœ… ë³‘í•© ì¤‘: ${file}`);
    });

    fs.writeFileSync(OUTPUT_FILE, combinedContent);
    console.log(
      `\nâœ¨ ì„±ê³µ! ì´ ${files.length}ê°œì˜ íŒŒì¼ì´ ${OUTPUT_FILE}ì— ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤.`
    );
  } catch (err) {
    console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", err);
  }
}

mergeFiles();


// --- END OF FILE: merge.js ---


// ==========================================
// [4/20] FILE: models\Event.js
// ==========================================

const mongoose = require("mongoose");

// í•˜ìœ„ ë¬¸ì„œ(ë°°ì—´ ë‚´ë¶€ ì•„ì´í…œ) ìŠ¤í‚¤ë§ˆ
const subItemSchema = new mongoose.Schema({
  name: String,
  size: String,
  length: String,
  quantity: Number,
  role: String, // 'product'(ì‚°ì¶œë¬¼/ì…ì¶œê³ ëŒ€ìƒ) ë˜ëŠ” 'material'(ì†Œëª¨ëœ ì›ìì¬)
});

const eventSchema = new mongoose.Schema({
  title: { type: String },
  start: { type: Date, required: true },
  allDay: { type: Boolean, default: true },
  type: { type: String, enum: ["ì…ê³ ", "ì¶œê³ ", "ìƒì‚°"], required: true },

  // [ë³€ê²½] ê¸°ì¡´ ë‹¨ì¼ í•„ë“œë“¤ ëŒ€ì‹  ë°°ì—´ ì‚¬ìš©
  items: [subItemSchema],

  createdBy: { type: String },
  createdAt: { type: Date, default: Date.now },
});

module.exports = mongoose.model("Event", eventSchema);


// --- END OF FILE: models\Event.js ---


// ==========================================
// [5/20] FILE: models\Item.js
// ==========================================

const mongoose = require("mongoose");

const itemSchema = new mongoose.Schema({
  name: { type: String, required: true },
  size: { type: String }, // [ì¶”ê°€] ì˜ˆ: XL, 100mm
  length: { type: String }, // [ì¶”ê°€] ì˜ˆ: 10m
  quantity: { type: Number, default: 0 },
  category: { type: String, default: "ê¸°íƒ€" },
  lastUpdatedBy: { type: String },
  createdAt: { type: Date, default: Date.now },
  updatedAt: { type: Date, default: Date.now },
});

module.exports = mongoose.model("Item", itemSchema);


// --- END OF FILE: models\Item.js ---


// ==========================================
// [6/20] FILE: models\Option.js
// ==========================================

const mongoose = require("mongoose");

const optionSchema = new mongoose.Schema({
  type: { type: String, required: true }, // 'itemName', 'size', 'length' ì¤‘ í•˜ë‚˜
  value: { type: String, required: true }, // ì‹¤ì œ ê°’ (ì˜ˆ: 'íŒŒì´í”„', '100mm')
});

module.exports = mongoose.model("Option", optionSchema);


// --- END OF FILE: models\Option.js ---


// ==========================================
// [7/20] FILE: models\User.js
// ==========================================

const mongoose = require("mongoose");

const userSchema = new mongoose.Schema({
  username: { type: String, required: true, unique: true },
  password: { type: String, required: true },
  nickname: { type: String },

  // ê´€ë¦¬ì/ìœ ì € êµ¬ë¶„ (ê¸°ë³¸ê°’: user)
  role: { type: String, enum: ["user", "admin"], default: "user" },

  // ìŠ¹ì¸ ì—¬ë¶€ (ê¸°ë³¸ê°’: false -> ë¡œê·¸ì¸ ë¶ˆê°€)
  isApproved: { type: Boolean, default: false },

  createdAt: { type: Date, default: Date.now },
});

module.exports = mongoose.model("User", userSchema);


// --- END OF FILE: models\User.js ---


// ==========================================
// [8/20] FILE: package.json
// ==========================================

{
  "name": "webcal",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "type": "commonjs",
  "dependencies": {
    "axios": "^1.13.2",
    "bcryptjs": "^3.0.3",
    "connect-redis": "^9.0.0",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.2.1",
    "express-session": "^1.18.2",
    "mongoose": "^9.0.2",
    "redis": "^5.10.0",
    "socket.io": "^4.8.1"
  },
  "devDependencies": {
    "nodemon": "^3.1.11"
  }
}


// --- END OF FILE: package.json ---


// ==========================================
// [9/20] FILE: public\admin.html
// ==========================================

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        body { padding: 15px; font-family: sans-serif; max-width: 1000px; margin: 0 auto; background-color: #f9f9f9; }
        h1 { font-size: 1.6rem; color: #333; }
        .nav-links { margin-bottom: 20px; font-size: 14px; }
        .section { background: white; margin-bottom: 25px; border: 1px solid #ddd; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; border-bottom: 2px solid #333; padding-bottom: 10px; font-size: 1.2rem; }
        h3 { font-size: 1rem; margin-bottom: 10px; color: #555; }
        
        /* ê¸°ì´ˆ ë°ì´í„° ê´€ë¦¬ ê·¸ë¦¬ë“œ */
        .option-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .option-grid { grid-template-columns: repeat(3, 1fr); } }

        .input-group { display: flex; gap: 5px; margin-bottom: 15px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; }
        button { padding: 10px 15px; cursor: pointer; border-radius: 6px; border: none; background: #333; color: white; font-weight: bold; }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag { background: #eee; padding: 6px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .tag button { background: #ff4444; color: white; width: 18px; height: 18px; padding: 0; line-height: 18px; font-size: 10px; border-radius: 50%; }

        /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ */
        .table-wrapper { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; font-size: 14px; }
        th { background: #f2f2f2; }
        .btn-approve { background: #4CAF50; color: white; padding: 8px 12px; }
        .btn-ban { background: #F44336; color: white; padding: 8px 12px; }
    </style>
</head>
<body>
    <h1>ğŸ›¡ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <div class="nav-links">
        <a href="/inventory.html">ğŸ“¦ ì¬ê³ ê´€ë¦¬</a> | 
        <a href="/calendar.html">ğŸ“… ë‹¬ë ¥ë³´ê¸°</a>
    </div>

    <div class="section">
        <h2>âš™ï¸ ê¸°ì´ˆ ë°ì´í„° ê´€ë¦¬</h2>
        <div class="option-grid">
            <div>
                <h3>í’ˆëª©ëª… (Item Name)</h3>
                <div class="input-group">
                    <input type="text" id="new-item" placeholder="ì¶”ê°€">
                    <button onclick="addOption('itemName', 'new-item')">ì¶”ê°€</button>
                </div>
                <div id="list-itemName" class="tag-container"></div>
            </div>

            <div>
                <h3>ì‚¬ì´ì¦ˆ (Size)</h3>
                <div class="input-group">
                    <input type="text" id="new-size" placeholder="ì¶”ê°€">
                    <button onclick="addOption('size', 'new-size')">ì¶”ê°€</button>
                </div>
                <div id="list-size" class="tag-container"></div>
            </div>

            <div>
                <h3>ê¸¸ì´ (Length)</h3>
                <div class="input-group">
                    <input type="text" id="new-length" placeholder="ì¶”ê°€">
                    <button onclick="addOption('length', 'new-length')">ì¶”ê°€</button>
                </div>
                <div id="list-length" class="tag-container"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ‘¥ íšŒì› ê°€ì… ìŠ¹ì¸</h2>
        <button onclick="loadPendingUsers()" style="background:#2196F3; margin-bottom:15px;">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th>ì•„ì´ë””</th><th>ë‹‰ë„¤ì„</th><th>ì‹ ì²­ì¼</th><th>ê´€ë¦¬</th></tr>
                </thead>
                <tbody id="user-list"></tbody>
            </table>
        </div>
    </div>

    <script>
        const API_OPT = '/api/options';
        const API_ADMIN = '/api/admin';

        window.onload = function() { loadOptions(); loadPendingUsers(); };

        async function loadOptions() {
            const res = await fetch(API_OPT);
            const options = await res.json();
            document.getElementById('list-itemName').innerHTML = '';
            document.getElementById('list-size').innerHTML = '';
            document.getElementById('list-length').innerHTML = '';

            options.forEach(opt => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `${opt.value} <button onclick="deleteOption('${opt._id}')">x</button>`;
                document.getElementById(`list-${opt.type}`).appendChild(tag);
            });
        }

        async function addOption(type, inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            if(!value) return;
            const res = await fetch(API_OPT, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type, value })
            });
            if(res.ok) { input.value = ''; loadOptions(); }
        }

        async function deleteOption(id) {
            if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await fetch(`${API_OPT}/${id}`, { method: 'DELETE' });
            loadOptions();
        }

        async function loadPendingUsers() {
            const res = await fetch(`${API_ADMIN}/pending`);
            const users = await res.json();
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            if (users.length === 0) {
                list.innerHTML = '<tr><td colspan="4">ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }
            users.forEach(user => {
                list.innerHTML += `
                    <tr>
                        <td>${user.username}</td>
                        <td>${user.nickname}</td>
                        <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                        <td>
                            <button class="btn-approve" onclick="approveUser('${user.username}')">ìŠ¹ì¸</button>
                            <button class="btn-ban" onclick="banUser('${user.username}')">ê±°ì ˆ</button>
                        </td>
                    </tr>`;
            });
        }
        
        async function approveUser(username) {
            await fetch(`${API_ADMIN}/approve`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targetUsername: username })
            });
            alert('ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPendingUsers();
        }

        async function banUser(username) {
            if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await fetch(`${API_ADMIN}/ban`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ targetUsername: username })
            });
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPendingUsers();
        }
    </script>
</body>
</html>

// --- END OF FILE: public\admin.html ---


// ==========================================
// [10/20] FILE: public\calendar.html
// ==========================================

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ­ ìƒì‚° ë° ì¬ê³  ë‹¬ë ¥</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ ë° í°íŠ¸ */
        body { padding: 15px; font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; margin: 0; color: #333; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .header h1 { font-size: 1.6rem; margin: 0; }
        .nav-btns { display: flex; gap: 8px; align-items: center; }
        #calendar { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: none; }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ ìŠ¤íƒ€ì¼ */
        .spinner { 
            width: 50px; height: 50px; 
            border: 5px solid #e0e0e0; 
            border-top: 5px solid #2196F3; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ëª¨ë‹¬ ë° í¼ ìŠ¤íƒ€ì¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 95%; max-width: 600px; padding: 30px; margin: 40px auto; border-radius: 24px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); box-sizing: border-box; }
        .form-group { margin-bottom: 18px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 700; color: #444; font-size: 15px; }
        .form-group select, .form-group input { width: 100%; height: 50px; padding: 0 15px; border: 2px solid #eef0f2; border-radius: 12px; font-size: 16px; box-sizing: border-box; background-color: #fdfdfd; transition: all 0.2s; }
        .table-container { width: 100%; overflow-x: auto; margin-top: 10px; border-radius: 12px; border: 1px solid #eee; }
        .item-table { width: 100%; border-collapse: collapse; min-width: 450px; }
        .item-table th { background: #f8f9fa; padding: 12px; font-size: 14px; color: #666; }
        .item-table td { padding: 10px; border-bottom: 1px solid #f1f1f1; text-align: center; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button { padding: 12px 20px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; transition: all 0.2s; }
        .btn-blue { background: #2196F3; color: white; width: 100%; font-size: 16px; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.3); }
        .btn-green { background: #4CAF50; color: white; }
        .btn-red { background: #F44336; color: white; }
        .btn-gray { background: #eee; color: #333; }
        .floating-btn { position: fixed; bottom: 30px; right: 30px; width: 65px; height: 65px; background: linear-gradient(135deg, #2196F3, #1976D2); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 30px; box-shadow: 0 8px 20px rgba(33, 150, 243, 0.4); z-index: 999; border: none; }

        /* --- ë‹¬ë ¥ ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ (ê³µíœ´ì¼ ê´€ë ¨) --- */
        .fc-day-sun .fc-daygrid-day-number { color: #F44336 !important; }
        .fc-day-sat .fc-daygrid-day-number { color: #2196F3 !important; }
        .fc-day-today .fc-daygrid-day-number { color: #2196F3 !important; text-decoration: underline; }
        .fc-event-time { display: none !important; }

        /* ë‚ ì§œ ìƒë‹¨ ì˜ì—­ ìš°ì¸¡ ì •ë ¬ */
        .fc-daygrid-day-top {
            flex-direction: column !important;
            align-items: flex-end !important;
            padding-right: 5px !important;
        }

        .fc-daygrid-day-number {
            float: none !important;
            padding: 0 !important;
        }

        /* ê³µíœ´ì¼ ì´ë¦„ ìŠ¤íƒ€ì¼ (ìš°ì¸¡ ì •ë ¬ ë° ê´„í˜¸) */
        .holiday-name {
            font-size: 0.65rem;
            color: #F44336;
            margin-top: -2px;
            font-weight: 500;
            text-align: right;
            line-height: 1.1;
            display: block;
        }
    </style>
</head>
<body>
    <div id="loading-layer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: bold; color: #333;">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <div class="header">
        <h1>ğŸ“… ìƒì‚° ë° ì¬ê³  ë‹¬ë ¥</h1>
        <div class="nav-btns">
            <span id="user-display" style="font-weight: 800; color: #2196F3; background: white; padding: 8px 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);"></span>
            <button class="btn-gray" onclick="location.href='/inventory.html'">ğŸ“¦ ì¬ê³ í˜„í™©</button>
            <button class="btn-gray" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div style="margin-bottom: 15px; display: flex; gap: 15px; font-size: 14px; font-weight: bold;">
        <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 12px; height: 12px; background: #4CAF50; border-radius: 3px;"></span> ì…ê³ </span>
        <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 12px; height: 12px; background: #F44336; border-radius: 3px;"></span> ì¶œê³ </span>
        <span style="display: flex; align-items: center; gap: 5px;"><span style="width: 12px; height: 12px; background: #2196F3; border-radius: 3px;"></span> ìƒì‚°</span>
    </div>

    <div id="calendar"></div>

    <button class="floating-btn" onclick="openQuickAdd()">+</button>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">ğŸ“ ì‘ì—… ë“±ë¡</h3>
            <input type="hidden" id="edit-event-id">
            <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="modal-date"></div>
            <div class="form-group">
                <label>ì‘ì—… êµ¬ë¶„</label>
                <select id="modal-type" onchange="toggleProductionMode()">
                    <option value="ì…ê³ ">ğŸŸ¢ ì…ê³ </option>
                    <option value="ì¶œê³ ">ğŸ”´ ì¶œê³ </option>
                    <option value="ìƒì‚°">ğŸ”µ ìƒì‚°</option>
                </select>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                <label style="font-weight:bold;">ğŸ“¦ ëŒ€ìƒ í’ˆëª©</label>
                <button class="btn-green" onclick="addRow('product-tbody')" style="padding:6px 12px; font-size:12px;">+ í’ˆëª©ì¶”ê°€</button>
            </div>
            <div class="table-container">
                <table class="item-table">
                    <thead><tr><th>í’ˆëª©</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th><th>ì‚­ì œ</th></tr></thead>
                    <tbody id="product-tbody"></tbody>
                </table>
            </div>
            <div id="material-section" style="display:none; margin-top:20px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-weight:bold; color: #F44336;">ğŸ”¨ ì†Œëª¨ ì›ìì¬</label>
                    <button class="btn-red" onclick="addRow('material-tbody')" style="padding:6px 12px; font-size:12px;">+ ìì¬ì¶”ê°€</button>
                </div>
                <div class="table-container">
                    <table class="item-table">
                        <thead><tr><th>í’ˆëª©</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th><th>ì‚­ì œ</th></tr></thead>
                        <tbody id="material-tbody"></tbody>
                    </table>
                </div>
            </div>
            <div style="margin-top: 30px; display: flex; flex-direction: column; gap: 10px;">
                <button class="btn-blue" onclick="saveEvent()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-gray" onclick="closeModal()" style="flex:1;">ì·¨ì†Œ</button>
                    <button id="btn-delete" class="btn-red" onclick="deleteEvent()" style="flex:1; display:none;">ğŸ—‘ ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/calendar';
        const API_OPT = '/api/options';
        const currentUser = localStorage.getItem('username');
        const currentNick = localStorage.getItem('nickname');

        let holidayCache = {}; 
        let dropdownOptions = { items: [], sizes: [], lengths: [] };
        let calendarInstance;

        // ë¡œë”© ì œì–´ í•¨ìˆ˜
        function showLoading(show) {
            const loader = document.getElementById('loading-layer');
            if(loader) loader.style.display = show ? 'flex' : 'none';
        }

        if (!currentUser) { location.href = '/'; }
        document.getElementById('user-display').innerText = `ğŸ‘¤ ${currentNick || currentUser}ë‹˜`;

        document.addEventListener('DOMContentLoaded', async function() {
            showLoading(true); // ì´ˆê¸° ë¡œë”© ì‹œì‘
            try {
                await loadDropdownOptions();
                initCalendar();
            } finally {
                setTimeout(() => showLoading(false), 300);
            }
        });

        async function fetchYearHolidays(year) {
            if (holidayCache[year]) return; 
            showLoading(true);
            try {
                const res = await fetch(`/api/holidays/${year}`);
                const data = await res.json();
                holidayCache[year] = data;
                if (calendarInstance) calendarInstance.render(); 
            } catch (err) {
                console.error(year + "ë…„ ê³µíœ´ì¼ ë¡œë“œ ì‹¤íŒ¨:", err);
            } finally {
                showLoading(false);
            }
        }

        async function loadDropdownOptions() {
            try {
                const res = await fetch(API_OPT);
                const data = await res.json();
                dropdownOptions.items = data.filter(d => d.type === 'itemName' || d.type === 'item').map(d => d.value);
                dropdownOptions.sizes = data.filter(d => d.type === 'size').map(d => d.value);
                dropdownOptions.lengths = data.filter(d => d.type === 'length').map(d => d.value);
            } catch (err) { console.error(err); }
        }

        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            calendarInstance = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                selectable: true,
                height: 'auto',
                displayEventTime: false,
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,listMonth'
                },
                
                datesSet: async function(info) {
                    const currentYear = info.view.currentStart.getFullYear();
                    const nextYear = currentYear + 1;
                    await fetchYearHolidays(currentYear);
                    await fetchYearHolidays(nextYear);
                },

                dayCellDidMount: function(info) {
                    const dateStr = info.date.toLocaleDateString('sv-SE');
                    const year = info.date.getFullYear();
                    const holiday = holidayCache[year] ? holidayCache[year].find(h => h.date === dateStr) : null;
                    
                    if (info.date.getDay() === 0 || holiday) {
                        const numberEl = info.el.querySelector('.fc-daygrid-day-number');
                        if (numberEl) {
                            numberEl.style.setProperty('color', '#F44336', 'important');
                            if (holiday && !info.el.querySelector('.holiday-name')) {
                                const nameDiv = document.createElement('div');
                                nameDiv.className = 'holiday-name';
                                nameDiv.innerText = `(${holiday.name})`;
                                numberEl.parentElement.appendChild(nameDiv);
                            }
                        }
                    }
                },

                events: async function(info, successCallback, failureCallback) {
                    try {
                        const res = await fetch(API_URL);
                        const rawEvents = await res.json();
                        const events = rawEvents.map(event => {
                            let color = '#4CAF50';
                            if (event.type === 'ì¶œê³ ') color = '#F44336';
                            else if (event.type === 'ìƒì‚°') color = '#2196F3';
                            return {
                                id: event._id,
                                title: event.title,
                                start: event.start,
                                backgroundColor: color,
                                borderColor: color,
                                textColor: '#ffffff',
                                extendedProps: { type: event.type, items: event.items }
                            };
                        });
                        successCallback(events);
                    } catch (err) { failureCallback(err); }
                },
                select: (info) => openModal(info.startStr, null),
                eventClick: (info) => openModal(info.event.startStr, info.event)
            });
            calendarInstance.render();
        }

        async function saveEvent() {
            const id = document.getElementById('edit-event-id').value;
            const type = document.getElementById('modal-type').value;
            const date = document.getElementById('modal-date').value;
            
            const getItems = (tbodyId) => Array.from(document.querySelectorAll(`#${tbodyId} tr`)).map(tr => {
                return {
                    name: tr.querySelector('.input-name').value.trim(),
                    size: tr.querySelector('.input-size').value || "-",
                    length: tr.querySelector('.input-length').value || "-",
                    quantity: parseFloat(parseFloat(tr.querySelector('.input-qty').value).toFixed(1))
                };
            }).filter(i => i.name);

            const products = getItems('product-tbody');
            const materials = type === 'ìƒì‚°' ? getItems('material-tbody') : [];
            if(!products.length) return alert("í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”.");

            const url = id ? `${API_URL}/${id}` : API_URL;
            const method = id ? 'PUT' : 'POST';

            showLoading(true); // ì €ì¥ ì‹œ ë¡œë”© ì‹œì‘
            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ start: date, type, username: currentNick || currentUser, products, materials })
                });
                if(res.ok) { 
                    alert(id ? "ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤." : "ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeModal(); 
                    calendarInstance.refetchEvents(); 
                } else {
                    const errData = await res.json();
                    alert("ì˜¤ë¥˜ ë°œìƒ: " + errData.message);
                }
            } catch (err) { 
                console.error("ì €ì¥ ì‹¤íŒ¨:", err); 
            } finally {
                setTimeout(() => showLoading(false), 300);
            }
        }

        function logout() { localStorage.removeItem('username'); localStorage.removeItem('nickname'); location.href = '/'; }
        function openQuickAdd() { const today = new Date().toISOString().split('T')[0]; openModal(today, null); }
        function openModal(dateStr, event) {
            document.getElementById('modal-date').value = dateStr.split('T')[0];
            document.getElementById('product-tbody').innerHTML = '';
            document.getElementById('material-tbody').innerHTML = '';
            if (event) {
                document.getElementById('edit-event-id').value = event.id;
                document.getElementById('modal-title').innerText = "ğŸ“ ì‘ì—… ìˆ˜ì •";
                document.getElementById('btn-delete').style.display = 'inline-block';
                const props = event.extendedProps;
                document.getElementById('modal-type').value = props.type;
                if (props.items) {
                    props.items.forEach(item => { addRow(item.role === 'material' ? 'material-tbody' : 'product-tbody', item); });
                }
            } else {
                document.getElementById('edit-event-id').value = '';
                document.getElementById('modal-title').innerText = "ğŸ“ ìƒˆ ì‘ì—… ë“±ë¡";
                document.getElementById('btn-delete').style.display = 'none';
                addRow('product-tbody'); 
            }
            toggleProductionMode();
            document.getElementById('eventModal').style.display = 'block';
        }
        function closeModal() { document.getElementById('eventModal').style.display = 'none'; }
        function toggleProductionMode() { document.getElementById('material-section').style.display = (document.getElementById('modal-type').value === 'ìƒì‚°') ? 'block' : 'none'; }
        function addRow(tbodyId, data = null) {
            const tbody = document.getElementById(tbodyId);
            const tr = document.createElement('tr');
            const createOpts = (list, selectedVal) => {
                let html = '<option value="">ì„ íƒ</option>';
                list.forEach(v => html += `<option value="${v}" ${String(v)===String(selectedVal)?'selected':''}>${v}</option>`);
                return html;
            };
            tr.innerHTML = `
                <td><select class="input-name">${createOpts(dropdownOptions.items, data?.name)}</select></td>
                <td><select class="input-size">${createOpts(dropdownOptions.sizes, data?.size)}</select></td>
                <td><select class="input-length">${createOpts(dropdownOptions.lengths, data?.length)}</select></td>
                <td><input type="number" class="input-qty" step="0.1" value="${data?.quantity || 1}" style="width:60px; height:35px; border-radius:8px; border:1px solid #ddd; text-align:center;"></td>
                <td><button onclick="this.closest('tr').remove()" style="background:none; font-size:18px;">âŒ</button></td>
            `;
            tbody.appendChild(tr);
        }
        async function deleteEvent() {
            if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const id = document.getElementById('edit-event-id').value;
            showLoading(true); // ì‚­ì œ ì‹œ ë¡œë”© ì‹œì‘
            try {
                const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                if(res.ok) { 
                    closeModal(); 
                    calendarInstance.refetchEvents(); 
                }
            } finally {
                showLoading(false);
            }
        }
    </script>
</body>
</html>

// --- END OF FILE: public\calendar.html ---


// ==========================================
// [11/20] FILE: public\css\style.css
// ==========================================

/* 1. í”Œë¡œíŒ… ë²„íŠ¼: í¬ê¸°ë¥¼ í‚¤ìš°ê³  ë” ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì ì ìš© */
.floating-btn {
    position: fixed;
    bottom: 30px; /* ìœ„ì¹˜ë¥¼ ì¡°ê¸ˆ ë” ìœ„ë¡œ */
    right: 30px;
    width: 70px;  /* 60 -> 70 í™•ì¥ */
    height: 70px;
    border-radius: 50%;
    background: linear-gradient(135deg, #007bff, #0056b3); /* ê·¸ë¼ë°ì´ì…˜ ì¶”ê°€ */
    color: white;
    font-size: 35px;
    border: none;
    box-shadow: 0 8px 16px rgba(0,123,255,0.3); /* íŒŒë€ìƒ‰ ê³„ì—´ ê·¸ë¦¼ì */
    z-index: 1000;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
}

.floating-btn:hover {
    transform: scale(1.1) rotate(90deg); /* í˜¸ë²„ ì‹œ ì»¤ì§€ë©´ì„œ íšŒì „ */
}

.floating-btn:active {
    transform: scale(0.9);
}

/* 2. ì¹´í…Œê³ ë¦¬ ë°°ì§€: ë” ë‘¥ê¸€ê²Œ í•˜ê³  ì…ì²´ê° ì¶”ê°€ */
.category-badge {
    color: white;
    padding: 6px 14px; /* íŒ¨ë”© í™•ì¥ */
    border-radius: 50px; /* ì™„ì „ íƒ€ì›í˜•ìœ¼ë¡œ */
    font-size: 0.9em;
    font-weight: 700;
    letter-spacing: -0.5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: inline-block;
}

/* 3. ìˆ˜ëŸ‰ ì¡°ì ˆ ë° í…ìŠ¤íŠ¸: ì‹œì¸ì„± ê·¹ëŒ€í™” */
.qty-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px; /* ê°„ê²© í™•ì¥ */
    background: #f1f3f5; /* ë°°ê²½ ì¶”ê°€ë¡œ ì˜ì—­ êµ¬ë¶„ */
    padding: 5px 12px;
    border-radius: 12px;
}

.qty-text {
    min-width: 45px;
    font-size: 1.3em; /* ë” í¬ê²Œ */
    font-weight: 900; /* ì•„ì£¼ ë‘ê»ê²Œ */
    color: #000;      /* ë” ì§„í•˜ê²Œ */
    text-align: center;
}

/* 4. ì…ë ¥ ê·¸ë¦¬ë“œ ë° ë“œë¡­ë‹¤ìš´/ì…ë ¥ì°½ UI ê°œì„  */
.input-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px; /* ê°„ê²© í™•ì¥ */
    align-items: center;
}

@media (min-width: 768px) {
    .input-grid { grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr 1fr; }
}

/* ë“œë¡­ë‹¤ìš´/ì…ë ¥ì°½: í¬ê²Œ, ë‘¥ê¸€ê²Œ, í™”ì‚¬í•˜ê²Œ */
.input-grid select, 
.input-grid input {
    width: 100%;
    height: 56px; /* 48 -> 56 ëŒ€í­ í™•ì¥ */
    padding: 0 20px;
    border: 2px solid #edf2f7; /* ì„ ì„ ë” ëª…í™•í•˜ê²Œ */
    border-radius: 16px;       /* í›¨ì”¬ ë‘¥ê¸€ê²Œ */
    font-size: 16px;           /* í°íŠ¸ í¬ê¸° ì—… */
    font-weight: 500;
    color: #2d3748;
    background-color: #fdfdfd;
    transition: all 0.2s ease-in-out;
    appearance: none;
    -webkit-appearance: none;
}

/* ì»¤ìŠ¤í…€ í™”ì‚´í‘œ ì•„ì´ì½˜ (ìœ„ì¹˜ ì¡°ì •) */
.input-grid select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%234a5568' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 20px center;
}

/* í¬ì»¤ìŠ¤ ì‹œ íš¨ê³¼ ê°•í™” */
.input-grid select:focus, 
.input-grid input:focus {
    outline: none;
    border-color: #2196F3;
    background-color: #fff;
    box-shadow: 0 0 0 4px rgba(33, 150, 243, 0.15);
    transform: translateY(-2px); /* ì‚´ì§ ë– ì˜¤ë¥´ëŠ” ëŠë‚Œ */
}

/* 5. ë“±ë¡ ë²„íŠ¼: ë” í¬ê³  ê°•ë ¥í•œ ëŠë‚Œ */
.btn-submit {
    height: 56px; /* ì…ë ¥ì°½ê³¼ ë™ì¼í•˜ê²Œ ë§ì¶¤ */
    background: linear-gradient(135deg, #444, #111); /* ê·¸ë¼ë°ì´ì…˜ */
    color: white;
    border: none;
    border-radius: 16px; /* ë‘¥ê¸€ê²Œ */
    font-weight: 800;
    font-size: 17px;
    letter-spacing: 1px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

.btn-submit:hover {
    background: #000;
    transform: translateY(-3px); /* í˜¸ë²„ ì‹œ ë¶• ëœ¨ëŠ” ëŠë‚Œ */
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

.btn-submit:active {
    transform: translateY(-1px);
}

/* ë¡œë”© ìŠ¤í”¼ë„ˆ ë””ìì¸ */
.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #e0e0e0;
    border-top: 5px solid #2196F3; /* í¬ì¸íŠ¸ ì»¬ëŸ¬ */
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

// --- END OF FILE: public\css\style.css ---


// ==========================================
// [12/20] FILE: public\index.html
// ==========================================

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì‹œìŠ¤í…œ ë¡œê·¸ì¸</title>
    <style>
        body { 
            padding: 20px; 
            font-family: 'Pretendard', sans-serif; 
            text-align: center; 
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 30px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto;
            width: 90%;
            box-sizing: border-box;
        }
        h1 { font-size: 1.5rem; color: #333; margin-bottom: 30px; }
        h3 { margin-top: 0; color: #555; }
        input { 
            padding: 15px; 
            margin: 8px 0; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px; /* ì•„ì´í° ì¤Œ ë°©ì§€ */
        }
        button { 
            padding: 15px; 
            width: 100%;
            cursor: pointer; 
            background-color: #333;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }
        .toggle-btn {
            background: none;
            color: #2196F3;
            padding: 5px;
            font-size: 14px;
            text-decoration: underline;
            width: auto;
            margin-top: 0;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>ğŸ”’ ì‹œìŠ¤í…œ ì ‘ê·¼</h1>

    <div id="login-box" class="container">
        <h3>ë¡œê·¸ì¸</h3>
        <input type="text" id="login-id" placeholder="ì•„ì´ë””">
        <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button onclick="login()">ë¡œê·¸ì¸</button>
        <p style="font-size: 14px; color: #666; margin-top: 20px;">
            ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <button class="toggle-btn" onclick="toggleView()">íšŒì›ê°€ì… ì‹ ì²­</button>
        </p>
    </div>

    <div id="register-box" class="container hidden">
        <h3>íšŒì›ê°€ì… ì‹ ì²­</h3>
        <input type="text" id="reg-id" placeholder="ì•„ì´ë””">
        <input type="password" id="reg-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <input type="text" id="reg-nick" placeholder="ë‹‰ë„¤ì„">
        <button onclick="register()">ì‹ ì²­í•˜ê¸°</button>
        <p style="font-size: 14px; color: #666; margin-top: 20px;">
            ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button class="toggle-btn" onclick="toggleView()">ë¡œê·¸ì¸ í•˜ëŸ¬ê°€ê¸°</button>
        </p>
    </div>

    <script>
        function toggleView() {
            document.getElementById('login-box').classList.toggle('hidden');
            document.getElementById('register-box').classList.toggle('hidden');
        }

        async function register() {
            const username = document.getElementById('reg-id').value;
            const password = document.getElementById('reg-pw').value;
            const nickname = document.getElementById('reg-nick').value;
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, nickname })
            });
            const data = await res.json();
            alert(data.message);
            if (res.ok) toggleView();
        }

        async function login() {
    const username = document.getElementById('login-id').value;
    const password = document.getElementById('login-pw').value;
    const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    
    if (res.ok) {
        // [ìˆ˜ì •] ì•„ì´ë””ì™€ ë‹‰ë„¤ì„ì„ ê°ê° ì €ì¥í•©ë‹ˆë‹¤.
        localStorage.setItem('username', data.user.username);
        localStorage.setItem('nickname', data.user.nickname); 
        
        alert("ë¡œê·¸ì¸ ì„±ê³µ! " + data.user.nickname + "ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.");
        
        if (data.user.role === 'admin') {
            location.href = '/admin.html';
        } else {
            location.href = '/inventory.html';
        }
    } else {
        alert(data.message);
    }
}
    </script>
</body>
</html>

// --- END OF FILE: public\index.html ---


// ==========================================
// [13/20] FILE: public\inventory.html
// ==========================================

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“¦ ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        body { padding: 15px; font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; margin: 0; color: #333; }
        .header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* ìƒë‹¨ ì…ë ¥ ë°•ìŠ¤ */
        .input-box { background: white; padding: 18px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e9ecef; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        @media (min-width: 768px) { .input-grid { grid-template-columns: repeat(6, 1fr); } }

        /* ì…ë ¥ì°½ ë””ìì¸ */
        select, input { width: 100%; height: 45px; border: 1px solid #ddd; border-radius: 8px; padding: 0 10px; font-size: 15px; box-sizing: border-box; }
        .btn-submit { background: #333; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 8px; height: 45px; }

        /* í…Œì´ë¸” ê³µí†µ ìŠ¤íƒ€ì¼ */
        .section-title { font-size: 1.2rem; margin: 30px 0 15px 0; font-weight: bold; border-left: 5px solid; padding-left: 10px; }
        .finished-title { color: #28a745; border-color: #28a745; }
        .raw-title { color: #007bff; border-color: #007bff; }

        .pc-table { width: 100%; border-collapse: collapse; display: none; background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        @media (min-width: 768px) { .pc-table { display: table; } }
        .pc-table th { background: #444; color: white; padding: 12px; font-size: 14px; }
        .pc-table td { padding: 12px; text-align: center; vertical-align: middle; border-bottom: 1px solid #eee; }

        /* ë°°ì§€ ë° ìˆ˜ëŸ‰ì¡°ì ˆ */
        .category-badge { color: white; padding: 4px 10px; border-radius: 6px; font-size: 0.85em; font-weight: bold; }
        .qty-wrapper { display: flex; align-items: center; justify-content: center; gap: 10px; }
        .qty-text { font-size: 1.1rem; font-weight: 800; color: #000; min-width: 35px; }
        .qty-btn { width: 32px; height: 32px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; font-size: 18px; color: white; }
        .btn-dec { background: #ff9800; }
        .btn-inc { background: #4CAF50; }
        .btn-del-card { background: #f44336; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }

        /* ëª¨ë°”ì¼ ì „ìš© */
        .mobile-only-section { display: block; }
        @media (min-width: 768px) { .mobile-only-section { display: none; } }
        .mobile-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid #e9ecef; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* ë¡œë”© ìŠ¤í”¼ë„ˆ */
        .spinner { width: 50px; height: 50px; border: 5px solid #e0e0e0; border-top: 5px solid #2196F3; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-layer" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 9999; justify-content: center; align-items: center; flex-direction: column;">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: bold; color: #333;">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <div class="header-box">
        <h1>ğŸ“¦ ì¬ê³  ê´€ë¦¬</h1>
        <div>
            <button onclick="location.href='/calendar.html'" style="padding:8px 15px; background:#2196F3; color:white; border:none; border-radius:5px; cursor:pointer;">ğŸ“… ë‹¬ë ¥</button>
            <button onclick="logout()" style="padding:8px 15px; background:white; border:1px solid #ccc; border-radius:5px; cursor:pointer;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="input-box">
        <h3 style="margin:0 0 15px 0;">â• ìƒˆ ë¬¼í’ˆ ë“±ë¡</h3>
        <div class="input-grid">
            <select id="new-name"><option value="" disabled selected hidden>ğŸ“¦ í’ˆëª© ì„ íƒ</option></select>
            <select id="new-size"><option value="" disabled selected hidden>ğŸ“ ì‚¬ì´ì¦ˆ ì„ íƒ</option></select>
            <select id="new-length"><option value="" disabled selected hidden>ğŸ“ ê¸¸ì´ ì„ íƒ</option></select>
            <input type="number" id="new-qty" value="0" placeholder="ìˆ˜ëŸ‰">
            <select id="new-category">
                <option value="ì™„ì œí’ˆ">ğŸŸ¢ ì™„ì œí’ˆ</option>
                <option value="ì›ìì¬">ğŸ”µ ì›ìì¬</option>
                <option value="ê¸°íƒ€">âšª ê¸°íƒ€</option>
            </select>
            <button class="btn-submit" onclick="addItem()">ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div id="user-info" style="margin-bottom: 15px; font-weight: bold; color: #666;"></div>

    <div class="inventory-container">
        <h2 class="section-title finished-title">ğŸŸ¢ ì™„ì œí’ˆ í˜„í™©</h2>
        <table class="pc-table">
            <thead>
                <tr><th>ì¹´í…Œê³ ë¦¬</th><th>í’ˆëª©ëª…</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th><th>ê´€ë¦¬</th></tr>
            </thead>
            <tbody id="pc-list-finished"></tbody>
        </table>

        <h2 class="section-title raw-title">ğŸ”µ ì›ìì¬ í˜„í™©</h2>
        <table class="pc-table">
            <thead>
                <tr><th>ì¹´í…Œê³ ë¦¬</th><th>í’ˆëª©ëª…</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th><th>ê´€ë¦¬</th></tr>
            </thead>
            <tbody id="pc-list-raw"></tbody>
        </table>

        <div class="mobile-only-section">
            <h2 class="section-title finished-title">ğŸŸ¢ ì™„ì œí’ˆ</h2>
            <div id="mobile-list-finished"></div>
            
            <h2 class="section-title raw-title">ğŸ”µ ì›ìì¬</h2>
            <div id="mobile-list-raw"></div>
        </div>
    </div>

    <script>
        const API_URL = '/api/inventory';
        const API_OPT = '/api/options';
        const currentUser = localStorage.getItem('username');
        const currentNick = localStorage.getItem('nickname');

        window.addEventListener('DOMContentLoaded', () => {
            if (!currentUser) { location.href = '/'; return; }
            const userInfoEl = document.getElementById('user-info');
            if (userInfoEl) { userInfoEl.innerText = `ğŸ‘¤ ì ‘ì†ì: ${currentNick || currentUser}ë‹˜`; }
            initPage();
        });

        async function initPage() {
            await loadOptions();
            await loadItems();
        }

        async function loadOptions() {
            try {
                const res = await fetch(API_OPT);
                const options = await res.json();
                const nameSel = document.getElementById('new-name');
                const sizeSel = document.getElementById('new-size');
                const lenSel = document.getElementById('new-length');

                nameSel.innerHTML = '<option value="" disabled selected hidden>ğŸ“¦ í’ˆëª© ì„ íƒ</option>';
                sizeSel.innerHTML = '<option value="" disabled selected hidden>ğŸ“ ì‚¬ì´ì¦ˆ ì„ íƒ</option>';
                lenSel.innerHTML = '<option value="" disabled selected hidden>ğŸ“ ê¸¸ì´ ì„ íƒ</option>';

                options.forEach(opt => {
                    const o = document.createElement('option');
                    o.value = opt.value; o.innerText = opt.value;
                    if (opt.type === 'itemName') nameSel.appendChild(o);
                    else if (opt.type === 'size') sizeSel.appendChild(o.cloneNode(true));
                    else if (opt.type === 'length') lenSel.appendChild(o.cloneNode(true));
                });
            } catch (e) { console.error(e); }
        }

        async function loadItems() {
            showLoading(true);
            try {
                const res = await fetch(API_URL);
                const items = await res.json();
                
                const finishedPC = document.getElementById('pc-list-finished');
                const rawPC = document.getElementById('pc-list-raw');
                const finishedMobile = document.getElementById('mobile-list-finished');
                const rawMobile = document.getElementById('mobile-list-raw');

                [finishedPC, rawPC, finishedMobile, rawMobile].forEach(el => el.innerHTML = '');

                items.forEach(item => {
                    const isRaw = item.category === 'ì›ìì¬';
                    const bgColor = isRaw ? '#D1E9FF' : '#D4F1D8';
                    const badgeColor = isRaw ? '#007bff' : '#28a745';

                    // 1. PC í…Œì´ë¸” í–‰ ìƒì„±
                    const tr = document.createElement('tr');
                    tr.style.backgroundColor = bgColor;
                    tr.innerHTML = `
                        <td><span class="category-badge" style="background:${badgeColor}">${item.category}</span></td>
                        <td style="font-weight:bold;">${item.name}</td>
                        <td>${item.size || '-'}</td>
                        <td>${item.length || '-'}</td>
                        <td>
                            <div class="qty-wrapper">
                                <button class="qty-btn btn-dec" onclick="updateStock('${item._id}', ${item.quantity - 1})">-</button>
                                <span class="qty-text">${item.quantity}</span>
                                <button class="qty-btn btn-inc" onclick="updateStock('${item._id}', ${item.quantity + 1})">+</button>
                            </div>
                        </td>
                        <td><button onclick="deleteItem('${item._id}')" class="btn-del-card">ì‚­ì œ</button></td>
                    `;

                    // 2. ëª¨ë°”ì¼ ì¹´ë“œ ìƒì„±
                    const card = document.createElement('div');
                    card.className = 'mobile-card';
                    card.style.backgroundColor = bgColor;
                    card.style.borderLeft = `6px solid ${badgeColor}`;
                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <b style="font-size:1.1rem;">${item.name}</b>
                            <span class="category-badge" style="background:${badgeColor}">${item.category}</span>
                        </div>
                        <div style="font-size:14px; color:#333; margin-bottom:10px;">ê·œê²©: ${item.size} / ${item.length}</div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="qty-wrapper">
                                <button class="qty-btn btn-dec" onclick="updateStock('${item._id}', ${item.quantity - 1})">-</button>
                                <b class="qty-text">${item.quantity}</b>
                                <button class="qty-btn btn-inc" onclick="updateStock('${item._id}', ${item.quantity + 1})">+</button>
                            </div>
                            <button onclick="deleteItem('${item._id}')" class="btn-del-card">ì‚­ì œ</button>
                        </div>
                    `;

                    if (isRaw) {
                        rawPC.appendChild(tr);
                        rawMobile.appendChild(card);
                    } else {
                        finishedPC.appendChild(tr);
                        finishedMobile.appendChild(card);
                    }
                });
            } catch (err) { alert("ì¬ê³  ë¡œë“œ ì‹¤íŒ¨"); }
            finally { setTimeout(() => showLoading(false), 300); }
        }

        async function addItem() {
            const name = document.getElementById('new-name').value;
            const size = document.getElementById('new-size').value;
            const length = document.getElementById('new-length').value;
            const quantity = document.getElementById('new-qty').value;
            const category = document.getElementById('new-category').value;

            if(!name) return alert("í’ˆëª©ì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

            showLoading(true);
            try {
                await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, size, length, quantity, category, username: currentNick || currentUser })
                });
                await loadItems();
            } finally { showLoading(false); }
        }

        async function updateStock(id, newQty) {
            if(newQty < 0) return;
            await fetch(`${API_URL}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantity: newQty, username: currentNick || currentUser })
            });
            loadItems();
        }

        async function deleteItem(id) {
            if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            loadItems();
        }

        function showLoading(show) {
            document.getElementById('loading-layer').style.display = show ? 'flex' : 'none';
        }

        function logout() { 
            localStorage.removeItem('username'); 
            localStorage.removeItem('nickname'); 
            location.href = '/'; 
        }
    </script>
</body>
</html>

// --- END OF FILE: public\inventory.html ---


// ==========================================
// [14/20] FILE: public\js\script.js
// ==========================================

// ëª¨ë°”ì¼ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
const mobileBtn = document.getElementById("mobileAddBtn");

if (mobileBtn) {
  mobileBtn.addEventListener("click", function () {
    // 1. ì˜¤ëŠ˜ ë‚ ì§œ êµ¬í•˜ê¸° (YYYY-MM-DD)
    const today = new Date().toISOString().split("T")[0];

    // 2. ë‚ ì§œ ì…ë ¥ì¹¸(id="date")ì— ì˜¤ëŠ˜ ë‚ ì§œ ì±„ì›Œì£¼ê¸°
    // (ë³¸ì¸ HTMLì˜ ë‚ ì§œ ì…ë ¥ì¹¸ IDê°€ 'date'ì¸ì§€ í™•ì¸ í•„ìš”)
    const dateInput = document.querySelector('input[type="date"]');
    if (dateInput) {
      dateInput.value = today;
    }

    // 3. ëª¨ë‹¬ì°½ ë„ìš°ê¸° í•¨ìˆ˜ ì‹¤í–‰
    // â˜…ì¤‘ìš”â˜…: ë³¸ì¸ ì½”ë“œì—ì„œ ëª¨ë‹¬ì°½ ë„ìš°ëŠ” í•¨ìˆ˜ ì´ë¦„ì´ openModalì´ ì•„ë‹ˆë©´ ìˆ˜ì •í•˜ì„¸ìš”!
    if (typeof openModal === "function") {
      openModal();
    } else {
      console.error("ëª¨ë‹¬ ë„ìš°ëŠ” í•¨ìˆ˜ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”!");
      alert("ì¼ì • ì¶”ê°€ ì°½ì„ ë„ìš°ëŠ” í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
  });
}


// --- END OF FILE: public\js\script.js ---


// ==========================================
// [15/20] FILE: routes\auth.js
// ==========================================

const express = require("express");
const router = express.Router();
const User = require("../models/User");

// 1. íšŒì›ê°€ì… ì‹ ì²­
router.post("/register", async (req, res) => {
  console.log("1. ìš”ì²­ ë°›ìŒ! ë°ì´í„°:", req.body); // ì—¬ê¸°ëŠ” ëœ° ê²ƒì„

  try {
    const { username, password, nickname } = req.body;

    console.log("2. ì¤‘ë³µ ê²€ì‚¬ ì‹œì‘...");
    // ì—¬ê¸°ì„œ ë©ˆì¶œ í™•ë¥ ì´ ë†’ìŒ (DB ì¡°íšŒ)
    const existingUser = await User.findOne({ username });
    console.log("3. ì¤‘ë³µ ê²€ì‚¬ í†µê³¼ (ê²°ê³¼):", existingUser);

    if (existingUser) {
      console.log("âŒ ì¤‘ë³µëœ ìœ ì €ì„");
      return res.status(400).json({ message: "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤." });
    }

    console.log("4. ìœ ì € ê°ì²´ ìƒì„± ì¤‘...");
    const newUser = new User({ username, password, nickname });

    console.log("5. DB ì €ì¥ ì‹œë„...");
    // ë˜ëŠ” ì—¬ê¸°ì„œ ë©ˆì¶œ ìˆ˜ ìˆìŒ (DB ì“°ê¸°)
    await newUser.save();
    console.log("6. DB ì €ì¥ ì™„ë£Œ!");

    res.status(201).json({ message: "ê°€ì… ì‹ ì²­ ì™„ë£Œ!" });
  } catch (err) {
    console.error("ğŸ”¥ ì—ëŸ¬ ë°œìƒ:", err);
    res.status(500).json({ error: err.message });
  }
});

// 2. ë¡œê·¸ì¸
router.post("/login", async (req, res) => {
  try {
    const { username, password } = req.body;
    const user = await User.findOne({ username });

    // 1. ê³„ì • í™•ì¸
    if (!user || user.password !== password) {
      return res
        .status(400)
        .json({ message: "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤." });
    }

    // 2. ìŠ¹ì¸ ì—¬ë¶€ í™•ì¸
    if (user.isApproved === false) {
      return res
        .status(403)
        .json({ message: "ì•„ì§ ìŠ¹ì¸ë˜ì§€ ì•Šì€ ê³„ì •ì…ë‹ˆë‹¤." });
    }

    // â˜… 3. [ë³µêµ¬ ë° ìˆ˜ì •] ì„¸ì…˜ ì €ì¥ (Redisì— ì €ì¥ë©ë‹ˆë‹¤)
    req.session.user = {
      id: user._id,
      username: user.username,
      nickname: user.nickname,
      role: user.role, // "admin" í˜¹ì€ "user"
    };

    // â˜… ì„¸ì…˜ì„ ëª…ì‹œì ìœ¼ë¡œ ì €ì¥ í›„ ì‘ë‹µì„ ë³´ëƒ…ë‹ˆë‹¤.
    req.session.save((err) => {
      if (err) {
        console.error("ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨:", err);
        return res.status(500).json({ message: "ì„¸ì…˜ ì €ì¥ ì˜¤ë¥˜" });
      }

      console.log(`âœ… ${user.username} ë¡œê·¸ì¸ ë° ì„¸ì…˜ ì €ì¥ ì™„ë£Œ`);

      // 4. ì‘ë‹µ ë³´ë‚´ê¸°
      res.status(200).json({
        message: "ë¡œê·¸ì¸ ì„±ê³µ",
        user: req.session.user,
      });
    });
  } catch (err) {
    console.error("ë¡œê·¸ì¸ ì—ëŸ¬:", err);
    res.status(500).json({ error: err.message });
  }
});

// 3. (ê´€ë¦¬ììš©) ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ
router.get("/admin/pending", async (req, res) => {
  try {
    const users = await User.find({ isApproved: false });
    res.json(users);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 4. (ê´€ë¦¬ììš©) ìŠ¹ì¸ ì²˜ë¦¬
router.post("/admin/approve", async (req, res) => {
  try {
    const { username } = req.body;
    await User.findOneAndUpdate({ username }, { isApproved: true });
    res.json({ message: `${username} ìŠ¹ì¸ ì™„ë£Œ` });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 5. (ê´€ë¦¬ììš©) ê°€ì… ê±°ì ˆ (ìœ ì € ì‚­ì œ)
router.post("/admin/reject", async (req, res) => {
  try {
    const { username } = req.body;
    // ìœ ì € ì°¾ì•„ì„œ ì‚­ì œ
    await User.findOneAndDelete({ username });
    res.json({ message: `${username} ë‹˜ì˜ ê°€ì…ì„ ê±°ì ˆ(ì‚­ì œ)í–ˆìŠµë‹ˆë‹¤.` });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

module.exports = router;


// --- END OF FILE: routes\auth.js ---


// ==========================================
// [16/20] FILE: routes\caleandar.js
// ==========================================

const express = require("express");
const router = express.Router();
const Event = require("../models/Event");
const Item = require("../models/Item");
const redisClient = require("../config/redis");

// 1. ì¼ì • ì¡°íšŒ (ë‹¬ë ¥ ë¡œë”©ìš©)
router.get("/", async (req, res) => {
  try {
    const events = await Event.find();
    res.json(events);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 2. ì¼ì • ì¶”ê°€ (ì¬ê³  ì—°ë™ ë° ì†Œìˆ˜ì  ì²˜ë¦¬ í¬í•¨)
router.post("/", async (req, res) => {
  const { type, products, materials, start, username } = req.body;

  try {
    if (!products || products.length === 0 || !products[0].name) {
      return res
        .status(400)
        .json({ message: "ìœ íš¨í•œ í’ˆëª© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤." });
    }

    const mainItem = products[0].name;
    const extraCount =
      products.length > 1 ? ` ì™¸ ${products.length - 1}ê±´` : "";
    const generatedTitle = `[${type}] ${mainItem}${extraCount}`;

    const combinedItems = [];
    // ì œí’ˆ ì²˜ë¦¬
    products.forEach((p) => {
      combinedItems.push({
        name: p.name.trim(),
        size: p.size ? p.size.toString().trim() : "-",
        length: p.length ? p.length.toString().trim() : "-",
        quantity: parseFloat(Number(p.quantity).toFixed(1)), // ì†Œìˆ˜ì  í•œìë¦¬ ê³ ì •
        role: "product",
      });
    });

    // ì›ìì¬ ì²˜ë¦¬
    if (type === "ìƒì‚°" && materials) {
      materials.forEach((m) => {
        combinedItems.push({
          name: m.name.trim(),
          size: m.size ? m.size.toString().trim() : "-",
          length: m.length ? m.length.toString().trim() : "-",
          quantity: parseFloat(Number(m.quantity).toFixed(1)),
          role: "material",
        });
      });
    }

    const newEvent = new Event({
      title: generatedTitle,
      start,
      type,
      items: combinedItems,
      createdBy: username,
    });
    await newEvent.save();

    // ì¬ê³  ì—°ë™ ë¡œì§
    for (const item of combinedItems) {
      if (item.quantity === 0) continue;

      let amount = 0;
      if (item.role === "product") {
        amount =
          type === "ì…ê³ " || type === "ìƒì‚°" ? item.quantity : -item.quantity;
      } else {
        amount = -item.quantity;
      }

      // [ìˆ˜ì •] ë¶€ë™ ì†Œìˆ˜ì  ì˜¤ì°¨ ë°©ì§€ë¥¼ ìœ„í•´ ê¸°ì¡´ ìˆ˜ëŸ‰ì„ ê°€ì ¸ì™€ì„œ ê³„ì‚° í›„ ì €ì¥
      const targetItem = await Item.findOne({
        name: item.name,
        size: item.size,
        length: item.length,
      });
      if (targetItem) {
        targetItem.quantity = parseFloat(
          (targetItem.quantity + amount).toFixed(1)
        );
        targetItem.lastUpdatedBy = username;
        targetItem.updatedAt = Date.now();
        await targetItem.save();
      } else {
        await Item.create({
          name: item.name,
          size: item.size,
          length: item.length,
          quantity: parseFloat(item.quantity.toFixed(1)),
          lastUpdatedBy: username,
          updatedAt: Date.now(),
        });
      }
    }

    await redisClient.del("cache:inventory");
    res.status(201).json(newEvent);
  } catch (err) {
    console.error("ì €ì¥ ì—ëŸ¬:", err);
    res.status(500).json({ message: "ì„œë²„ ì €ì¥ ì˜¤ë¥˜: " + err.message });
  }
});

// 3. ì¼ì • ìˆ˜ì • (PUT) - ê¸°ì¡´ ì¬ê³  ë³µêµ¬ í›„ ìƒˆ ë°ì´í„° ë°˜ì˜
router.put("/:id", async (req, res) => {
  try {
    const oldEvent = await Event.findById(req.params.id);
    if (!oldEvent)
      return res.status(404).json({ message: "ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });

    // [A] ê¸°ì¡´ ì¬ê³  ì›ìƒë³µêµ¬ (ì—­ê³„ì‚°)
    for (const item of oldEvent.items) {
      let restoreAmount = 0;
      if (item.role === "product") {
        restoreAmount =
          oldEvent.type === "ì…ê³ " || oldEvent.type === "ìƒì‚°"
            ? -item.quantity
            : item.quantity;
      } else {
        restoreAmount = item.quantity; // ì†Œëª¨ëë˜ ì›ìì¬ ë‹¤ì‹œ ì±„ì›Œì¤Œ
      }

      const target = await Item.findOne({
        name: item.name,
        size: item.size,
        length: item.length,
      });
      if (target) {
        target.quantity = parseFloat(
          (target.quantity + restoreAmount).toFixed(1)
        );
        await target.save();
      }
    }

    // [B] ìƒˆë¡œìš´ ë°ì´í„° ì •ê·œí™”
    const { type, products, materials, start, username } = req.body;
    const combinedItems = [];
    products.forEach((p) =>
      combinedItems.push({
        ...p,
        role: "product",
        quantity: parseFloat(Number(p.quantity).toFixed(1)),
      })
    );
    if (type === "ìƒì‚°" && materials) {
      materials.forEach((m) =>
        combinedItems.push({
          ...m,
          role: "material",
          quantity: parseFloat(Number(m.quantity).toFixed(1)),
        })
      );
    }

    const generatedTitle = `[${type}] ${combinedItems[0].name}${
      combinedItems.length > 1 ? " ì™¸ " + (combinedItems.length - 1) + "ê±´" : ""
    }`;

    // [C] ì¼ì • ë¬¸ì„œ ì—…ë°ì´íŠ¸
    const updatedEvent = await Event.findByIdAndUpdate(
      req.params.id,
      {
        title: generatedTitle,
        start,
        type,
        items: combinedItems,
        createdBy: username,
        updatedAt: Date.now(),
      },
      { new: true }
    );

    // [D] ìƒˆë¡œìš´ ì¬ê³  ìˆ˜ëŸ‰ ë°˜ì˜
    for (const item of combinedItems) {
      let amount =
        item.role === "product"
          ? type === "ì…ê³ " || type === "ìƒì‚°"
            ? item.quantity
            : -item.quantity
          : -item.quantity;

      const target = await Item.findOne({
        name: item.name,
        size: item.size,
        length: item.length,
      });
      if (target) {
        target.quantity = parseFloat((target.quantity + amount).toFixed(1));
        target.lastUpdatedBy = username;
        await target.save();
      } else {
        await Item.create({
          ...item,
          quantity: parseFloat(amount.toFixed(1)),
          lastUpdatedBy: username,
        });
      }
    }

    await redisClient.del("cache:inventory");
    res.json(updatedEvent);
  } catch (err) {
    console.error("ìˆ˜ì • ì—ëŸ¬:", err);
    res.status(500).json({ message: err.message });
  }
});

// 4. ì¼ì • ì‚­ì œ (ì¬ê³  ë³µêµ¬ í¬í•¨)
router.delete("/:id", async (req, res) => {
  try {
    const event = await Event.findById(req.params.id);
    if (!event)
      return res.status(404).json({ message: "ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });

    for (const item of event.items) {
      let restoreAmount =
        item.role === "product"
          ? event.type === "ì…ê³ " || event.type === "ìƒì‚°"
            ? -item.quantity
            : item.quantity
          : item.quantity;

      const target = await Item.findOne({
        name: item.name,
        size: item.size,
        length: item.length,
      });
      if (target) {
        target.quantity = parseFloat(
          (target.quantity + restoreAmount).toFixed(1)
        );
        await target.save();
      }
    }

    await Event.findByIdAndDelete(req.params.id);
    await redisClient.del("cache:inventory");

    res.json({ message: "ì‚­ì œ ë° ì¬ê³  ë³µêµ¬ ì™„ë£Œ" });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

module.exports = router;


// --- END OF FILE: routes\caleandar.js ---


// ==========================================
// [17/20] FILE: routes\holidays.js
// ==========================================

const express = require("express");
const router = express.Router();
const axios = require("axios");
const client = require("../config/redis");

router.get("/:year", async (req, res) => {
  const year = req.params.year;
  // ë°ì´í„° êµ¬ì¡°ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ í‚¤ ì´ë¦„ì„ v2ë¡œ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¶©ëŒì„ ë°©ì§€í•©ë‹ˆë‹¤.
  const redisKey = `holidays_v2:${year}`;

  const SERVICE_KEY = process.env.DATA_GO_KR_KEY;

  try {
    // 1. Redis ìºì‹œ í™•ì¸
    const cachedData = await client.get(redisKey);
    if (cachedData) {
      console.log(`ğŸš€ Redis ìºì‹œ ì‚¬ìš© (${year}ë…„)`);
      return res.json(JSON.parse(cachedData));
    }

    // 2. ê³µê³µë°ì´í„° API í˜¸ì¶œ
    const baseUrl =
      "http://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo";
    const fullUrl = `${baseUrl}?ServiceKey=${SERVICE_KEY}&solYear=${year}&_type=json&numOfRows=100`;

    console.log(`ğŸŒ ê³µê³µë°ì´í„° API í˜¸ì¶œ ì¤‘: ${year}ë…„`);
    const response = await axios.get(fullUrl);

    if (response.data.response?.header?.resultCode !== "00") {
      console.error(
        "âŒ API ì¸ì¦ ì‹¤íŒ¨:",
        response.data.response?.header?.resultMsg
      );
      return res.status(401).json({ error: "ì¸ì¦ ì‹¤íŒ¨" });
    }

    const items = response.data.response.body.items?.item;
    const holidayList = Array.isArray(items) ? items : items ? [items] : [];

    // ë‚ ì§œì™€ ì´ë¦„ì„ ëª¨ë‘ í¬í•¨í•œ ê°ì²´ ë°°ì—´ ìƒì„±
    const formattedHolidays = holidayList.map((item) => {
      const date = String(item.locdate);
      return {
        date: `${date.substring(0, 4)}-${date.substring(4, 6)}-${date.substring(
          6,
          8
        )}`,
        name: item.dateName, // ê³µíœ´ì¼ ëª…ì¹­ (ì˜ˆ: ì‹ ì •, ì„¤ë‚ )
      };
    }); // ì´ ë¶€ë¶„ ê´„í˜¸ê°€ ëˆ„ë½ë˜ì–´ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

    // 3. Redis ì €ì¥ (30ì¼ ìœ ì§€)
    if (formattedHolidays.length > 0) {
      await client.setEx(redisKey, 2592000, JSON.stringify(formattedHolidays));
    }

    res.json(formattedHolidays);
  } catch (error) {
    console.error(`${year}ë…„ ê³µíœ´ì¼ ì²˜ë¦¬ ì¤‘ ì—ëŸ¬:`, error.message);
    res.status(500).json([]);
  }
});

module.exports = router;


// --- END OF FILE: routes\holidays.js ---


// ==========================================
// [18/20] FILE: routes\inventory.js
// ==========================================

const express = require("express");
const router = express.Router();
const Item = require("../models/Item");
const redisClient = require("../config/redis"); // Redis ë¶ˆëŸ¬ì˜¤ê¸°

const CACHE_KEY = "cache:inventory";

// 1. ì¬ê³  ëª©ë¡ ì¡°íšŒ (Redis ìš°ì„ )
router.get("/", async (req, res) => {
  try {
    // 1) Redis í™•ì¸
    let cachedData = await redisClient.get("cache:inventory");

    if (cachedData) {
      // ìºì‹œ ë°ì´í„°ê°€ ìœ íš¨í•œ JSONì¸ì§€ í™•ì¸ í›„ ë°˜í™˜
      try {
        const parsed = JSON.parse(cachedData);
        console.log("âš¡ Redis ìºì‹œ ì¡°íšŒ ì„±ê³µ");
        return res.json(parsed);
      } catch (parseErr) {
        console.error("âŒ ìºì‹œ ë°ì´í„° íŒŒì‹± ì—ëŸ¬, DBë¡œ ì „í™˜");
      }
    }

    // 2) ìºì‹œê°€ ì—†ê±°ë‚˜ ì˜¤ë¥˜ ì‹œ DB ì¡°íšŒ
    console.log("ğŸ¢ DB ì§ì ‘ ì¡°íšŒ ì¤‘...");
    const items = await Item.find().sort({ updatedAt: -1 });

    // 3) ì¡°íšŒí•œ ë°ì´í„°ë¥¼ ë‹¤ì‹œ ìºì‹± (ë³µêµ¬ ì‘ì—…)
    await redisClient.set("cache:inventory", JSON.stringify(items));

    res.json(items);
  } catch (err) {
    console.error("ì¬ê³  ì¡°íšŒ ì—ëŸ¬:", err);
    res.status(500).json({ error: err.message });
  }
});

// 2. ì¬ê³  ì¶”ê°€ (ì“°ê¸° ë°œìƒ -> ìºì‹œ ì‚­ì œ)
router.post("/", async (req, res) => {
  try {
    const { name, size, length, quantity, category, username } = req.body;

    // ì •ê·œí™”: ë‹¬ë ¥ ë¡œì§ê³¼ ë™ì¼í•˜ê²Œ ê³µë°± ì œê±° ë° ê¸°ë³¸ê°’ ì„¤ì •
    const newItem = new Item({
      name: name.trim(),
      size: size ? size.toString().trim() : "-",
      length: length ? length.toString().trim() : "-",
      quantity,
      category,
      lastUpdatedBy: username,
    });

    await newItem.save();
    await redisClient.del(CACHE_KEY);
    res.status(201).json({ message: "ë“±ë¡ë¨", item: newItem });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 3. ìˆ˜ì • (ì“°ê¸° ë°œìƒ -> ìºì‹œ ì‚­ì œ)
router.put("/:id", async (req, res) => {
  try {
    const { quantity, username } = req.body;
    const updatedItem = await Item.findByIdAndUpdate(
      req.params.id,
      { quantity, lastUpdatedBy: username, updatedAt: Date.now() },
      { new: true }
    );

    // â˜… ìºì‹œ ì‚­ì œ
    await redisClient.del(CACHE_KEY);

    res.json({ message: "ìˆ˜ì •ë¨", item: updatedItem });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 4. ì‚­ì œ (ì“°ê¸° ë°œìƒ -> ìºì‹œ ì‚­ì œ)
router.delete("/:id", async (req, res) => {
  try {
    await Item.findByIdAndDelete(req.params.id);

    // â˜… ìºì‹œ ì‚­ì œ
    await redisClient.del(CACHE_KEY);

    res.json({ message: "ì‚­ì œë¨" });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

module.exports = router;


// --- END OF FILE: routes\inventory.js ---


// ==========================================
// [19/20] FILE: routes\options.js
// ==========================================

const express = require("express");
const router = express.Router();
const Option = require("../models/Option");
const redisClient = require("../config/redis"); // â˜… Redis ì¶”ê°€

const OPTIONS_CACHE_KEY = "cache:options"; // ì˜µì…˜ ì „ìš© ìºì‹œ í‚¤

// 1. ëª¨ë“  ì˜µì…˜ ì¡°íšŒ (ì¼ë°˜ ìœ ì €/ê´€ë¦¬ì ê³µìš©)
router.get("/", async (req, res) => {
  try {
    // Redis í™•ì¸
    let cachedOptions = await redisClient.get(OPTIONS_CACHE_KEY);

    if (cachedOptions) {
      console.log("âš¡ Redisì—ì„œ ì˜µì…˜ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜");
      return res.json(JSON.parse(cachedOptions));
    }

    // ìºì‹œì— ì—†ìœ¼ë©´ DBì—ì„œ ê°€ì ¸ì˜¤ê¸°
    console.log("ğŸ¢ ìºì‹œ ì—†ìŒ: DBì—ì„œ ì˜µì…˜ ì§ì ‘ ì¡°íšŒ");
    const options = await Option.find();

    // ë‹¤ìŒì„ ìœ„í•´ ìºì‹œì— ì €ì¥
    await redisClient.set(OPTIONS_CACHE_KEY, JSON.stringify(options));

    res.json(options);
  } catch (err) {
    console.error("ì˜µì…˜ ì¡°íšŒ ì—ëŸ¬:", err);
    res.status(500).json({ error: err.message });
  }
});

// 2. ì˜µì…˜ ì¶”ê°€ (ê´€ë¦¬ììš© - ì„¸ì…˜ ì²´í¬ëŠ” server.jsì—ì„œ ìˆ˜í–‰)
router.post("/", async (req, res) => {
  try {
    const { type, value } = req.body;
    const exists = await Option.findOne({ type, value });
    if (exists) return res.status(400).json({ message: "ì´ë¯¸ ì¡´ì¬í•¨" });

    const newOption = new Option({ type, value });
    await newOption.save();

    // â˜… ê´€ë¦¬ìê°€ ì¶”ê°€í•˜ë©´ ì¦‰ì‹œ ìºì‹œ ì‚­ì œ (ë‹¤ìŒ ì¡°íšŒ ë•Œ ê°±ì‹ ë˜ë„ë¡)
    await redisClient.del(OPTIONS_CACHE_KEY);
    console.log("â™»ï¸ ì˜µì…˜ ì—…ë°ì´íŠ¸: ìºì‹œ ì‚­ì œë¨");

    res.status(201).json(newOption);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 3. ì˜µì…˜ ì‚­ì œ (ê´€ë¦¬ììš©)
router.delete("/:id", async (req, res) => {
  try {
    await Option.findByIdAndDelete(req.params.id);

    // â˜… ì¤‘ìš”: ì˜µì…˜ì´ ì‚­ì œë˜ì—ˆìœ¼ë¯€ë¡œ ê¸°ì¡´ ìºì‹œ ì‚­ì œ
    await redisClient.del(OPTIONS_CACHE_KEY);
    console.log("â™»ï¸ ì˜µì…˜ ì‚­ì œë¡œ ì¸í•œ ìºì‹œ ì´ˆê¸°í™”");

    res.json({ message: "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤." });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

module.exports = router;


// --- END OF FILE: routes\options.js ---


// ==========================================
// [20/20] FILE: server.js
// ==========================================

const express = require("express");
const http = require("http");
const dotenv = require("dotenv");
const mongoose = require("mongoose");
const cors = require("cors");
const authRoutes = require("./routes/auth");
const inventoryRoutes = require("./routes/inventory");
const calendarRoutes = require("./routes/caleandar");
const optionRoutes = require("./routes/options");

const session = require("express-session");
const { RedisStore } = require("connect-redis");
const redisClient = require("./config/redis");

const holidayRoutes = require(`./routes/holidays`);

dotenv.config();

// 1. ì•± ì´ˆê¸°í™”
const app = express();
const server = http.createServer(app);

app.set("trust proxy", 1);

// 2. ë¯¸ë“¤ì›¨ì–´ ì„¤ì •
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static("public"));

// 3. ëª½ê³ DB ì—°ê²°
mongoose
  .connect(process.env.MONGO_URI)
  .then(() => console.log("âœ… MongoDB ì—°ê²° ì„±ê³µ!"))
  .catch((err) => console.error("âŒ MongoDB ì—°ê²° ì‹¤íŒ¨:", err));

// 4. ì„¸ì…˜ ì„¤ì • (ë¼ìš°í„° ì—°ê²°ë³´ë‹¤ ë¨¼ì € ì™€ì•¼ í•¨)
app.use(
  session({
    store: new RedisStore({
      client: redisClient,
      prefix: "session:",
    }),
    secret: "my-super-secret-key-reset",
    resave: false,
    saveUninitialized: false,
    cookie: {
      secure: false,
      httpOnly: true,
      maxAge: 1000 * 60 * 60 * 24,
      sameSite: "lax",
    },
  })
);

// --- ê¶Œí•œ ì²´í¬ ë¯¸ë“¤ì›¨ì–´ ë¶„ë¦¬ ---

// [A] ë¡œê·¸ì¸ ì—¬ë¶€ë§Œ ì²´í¬ (ì¼ë°˜ ìœ ì €/ê´€ë¦¬ì ëª¨ë‘ í†µê³¼)
const checkLogin = (req, res, next) => {
  if (!req.session || !req.session.user) {
    console.log(">> íƒˆë½: ë¡œê·¸ì¸ ì•ˆë¨");
    return res.send(
      '<script>alert("ë¡œê·¸ì¸í•˜ì„¸ìš”"); location.href="/login";</script>'
    );
  }
  next();
};

// [B] ê´€ë¦¬ì ê¶Œí•œê¹Œì§€ ì²´í¬ (ê´€ë¦¬ìë§Œ í†µê³¼)
const checkAdmin = (req, res, next) => {
  // ë¨¼ì € ë¡œê·¸ì¸ì´ ë˜ì–´ìˆëŠ”ì§€ í™•ì¸
  if (!req.session || !req.session.user) {
    return res.send(
      '<script>alert("ë¡œê·¸ì¸í•˜ì„¸ìš”"); location.href="/login";</script>'
    );
  }
  // ê´€ë¦¬ìì¸ì§€ í™•ì¸
  if (req.session.user.role !== "admin") {
    console.log(`>> íƒˆë½: ê´€ë¦¬ì ì•„ë‹˜ (í˜„ì¬ ì—­í• : ${req.session.user.role})`);
    return res
      .status(403)
      .send(
        '<script>alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤."); location.href="/";</script>'
      );
  }
  next();
};

app.get("/ping", (req, res) => {
  res.status(200).send("pong");
});

// 5. ë¼ìš°í„° ì—°ê²° (ê¶Œí•œ ë¯¸ë“¤ì›¨ì–´ ì ìš©)
app.use("/api", authRoutes); // ë¡œê·¸ì¸/íšŒì›ê°€ì…ì€ ì²´í¬ ì•ˆí•¨
app.use("/api/inventory", checkLogin, inventoryRoutes); // ì¬ê³ ëŠ” ë¡œê·¸ì¸í•´ì•¼ í•¨
app.use("/api/calendar", checkLogin, calendarRoutes); // ë‹¬ë ¥ì€ ë¡œê·¸ì¸ë§Œ í•˜ë©´ ë¨
app.use(
  "/api/options",
  (req, res, next) => {
    // GET(ì¡°íšŒ)ì€ ëˆ„êµ¬ë‚˜ ê°€ëŠ¥, POST/DELETE(ìˆ˜ì •)ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•˜ê²Œ ë¶„ë¦¬
    if (req.method === "GET") {
      return next(); // ì¡°íšŒëŠ” checkAdmin ê±´ë„ˆëœ€
    }
    checkAdmin(req, res, next); // ê·¸ ì™¸ì—” ê´€ë¦¬ì ì²´í¬
  },
  optionRoutes
); // ì˜µì…˜ì€ ê´€ë¦¬ìë§Œ!

app.use(`/api/holidays`, holidayRoutes);

const Item = require("./models/Item");

// 6. ì„œë²„ ì‹œì‘
const PORT = process.env.PORT || 3000;

server.listen(PORT, async () => {
  console.log(`ğŸš€ ì„œë²„ ì‹¤í–‰ ì¤‘: http://localhost:${PORT}`);
  try {
    if (!redisClient.isOpen) await redisClient.connect();

    // 1. [ì„ì‹œ ì¶”ê°€] ê¸°ì¡´ DBì˜ ì§€ì €ë¶„í•œ ì†Œìˆ˜ì  ë°ì´í„° ì¼ê´„ ì •ì œ
    const Item = require("./models/Item");
    const allItems = await Item.find({});

    console.log("ğŸ” ì†Œìˆ˜ì  ë°ì´í„° ì •ì œ ì‹œì‘...");
    for (const item of allItems) {
      // ì†Œìˆ˜ì  í•œ ìë¦¬ë¡œ ë°˜ì˜¬ë¦¼ (7.7999 -> 7.8)
      const cleanedQty = parseFloat(item.quantity.toFixed(1));

      // ê¸°ì¡´ ìˆ˜ëŸ‰ê³¼ ì •ì œëœ ìˆ˜ëŸ‰ì´ ë‹¤ë¥¼ ë•Œë§Œ ì—…ë°ì´íŠ¸
      if (item.quantity !== cleanedQty) {
        await Item.updateOne(
          { _id: item._id },
          { $set: { quantity: cleanedQty } }
        );
        console.log(
          `âœ… ì •ì œë¨: ${item.name} (${item.quantity} -> ${cleanedQty})`
        );
      }
    }
    console.log("âœ¨ ëª¨ë“  ì¬ê³  ë°ì´í„° ì •ì œ ì™„ë£Œ");

    // 2. ìºì‹œ ì´ˆê¸°í™” ë° ì˜ˆì—´
    await redisClient.del("cache:inventory");
    await redisClient.del("cache:options");

    const items = await Item.find().sort({ updatedAt: -1 });
    await redisClient.set("cache:inventory", JSON.stringify(items));

    const Option = require("./models/Option");
    const options = await Option.find();
    await redisClient.set("cache:options", JSON.stringify(options));

    console.log(
      `ğŸ”¥ ë°ì´í„° ì˜ˆì—´ ì™„ë£Œ: ì¬ê³  ${items.length}ê°œ, ì˜µì…˜ ${options.length}ê°œ`
    );
  } catch (e) {
    console.error("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:", e);
  }
});


// --- END OF FILE: server.js ---
