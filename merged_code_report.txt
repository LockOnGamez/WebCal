=== Project Merge Report: 2025. 12. 29. ì˜¤í›„ 11:15:23 ===
=== Total Files Found: 24 ===



// ==========================================
// [1/24] FILE: .env
// ==========================================

# .env íŒŒì¼ ë‚´ìš©

# ì„œë²„ í¬íŠ¸ (ê¸°ë³¸ 3000)
PORT=3000

# 1. MongoDB ì—°ê²° ì£¼ì†Œ (ë”°ì˜´í‘œ ì—†ì´ ì…ë ¥)
# ì˜ˆì‹œ: mongodb+srv://<ì•„ì´ë””>:<ë¹„ë°€ë²ˆí˜¸>@cluster0.abcde.mongodb.net/inventoryDB
MONGO_URI=mongodb+srv://admin:Angelious1@cluster0.38gttwb.mongodb.net/?appName=Cluster0

# 2. Redis ì—°ê²° ì£¼ì†Œ
# ì˜ˆì‹œ: redis://default:<ë¹„ë°€ë²ˆí˜¸>@redis-12345.c1.asia-northeast1-1.gce.cloud.redislabs.com:12345
REDIS_HOST=redis-15868.c270.us-east-1-3.ec2.cloud.redislabs.com
REDIS_PORT=15868
REDIS_PASSWORD=UMXqfzWuxz0LTtg8pczf4994WFm2okGt

# 3. ì„¸ì…˜ ì•”í˜¸í™” í‚¤ (ì•„ë¬´ ê¸€ìë‚˜ ê¸¸ê²Œ ì…ë ¥í•˜ë©´ ë©ë‹ˆë‹¤)
SESSION_SECRET=Angelious1
DATA_GO_KR_KEY=7846696c8c000983af2191f052860ee31fd633d8196abd6b5fc51ed08caf96d0


// --- END OF FILE: .env ---


// ==========================================
// [2/24] FILE: config\redis.js
// ==========================================

const { createClient } = require("redis");
const dotenv = require("dotenv");

dotenv.config();

// .envì— ìˆëŠ” ì •ë³´ë“¤ì„ ì¡°í•©í•´ì„œ ì ‘ì† ì£¼ì†Œ(URL)ë¥¼ ë§Œë“­ë‹ˆë‹¤.
// í˜•ì‹: redis://default:ë¹„ë°€ë²ˆí˜¸@ì£¼ì†Œ:í¬íŠ¸
const redisUrl = `redis://default:${process.env.REDIS_PASSWORD}@${process.env.REDIS_HOST}:${process.env.REDIS_PORT}`;

// Redis í´ë¼ì´ì–¸íŠ¸ ìƒì„±
const client = createClient({
  url: redisUrl,
});

client.on("error", (err) => console.error("âŒ Redis Client Error", err));
client.on("connect", () => console.log("âœ… Redis ì—°ê²° ì„±ê³µ!"));

// ì—°ê²° ì‹œì‘ í•¨ìˆ˜
const connectRedis = async () => {
  if (!client.isOpen) {
    await client.connect();
  }
};

// ì—°ê²° ì‹¤í–‰
connectRedis();

module.exports = client;


// --- END OF FILE: config\redis.js ---


// ==========================================
// [3/24] FILE: merge.js
// ==========================================

const fs = require("fs");
const path = require("path");

// --- ì„¤ì • ---
const TARGET_DIR = "./"; // í˜„ì¬ í´ë” ì „ì²´ë¥¼ ëŒ€ìƒìœ¼ë¡œ í•¨
const OUTPUT_FILE = "merged_code_report.txt";
const EXTENSIONS = [".js", ".json", ".html", ".css", ".env"]; // í¬í•¨í•  í™•ì¥ì (.cs ì œê±°, .env/.css ì¶”ê°€)

// ì œì™¸í•  í´ë” ë° íŒŒì¼ ëª©ë¡
const EXCLUDE_NAMES = [
  "node_modules",
  "Library",
  ".git",
  "package-lock.json", // ë³‘í•© ì‹œ ë„ˆë¬´ ê¸¸ì–´ì§€ë¯€ë¡œ ì œì™¸ ê¶Œì¥
  OUTPUT_FILE, // ìê¸° ìì‹ (ê²°ê³¼ íŒŒì¼) ì œì™¸
];

function readFiles(dir, allFiles = []) {
  if (!fs.existsSync(dir)) return allFiles;

  const files = fs.readdirSync(dir);
  files.forEach((file) => {
    const filePath = path.join(dir, file);
    const stats = fs.statSync(filePath);

    // 1. ì œì™¸ ëª©ë¡ì— í¬í•¨ëœ ì´ë¦„ì´ë©´ ê±´ë„ˆëœ€
    if (EXCLUDE_NAMES.includes(file)) return;

    if (stats.isDirectory()) {
      // 2. ì¬ê·€ì ìœ¼ë¡œ í•˜ìœ„ í´ë” íƒìƒ‰
      readFiles(filePath, allFiles);
    } else {
      // 3. í™•ì¥ì ì²´í¬ í›„ ë¦¬ìŠ¤íŠ¸ì— ì¶”ê°€
      if (EXTENSIONS.includes(path.extname(file)) || file === ".env") {
        allFiles.push(filePath);
      }
    }
  });
  return allFiles;
}

function mergeFiles() {
  try {
    console.log("ğŸ” íŒŒì¼ì„ ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...");
    const files = readFiles(TARGET_DIR);

    let combinedContent = `=== Project Merge Report: ${new Date().toLocaleString()} ===\n`;
    combinedContent += `=== Total Files Found: ${files.length} ===\n\n`;

    files.forEach((file, index) => {
      const content = fs.readFileSync(file, "utf8");
      combinedContent += `\n\n// ==========================================\n`;
      combinedContent += `// [${index + 1}/${files.length}] FILE: ${file}\n`;
      combinedContent += `// ==========================================\n\n`;
      combinedContent += content;
      combinedContent += `\n\n// --- END OF FILE: ${file} ---\n`;
      console.log(`âœ… ë³‘í•© ì¤‘: ${file}`);
    });

    fs.writeFileSync(OUTPUT_FILE, combinedContent);
    console.log(
      `\nâœ¨ ì„±ê³µ! ì´ ${files.length}ê°œì˜ íŒŒì¼ì´ ${OUTPUT_FILE}ì— ë³‘í•©ë˜ì—ˆìŠµë‹ˆë‹¤.`
    );
  } catch (err) {
    console.error("âŒ ì˜¤ë¥˜ ë°œìƒ:", err);
  }
}

mergeFiles();


// --- END OF FILE: merge.js ---


// ==========================================
// [4/24] FILE: models\Attendance.js
// ==========================================

const mongoose = require("mongoose");

const attendanceSchema = new mongoose.Schema({
  userId: { type: mongoose.Schema.Types.ObjectId, ref: "User", required: true },
  username: { type: String, required: true },
  nickname: { type: String },
  date: { type: String, required: true }, // ê´€ë¦¬ í¸ì˜ë¥¼ ìœ„í•œ YYYY-MM-DD (ë¬¸ìì—´)
  clockIn: { type: Date, required: true },
  clockOut: { type: Date },
  duration: { type: Number, default: 0 }, // ê·¼ë¬´ ì‹œê°„ (ì´ˆ ë‹¨ìœ„)
  createdAt: { type: Date, default: Date.now },
});

module.exports = mongoose.model("Attendance", attendanceSchema);


// --- END OF FILE: models\Attendance.js ---


// ==========================================
// [5/24] FILE: models\Event.js
// ==========================================

const mongoose = require("mongoose");

// í•˜ìœ„ ë¬¸ì„œ(ë°°ì—´ ë‚´ë¶€ ì•„ì´í…œ) ìŠ¤í‚¤ë§ˆ
const subItemSchema = new mongoose.Schema({
  name: String,
  size: String,
  length: String,
  quantity: Number,
  role: String, // 'product'(ì‚°ì¶œë¬¼/ì…ì¶œê³ ëŒ€ìƒ) ë˜ëŠ” 'material'(ì†Œëª¨ëœ ì›ìì¬)
});

const eventSchema = new mongoose.Schema({
  title: { type: String },
  start: { type: Date, required: true },
  allDay: { type: Boolean, default: true },
  type: { type: String, enum: ["ì…ê³ ", "ì¶œê³ ", "ìƒì‚°"], required: true },

  // [ë³€ê²½] ê¸°ì¡´ ë‹¨ì¼ í•„ë“œë“¤ ëŒ€ì‹  ë°°ì—´ ì‚¬ìš©
  items: [subItemSchema],

  createdBy: { type: String },
  createdAt: { type: Date, default: Date.now },
});

module.exports = mongoose.model("Event", eventSchema);


// --- END OF FILE: models\Event.js ---


// ==========================================
// [6/24] FILE: models\Item.js
// ==========================================

const mongoose = require("mongoose");

const itemSchema = new mongoose.Schema({
  name: { type: String, required: true },
  size: { type: String }, // [ì¶”ê°€] ì˜ˆ: XL, 100mm
  length: { type: String }, // [ì¶”ê°€] ì˜ˆ: 10m
  quantity: { type: Number, default: 0 },
  category: { type: String, default: "ê¸°íƒ€" },
  lastUpdatedBy: { type: String },
  createdAt: { type: Date, default: Date.now },
  updatedAt: { type: Date, default: Date.now },
});

module.exports = mongoose.model("Item", itemSchema);


// --- END OF FILE: models\Item.js ---


// ==========================================
// [7/24] FILE: models\Option.js
// ==========================================

const mongoose = require("mongoose");

const optionSchema = new mongoose.Schema({
  type: { type: String, required: true }, // 'itemName', 'size', 'length' ì¤‘ í•˜ë‚˜
  value: { type: String, required: true }, // ì‹¤ì œ ê°’ (ì˜ˆ: 'íŒŒì´í”„', '100mm')
});

module.exports = mongoose.model("Option", optionSchema);


// --- END OF FILE: models\Option.js ---


// ==========================================
// [8/24] FILE: models\User.js
// ==========================================

const mongoose = require("mongoose");

const userSchema = new mongoose.Schema({
  username: { type: String, required: true, unique: true },
  password: { type: String, required: true },
  nickname: { type: String },

  // ê´€ë¦¬ì/ìœ ì € êµ¬ë¶„ (ê¸°ë³¸ê°’: user)
  role: { type: String, enum: ["user", "admin"], default: "user" },

  // ìŠ¹ì¸ ì—¬ë¶€ (ê¸°ë³¸ê°’: false -> ë¡œê·¸ì¸ ë¶ˆê°€)
  isApproved: { type: Boolean, default: false },

  createdAt: { type: Date, default: Date.now },
});

module.exports = mongoose.model("User", userSchema);


// --- END OF FILE: models\User.js ---


// ==========================================
// [9/24] FILE: package.json
// ==========================================

{
  "name": "webcal",
  "version": "1.0.0",
  "description": "",
  "main": "index.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "test": "echo \"Error: no test specified\" && exit 1"
  },
  "keywords": [],
  "author": "",
  "license": "ISC",
  "type": "commonjs",
  "dependencies": {
    "axios": "^1.13.2",
    "bcryptjs": "^3.0.3",
    "connect-redis": "^9.0.0",
    "cors": "^2.8.5",
    "dotenv": "^17.2.3",
    "express": "^5.2.1",
    "express-session": "^1.18.2",
    "mongoose": "^9.0.2",
    "redis": "^5.10.0",
    "socket.io": "^4.8.1"
  },
  "devDependencies": {
    "nodemon": "^3.1.11"
  }
}


// --- END OF FILE: package.json ---


// ==========================================
// [10/24] FILE: public\admin.html
// ==========================================

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        body { padding: 15px; font-family: sans-serif; max-width: 1000px; margin: 0 auto; background-color: #f9f9f9; }
        h1 { font-size: 1.6rem; color: #333; }
        .nav-links { margin-bottom: 20px; font-size: 14px; }
        .section { background: white; margin-bottom: 25px; border: 1px solid #ddd; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; border-bottom: 2px solid #333; padding-bottom: 10px; font-size: 1.2rem; }
        h3 { font-size: 1rem; margin-bottom: 10px; color: #555; }
        
        /* ê¸°ì´ˆ ë°ì´í„° ê´€ë¦¬ ê·¸ë¦¬ë“œ */
        .option-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .option-grid { grid-template-columns: repeat(3, 1fr); } }

        .input-group { display: flex; gap: 5px; margin-bottom: 15px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; }
        button { padding: 10px 15px; cursor: pointer; border-radius: 6px; border: none; background: #333; color: white; font-weight: bold; }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag { background: #eee; padding: 6px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .tag button { background: #ff4444; color: white; width: 18px; height: 18px; padding: 0; line-height: 18px; font-size: 10px; border-radius: 50%; }

        /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ */
        .table-wrapper { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; font-size: 14px; }
        th { background: #f2f2f2; }
        .btn-approve { background: #4CAF50; color: white; padding: 8px 12px; }
        .btn-ban { background: #F44336; color: white; padding: 8px 12px; }
    </style>
</head>
<body>
    <h1>ğŸ›¡ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <div class="nav-links">
        <a href="/inventory.html">ğŸ“¦ ì¬ê³ ê´€ë¦¬</a> | 
        <a href="/calendar.html">ğŸ“… ë‹¬ë ¥ë³´ê¸°</a>
    </div>

    <div class="section">
        <h2>âš™ï¸ ê¸°ì´ˆ ë°ì´í„° ê´€ë¦¬</h2>
        <div class="option-grid">
            <div>
                <h3>í’ˆëª©ëª… (Item Name)</h3>
                <div class="input-group">
                    <input type="text" id="new-item" placeholder="ì¶”ê°€">
                    <button onclick="addOption('itemName', 'new-item')">ì¶”ê°€</button>
                </div>
                <div id="list-itemName" class="tag-container"></div>
            </div>

            <div>
                <h3>ì‚¬ì´ì¦ˆ (Size)</h3>
                <div class="input-group">
                    <input type="text" id="new-size" placeholder="ì¶”ê°€">
                    <button onclick="addOption('size', 'new-size')">ì¶”ê°€</button>
                </div>
                <div id="list-size" class="tag-container"></div>
            </div>

            <div>
                <h3>ê¸¸ì´ (Length)</h3>
                <div class="input-group">
                    <input type="text" id="new-length" placeholder="ì¶”ê°€">
                    <button onclick="addOption('length', 'new-length')">ì¶”ê°€</button>
                </div>
                <div id="list-length" class="tag-container"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ‘¥ íšŒì› ê°€ì… ìŠ¹ì¸</h2>
        <button onclick="loadPendingUsers()" style="background:#2196F3; margin-bottom:15px;">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th>ì•„ì´ë””</th><th>ë‹‰ë„¤ì„</th><th>ì‹ ì²­ì¼</th><th>ê´€ë¦¬</th></tr>
                </thead>
                <tbody id="user-list"></tbody>
            </table>
        </div>
    </div>

    <div class="section">
    <h2>ğŸ‘¥ ì „ì²´ íšŒì› ê´€ë¦¬</h2>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr><th>ì•„ì´ë””</th><th>ë‹‰ë„¤ì„</th><th>ê¶Œí•œ</th><th>ê´€ë¦¬</th></tr>
            </thead>
            <tbody id="full-user-list"></tbody>
        </table>
    </div>
</div>

    <script>
        const API_OPT = '/api/options';
        const API_ADMIN = '/api/admin';

        window.onload = function() { loadOptions(); loadPendingUsers(); loadFullUsers();};

// ì „ì²´ íšŒì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadFullUsers() {
    try {
        const res = await fetch('/api/admin/users'); // server.js ì„¤ì •ì— ë”°ë¼ ì£¼ì†Œ í™•ì¸ í•„ìš”
        const users = await res.json();
        const list = document.getElementById('full-user-list');
        list.innerHTML = '';

        if (users.length === 0) {
            list.innerHTML = '<tr><td colspan="4">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        users.forEach(user => {
            list.innerHTML += `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.nickname}</td>
                    <td>${user.role === 'admin' ? '<b>ê´€ë¦¬ì</b>' : 'ì¼ë°˜'}</td>
                    <td>
                        <button onclick="resetPassword('${user._id}')" style="background:#f59e0b;">PWì´ˆê¸°í™”</button>
                        <button class="btn-ban" onclick="banUser('${user._id}')">ê°•í‡´</button>
                    </td>
                </tr>`;
        });
    } catch (err) {
        console.error("íšŒì› ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", err);
    }
}

// ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” í•¨ìˆ˜
async function resetPassword(id) {
    if (!confirm("ë¹„ë°€ë²ˆí˜¸ë¥¼ '1234'ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
        const response = await fetch('/api/admin/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: id })
        });

        const data = await response.json();
        if (response.ok) {
            alert(data.message);
        } else {
            alert("ì´ˆê¸°í™” ì‹¤íŒ¨: " + data.message);
        }
    } catch (err) {
        console.error("ì´ˆê¸°í™” ì—ëŸ¬:", err);
        alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
    }
}

        async function loadOptions() {
            const res = await fetch(API_OPT);
            const options = await res.json();
            document.getElementById('list-itemName').innerHTML = '';
            document.getElementById('list-size').innerHTML = '';
            document.getElementById('list-length').innerHTML = '';

            options.forEach(opt => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `${opt.value} <button onclick="deleteOption('${opt._id}')">x</button>`;
                document.getElementById(`list-${opt.type}`).appendChild(tag);
            });
        }

        async function addOption(type, inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            if(!value) return;
            const res = await fetch(API_OPT, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type, value })
            });
            if(res.ok) { input.value = ''; loadOptions(); }
        }

        async function deleteOption(id) {
            if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await fetch(`${API_OPT}/${id}`, { method: 'DELETE' });
            loadOptions();
        }

        async function loadPendingUsers() {
    const res = await fetch(`${API_ADMIN}/pending`);
    const users = await res.json();
    const list = document.getElementById('user-list');
    list.innerHTML = '';
    
    if (users.length === 0) {
        list.innerHTML = '<tr><td colspan="4">ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }

    users.forEach(user => {
        list.innerHTML += `
            <tr>
                <td>${user.username}</td>
                <td>${user.nickname}</td>
                <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                <td>
                    <button class="btn-approve" onclick="approveUser('${user._id}')">ìŠ¹ì¸</button>
                    <button class="btn-ban" onclick="banUser('${user._id}')">ê±°ì ˆ</button>
                </td>
            </tr>`;
    });
}
        
        // admin.html ë‚´ ìŠ¹ì¸ í•¨ìˆ˜ ì˜ˆì‹œ
async function approveUser(id) { // ì—¬ê¸°ì„œ idëŠ” ìœ ì €ì˜ _id ê°’ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
    if (!confirm("ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
        const response = await fetch('/api/admin/approve', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: id }) // ì„œë²„ê°€ ê¸°ë‹¤ë¦¬ëŠ” 'userId'ì™€ ë§¤ì¹­
        });

        if (!response.ok) {
            // ì„œë²„ì—ì„œ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ json íŒŒì‹±
            const errData = await response.json();
            throw new Error(errData.message || 'ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
        }

        const data = await response.json();
        alert(data.message);
        loadPendingUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        
    } catch (err) {
        console.error("ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬:", err);
        alert(err.message);
    }
}

        async function banUser(id) {
    if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const res = await fetch(`/api/admin/reject`, { // ì£¼ì†Œ í™•ì¸!
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: id }) // userIdë¡œ í†µì¼
        });
        
        if(res.ok) {
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPendingUsers();
        }
    } catch (err) {
        console.error(err);
    }
}
    </script>
</body>
</html>

// --- END OF FILE: public\admin.html ---


// ==========================================
// [11/24] FILE: public\calendar.html
// ==========================================

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“… í†µí•© ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        body { padding: 15px; font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; margin: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        #calendar { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .nav-btns { display: flex; gap: 8px; align-items: center; }
        .mode-toggles { background: #eee; padding: 5px; border-radius: 12px; display: flex; gap: 5px; }
        .mode-btn { border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; transition: 0.2s; }
        .active-work { background: #2196F3; color: white; }
        .active-att { background: #10b981; color: white; }
        
        .search-bar { background: white; padding: 15px; border-radius: 15px; margin-bottom: 15px; display: none; align-items: center; gap: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .search-bar input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 10px; font-size: 14px; }
        .summary-badge { background: #e0f2fe; color: #0369a1; padding: 12px 18px; border-radius: 12px; font-weight: bold; font-size: 0.95rem; margin-bottom: 15px; display: none; border-left: 5px solid #0369a1; }

        .fc-event-time, .fc-list-event-time { display: none !important; }
        .fc-day-sun .fc-daygrid-day-number, .fc-list-day-side-text.is-sun { color: #F44336 !important; }
        .fc-day-sat .fc-daygrid-day-number, .fc-list-day-side-text.is-sat { color: #2196F3 !important; }
        .holiday-name { font-size: 0.65rem; color: #F44336; margin-top: -2px; font-weight: 500; text-align: right; display: block; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 95%; max-width: 600px; padding: 30px; margin: 40px auto; border-radius: 24px; box-sizing: border-box; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select { width: 100%; height: 45px; padding: 0 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        .table-container { width: 100%; overflow-x: auto; margin-top: 10px; border-radius: 12px; border: 1px solid #eee; }
        .item-table { width: 100%; border-collapse: collapse; min-width: 450px; }
        .item-table th { background: #f8f9fa; padding: 12px; font-size: 14px; }
        .item-table td { padding: 10px; border-bottom: 1px solid #f1f1f1; text-align: center; }

        button { padding: 12px 20px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
        .btn-blue { background: #2196F3; color: white; }
        .btn-green { background: #4CAF50; color: white; }
        .btn-red { background: #F44336; color: white; }
        .btn-gray { background: #eee; color: #333; }
        
        #loading-layer { display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; backdrop-filter: blur(5px); }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #2196F3; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-layer"><div class="spinner"></div><p style="margin-top: 15px; font-weight: bold;">ë°ì´í„° ë™ê¸°í™” ì¤‘...</p></div>

    <div class="header">
        <h1 id="cal-title">ğŸ“… ì‘ì—… ë‹¬ë ¥</h1>
        <div class="nav-btns">
            <div class="mode-toggles">
                <button id="m-work" class="mode-btn active-work" onclick="setMode('work')">ğŸ“¦ ì‘ì—…</button>
                <button id="m-att" class="mode-btn" onclick="setMode('att')">ğŸ•’ ê·¼ë¬´</button>
            </div>
            <button onclick="location.href='/main.html'" style="padding:8px 15px; border-radius:10px; border:none; background:#333; color:white; font-weight:bold;">ğŸ  í™ˆ</button>
        </div>
    </div>

    <div class="search-bar" id="att-search-bar">
        <input type="text" id="search-nickname" placeholder="ì§ì› ê²€ìƒ‰ (ê³µë°± ì‹œ ì „ì²´)..." onkeyup="if(window.event.keyCode==13){searchAttendance()}">
        <button onclick="searchAttendance()" class="btn-blue" style="padding: 10px 20px;">ê²€ìƒ‰</button>
    </div>
    <div id="att-summary" class="summary-badge"></div>

    <div id="calendar"></div>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">ğŸ“ ì‘ì—… ìˆ˜ì •</h3>
            <input type="hidden" id="edit-event-id">
            <div class="form-group"><label>ë‚ ì§œ</label><input type="date" id="modal-date"></div>
            <div class="form-group">
                <label>ì‘ì—… êµ¬ë¶„</label>
                <select id="modal-type" onchange="toggleProductionMode()">
                    <option value="ì…ê³ ">ğŸŸ¢ ì…ê³ </option>
                    <option value="ì¶œê³ ">ğŸ”´ ì¶œê³ </option>
                    <option value="ìƒì‚°">ğŸ”µ ìƒì‚°</option>
                </select>
            </div>
            <div style="display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                <label style="font-weight:bold;">ğŸ“¦ í’ˆëª©</label>
                <button class="btn-green" onclick="addRow('product-tbody')" style="padding:6px 12px; font-size:12px;">+ ì¶”ê°€</button>
            </div>
            <div class="table-container"><table class="item-table"><thead><tr><th>í’ˆëª©</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th><th>ì‚­ì œ</th></tr></thead><tbody id="product-tbody"></tbody></table></div>
            <div id="material-section" style="display:none; margin-top:15px;">
                <div style="display:flex; justify-content:space-between; align-items:center;"><label style="font-weight:bold; color:#F44336;">ğŸ”¨ ì›ìì¬</label><button class="btn-red" onclick="addRow('material-tbody')" style="padding:6px 12px; font-size:12px;">+ ì¶”ê°€</button></div>
                <div class="table-container"><table class="item-table"><thead><tr><th>í’ˆëª©</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th><th>ì‚­ì œ</th></tr></thead><tbody id="material-tbody"></tbody></table></div>
            </div>
            <div style="margin-top: 25px; display: flex; flex-direction: column; gap: 10px;">
                <button class="btn-blue" onclick="saveEvent()">ğŸ’¾ ì €ì¥</button>
                <div style="display:flex; gap:10px;"><button class="btn-gray" onclick="closeModal()" style="flex:1;">ì·¨ì†Œ</button><button id="btn-delete" class="btn-red" onclick="deleteEvent()" style="flex:1;">ğŸ—‘ ì‚­ì œ</button></div>
            </div>
        </div>
    </div>

    <div id="attendanceModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ•’ ê·¼ë¬´ ê¸°ë¡ ìˆ˜ì •</h3>
            <input type="hidden" id="att-id">
            <div class="form-group"><label>ì´ë¦„(ë‹‰ë„¤ì„)</label><input type="text" id="att-name"></div>
            <div class="form-group"><label>ì¶œê·¼ ì‹œê°„</label><input type="datetime-local" id="att-in"></div>
            <div class="form-group"><label>í‡´ê·¼ ì‹œê°„</label><input type="datetime-local" id="att-out"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-blue" onclick="saveAttendanceEdit()" style="flex:2;">ğŸ’¾ ì €ì¥</button>
                <button class="btn-gray" onclick="closeAttModal()" style="flex:1;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/calendar';
        const API_OPT = '/api/options';
        let currentMode = 'work';
        let calendarInstance;
        let currentSearchName = '';
        let dropdownOptions = { items: [], sizes: [], lengths: [] };
        const holidayCache = JSON.parse(localStorage.getItem('holiday_cache')) || {};

        function toggleLoading(show) { document.getElementById('loading-layer').style.display = show ? 'flex' : 'none'; }

        document.addEventListener('DOMContentLoaded', async () => { 
            await loadDropdownOptions();
            initCalendar(); 
        });

        async function loadDropdownOptions() {
            try {
                const res = await fetch(API_OPT);
                const data = await res.json();
                dropdownOptions.items = data.filter(d => d.type === 'itemName' || d.type === 'item').map(d => d.value);
                dropdownOptions.sizes = data.filter(d => d.type === 'size').map(d => d.value);
                dropdownOptions.lengths = data.filter(d => d.type === 'length').map(d => d.value);
            } catch (err) { console.error(err); }
        }

        function setMode(mode) {
            if (currentMode === mode) return;
            toggleLoading(true);
            currentMode = mode;
            document.getElementById('cal-title').innerText = mode === 'work' ? 'ğŸ“… ì‘ì—… ë‹¬ë ¥' : 'ğŸ•’ ê·¼ë¬´ ì¼ì§€';
            document.getElementById('m-work').className = `mode-btn ${mode==='work'?'active-work':''}`;
            document.getElementById('m-att').className = `mode-btn ${mode==='att'?'active-att':''}`;
            document.getElementById('att-search-bar').style.display = mode === 'att' ? 'flex' : 'none';
            if (mode === 'work') {
                document.getElementById('att-summary').style.display = 'none';
                currentSearchName = '';
                document.getElementById('search-nickname').value = '';
            }
            calendarInstance.refetchEvents();
        }

        function formatDuration(s) {
            if (!s || s < 0) return "ê·¼ë¬´ ì¤‘";
            const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60);
            return `${h}ì‹œê°„ ${m}ë¶„`;
        }

        async function searchAttendance() {
    currentSearchName = document.getElementById('search-nickname').value.trim();
    // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ì „ì²´ ëª¨ë“œë¡œ ëŒì•„ê°€ê¸° ìœ„í•´ ë¹ˆê°’ ì²˜ë¦¬
    if (currentSearchName === "") {
        document.getElementById('att-summary').style.display = 'none';
    }
    calendarInstance.refetchEvents();
}

        function initCalendar() {
            toggleLoading(true);
            const calendarEl = document.getElementById('calendar');
            calendarInstance = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                height: 'auto',
                displayEventTime: false,
                headerToolbar: { left: 'prev,next today', center: 'title', right: 'dayGridMonth,listMonth' },
                buttonText: { today: 'ì˜¤ëŠ˜', month: 'ë‹¬ë ¥', list: 'ë¦¬ìŠ¤íŠ¸' },
                events: async function(info, success, failure) {
                    try {
                        // [ìˆ˜ì •] í˜„ì¬ ë‹¬ë ¥ì˜ 'ì¤‘ì•™ ë‚ ì§œ'ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì—°-ì›”ì„ ê³„ì‚° (ê°€ì¥ ì •í™•í•¨)
                        const centerDate = new Date((info.start.getTime() + info.end.getTime()) / 2);
                        const targetMonth = centerDate.getFullYear() + "-" + 
                                           String(centerDate.getMonth() + 1).padStart(2, '0');
                        
                        let url = '';
                        if (currentMode === 'work') {
                            url = '/api/calendar';
                        } else {
                            url = !currentSearchName 
                                ? '/api/attendance/all' 
                                : `/api/attendance/summary?nickname=${encodeURIComponent(currentSearchName)}&month=${targetMonth}`;
                        }

                        const res = await fetch(url);
                        const resData = await res.json();
                        
                        let rawData = [];
                        if (currentMode === 'att') {
                            // [ìˆ˜ì •] ê²€ìƒ‰ ê²°ê³¼(ê°ì²´)ì™€ ì „ì²´ ëª©ë¡(ë°°ì—´) ëŒ€ì‘
                            if (resData && resData.records) {
                                rawData = resData.records;
                                document.getElementById('att-summary').style.display = 'block';
                                document.getElementById('att-summary').innerHTML = 
                                    `ğŸ“Š <b>${currentSearchName}</b>ë‹˜ (${targetMonth}): <b>${resData.count}íšŒ</b> / í•©ê³„ <b>${resData.totalHours}ì‹œê°„</b>`;
                            } else {
                                rawData = Array.isArray(resData) ? resData : [];
                                document.getElementById('att-summary').style.display = 'none';
                            }
                        } else {
                            rawData = Array.isArray(resData) ? resData : [];
                        }

                        const evts = rawData.map(d => {
                            if (currentMode === 'work') {
                                return { 
                                    id: d._id, title: d.title, start: d.start, display: 'block',
                                    backgroundColor: d.type==='ì¶œê³ '?'#F44336':d.type==='ìƒì‚°'?'#2196F3':'#4CAF50',
                                    extendedProps: { ...d } 
                                };
                            } else {
                                // [ì¤‘ìš”] ë‚ ì§œ ë§¤ì¹­ í™•ì¸: d.date ê°€ "2025-12-29" í˜•íƒœì¸ì§€ í™•ì¸
                                const inT = d.clockIn ? new Date(d.clockIn).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';
                                const outT = d.clockOut ? new Date(d.clockOut).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';
                                
                                return { 
                                    id: d._id, 
                                    title: `${d.nickname || d.username}: ${inT}~${outT} (${formatDuration(d.duration)})`, 
                                    start: d.date, // YYYY-MM-DD
                                    backgroundColor: '#10b981', 
                                    allDay: true, 
                                    extendedProps: { ...d } 
                                };
                            }
                        });
                        success(evts);
                    } catch (e) { 
                        console.error("ë§¤í•‘ ì—ëŸ¬:", e);
                        failure(e); 
                    } finally { 
                        setTimeout(() => toggleLoading(false), 200); 
                    }
                },
                eventClick: (info) => {
                    if (currentMode === 'att') openAttModal(info.event.extendedProps);
                    else openModal(info.event.startStr, info.event);
                },
                dayCellDidMount: (info) => {
                    const dStr = info.date.toLocaleDateString('sv-SE');
                    const h = holidayCache[info.date.getFullYear()]?.find(x => x.date === dStr);
                    const num = info.el.querySelector('.fc-daygrid-day-number');
                    if (num) {
                        if (info.date.getDay() === 0 || h) {
                            num.style.setProperty('color', '#F44336', 'important');
                            if (h) {
                                const div = document.createElement('div'); div.className = 'holiday-name'; div.innerText = `(${h.name})`;
                                num.parentElement.appendChild(div);
                            }
                        } else if (info.date.getDay() === 6) num.style.setProperty('color', '#2196F3', 'important');
                    }
                }
            });
            calendarInstance.render();
        }

        // --- ì‘ì—…(Work) ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ---
        function openModal(dateStr, event) {
            document.getElementById('modal-date').value = dateStr.split('T')[0];
            document.getElementById('product-tbody').innerHTML = '';
            document.getElementById('material-tbody').innerHTML = '';
            if (event) {
                document.getElementById('edit-event-id').value = event.id;
                document.getElementById('btn-delete').style.display = 'inline-block';
                const props = event.extendedProps;
                document.getElementById('modal-type').value = props.type;
                if (props.items) props.items.forEach(i => addRow(i.role === 'material' ? 'material-tbody' : 'product-tbody', i));
            } else {
                document.getElementById('edit-event-id').value = '';
                document.getElementById('btn-delete').style.display = 'none';
                addRow('product-tbody');
            }
            toggleProductionMode();
            document.getElementById('eventModal').style.display = 'block';
        }
        function closeModal() { document.getElementById('eventModal').style.display = 'none'; }
        function toggleProductionMode() { document.getElementById('material-section').style.display = (document.getElementById('modal-type').value === 'ìƒì‚°') ? 'block' : 'none'; }
        function addRow(tbodyId, data = null) {
            const tbody = document.getElementById(tbodyId);
            const tr = document.createElement('tr');
            const createOpts = (list, selVal) => `<option value="">ì„ íƒ</option>` + list.map(v => `<option value="${v}" ${String(v)===String(selVal)?'selected':''}>${v}</option>`).join('');
            tr.innerHTML = `
                <td><select class="input-name">${createOpts(dropdownOptions.items, data?.name)}</select></td>
                <td><select class="input-size">${createOpts(dropdownOptions.sizes, data?.size)}</select></td>
                <td><select class="input-length">${createOpts(dropdownOptions.lengths, data?.length)}</select></td>
                <td><input type="number" class="input-qty" step="0.1" value="${data?.quantity || 1}" style="width:60px; height:35px; text-align:center;"></td>
                <td><button onclick="this.closest('tr').remove()" style="background:none; border:none; cursor:pointer;">âŒ</button></td>`;
            tbody.appendChild(tr);
        }
        async function saveEvent() {
            const id = document.getElementById('edit-event-id').value;
            const type = document.getElementById('modal-type').value;
            const getItems = (tid) => Array.from(document.querySelectorAll(`#${tid} tr`)).map(tr => ({
                name: tr.querySelector('.input-name').value,
                size: tr.querySelector('.input-size').value || "-",
                length: tr.querySelector('.input-length').value || "-",
                quantity: parseFloat(tr.querySelector('.input-qty').value)
            })).filter(i => i.name);
            const products = getItems('product-tbody');
            const materials = type === 'ìƒì‚°' ? getItems('material-tbody') : [];
            const url = id ? `${API_URL}/${id}` : API_URL;
            toggleLoading(true);
            try {
                const res = await fetch(url, { method: id ? 'PUT' : 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ start: document.getElementById('modal-date').value, type, products, materials, username: localStorage.getItem('nickname') || localStorage.getItem('username') }) });
                if (res.ok) { closeModal(); calendarInstance.refetchEvents(); } 
                else { alert("ì €ì¥ ì‹¤íŒ¨"); toggleLoading(false); }
            } catch(e) { console.error(e); toggleLoading(false); }
        }
        async function deleteEvent() {
            if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            toggleLoading(true);
            await fetch(`${API_URL}/${document.getElementById('edit-event-id').value}`, { method: 'DELETE' });
            closeModal(); calendarInstance.refetchEvents();
        }

        // --- ê·¼ë¬´(Attendance) ëª¨ë‹¬ ê´€ë ¨ í•¨ìˆ˜ ---
        function openAttModal(data) {
            document.getElementById('att-id').value = data._id;
            document.getElementById('att-name').value = data.nickname || data.username;
            const toLocalISO = (d) => d ? new Date(new Date(d).getTime() - new Date(d).getTimezoneOffset() * 60000).toISOString().slice(0, 16) : "";
            document.getElementById('att-in').value = toLocalISO(data.clockIn);
            document.getElementById('att-out').value = toLocalISO(data.clockOut);
            document.getElementById('attendanceModal').style.display = 'block';
        }
        function closeAttModal() { document.getElementById('attendanceModal').style.display = 'none'; }
        async function saveAttendanceEdit() {
            toggleLoading(true);
            try {
                const res = await fetch(`/api/attendance/edit/${document.getElementById('att-id').value}`, {
                    method: 'PUT', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickname: document.getElementById('att-name').value, clockIn: document.getElementById('att-in').value, clockOut: document.getElementById('att-out').value })
                });
                if (res.ok) { alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤."); closeAttModal(); calendarInstance.refetchEvents(); }
                else { alert("ìˆ˜ì • ì‹¤íŒ¨"); toggleLoading(false); }
            } catch (e) { console.error(e); toggleLoading(false); }
        }
    </script>
</body>
</html>

// --- END OF FILE: public\calendar.html ---


// ==========================================
// [12/24] FILE: public\css\style.css
// ==========================================

/* 1. í”Œë¡œíŒ… ë²„íŠ¼: í¬ê¸°ë¥¼ í‚¤ìš°ê³  ë” ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì ì ìš© */
.floating-btn {
    position: fixed;
    bottom: 30px; /* ìœ„ì¹˜ë¥¼ ì¡°ê¸ˆ ë” ìœ„ë¡œ */
    right: 30px;
    width: 70px;  /* 60 -> 70 í™•ì¥ */
    height: 70px;
    border-radius: 50%;
    background: linear-gradient(135deg, #007bff, #0056b3); /* ê·¸ë¼ë°ì´ì…˜ ì¶”ê°€ */
    color: white;
    font-size: 35px;
    border: none;
    box-shadow: 0 8px 16px rgba(0,123,255,0.3); /* íŒŒë€ìƒ‰ ê³„ì—´ ê·¸ë¦¼ì */
    z-index: 1000;
    cursor: pointer;
    display: flex;
    justify-content: center;
    align-items: center;
    transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
}

.floating-btn:hover {
    transform: scale(1.1) rotate(90deg); /* í˜¸ë²„ ì‹œ ì»¤ì§€ë©´ì„œ íšŒì „ */
}

.floating-btn:active {
    transform: scale(0.9);
}

/* 2. ì¹´í…Œê³ ë¦¬ ë°°ì§€: ë” ë‘¥ê¸€ê²Œ í•˜ê³  ì…ì²´ê° ì¶”ê°€ */
.category-badge {
    color: white;
    padding: 6px 14px; /* íŒ¨ë”© í™•ì¥ */
    border-radius: 50px; /* ì™„ì „ íƒ€ì›í˜•ìœ¼ë¡œ */
    font-size: 0.9em;
    font-weight: 700;
    letter-spacing: -0.5px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    display: inline-block;
}

/* 3. ìˆ˜ëŸ‰ ì¡°ì ˆ ë° í…ìŠ¤íŠ¸: ì‹œì¸ì„± ê·¹ëŒ€í™” */
.qty-wrapper {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 12px; /* ê°„ê²© í™•ì¥ */
    background: #f1f3f5; /* ë°°ê²½ ì¶”ê°€ë¡œ ì˜ì—­ êµ¬ë¶„ */
    padding: 5px 12px;
    border-radius: 12px;
}

.qty-text {
    min-width: 45px;
    font-size: 1.3em; /* ë” í¬ê²Œ */
    font-weight: 900; /* ì•„ì£¼ ë‘ê»ê²Œ */
    color: #000;      /* ë” ì§„í•˜ê²Œ */
    text-align: center;
}

/* 4. ì…ë ¥ ê·¸ë¦¬ë“œ ë° ë“œë¡­ë‹¤ìš´/ì…ë ¥ì°½ UI ê°œì„  */
.input-grid {
    display: grid;
    grid-template-columns: 1fr;
    gap: 15px; /* ê°„ê²© í™•ì¥ */
    align-items: center;
}

@media (min-width: 768px) {
    .input-grid { grid-template-columns: 2fr 1fr 1fr 1fr 1.5fr 1fr; }
}

/* ë“œë¡­ë‹¤ìš´/ì…ë ¥ì°½: í¬ê²Œ, ë‘¥ê¸€ê²Œ, í™”ì‚¬í•˜ê²Œ */
.input-grid select, 
.input-grid input {
    width: 100%;
    height: 56px; /* 48 -> 56 ëŒ€í­ í™•ì¥ */
    padding: 0 20px;
    border: 2px solid #edf2f7; /* ì„ ì„ ë” ëª…í™•í•˜ê²Œ */
    border-radius: 16px;       /* í›¨ì”¬ ë‘¥ê¸€ê²Œ */
    font-size: 16px;           /* í°íŠ¸ í¬ê¸° ì—… */
    font-weight: 500;
    color: #2d3748;
    background-color: #fdfdfd;
    transition: all 0.2s ease-in-out;
    appearance: none;
    -webkit-appearance: none;
}

/* ì»¤ìŠ¤í…€ í™”ì‚´í‘œ ì•„ì´ì½˜ (ìœ„ì¹˜ ì¡°ì •) */
.input-grid select {
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%234a5568' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 20px center;
}

/* í¬ì»¤ìŠ¤ ì‹œ íš¨ê³¼ ê°•í™” */
.input-grid select:focus, 
.input-grid input:focus {
    outline: none;
    border-color: #2196F3;
    background-color: #fff;
    box-shadow: 0 0 0 4px rgba(33, 150, 243, 0.15);
    transform: translateY(-2px); /* ì‚´ì§ ë– ì˜¤ë¥´ëŠ” ëŠë‚Œ */
}

/* 5. ë“±ë¡ ë²„íŠ¼: ë” í¬ê³  ê°•ë ¥í•œ ëŠë‚Œ */
.btn-submit {
    height: 56px; /* ì…ë ¥ì°½ê³¼ ë™ì¼í•˜ê²Œ ë§ì¶¤ */
    background: linear-gradient(135deg, #444, #111); /* ê·¸ë¼ë°ì´ì…˜ */
    color: white;
    border: none;
    border-radius: 16px; /* ë‘¥ê¸€ê²Œ */
    font-weight: 800;
    font-size: 17px;
    letter-spacing: 1px;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(0,0,0,0.2);
    transition: all 0.3s ease;
}

.btn-submit:hover {
    background: #000;
    transform: translateY(-3px); /* í˜¸ë²„ ì‹œ ë¶• ëœ¨ëŠ” ëŠë‚Œ */
    box-shadow: 0 8px 20px rgba(0,0,0,0.3);
}

.btn-submit:active {
    transform: translateY(-1px);
}

/* ë¡œë”© ìŠ¤í”¼ë„ˆ ë””ìì¸ */
.spinner {
    width: 50px;
    height: 50px;
    border: 5px solid #e0e0e0;
    border-top: 5px solid #2196F3; /* í¬ì¸íŠ¸ ì»¬ëŸ¬ */
    border-radius: 50%;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

// --- END OF FILE: public\css\style.css ---


// ==========================================
// [13/24] FILE: public\index.html
// ==========================================

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì‹œìŠ¤í…œ ë¡œê·¸ì¸</title>
    <style>
        body { 
            padding: 20px; 
            font-family: 'Pretendard', sans-serif; 
            text-align: center; 
            background-color: #f5f5f5;
            display: flex;
            flex-direction: column;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
        }
        .container {
            background: white;
            padding: 30px 20px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            max-width: 400px;
            margin: 0 auto;
            width: 90%;
            box-sizing: border-box;
        }
        h1 { font-size: 1.5rem; color: #333; margin-bottom: 30px; }
        h3 { margin-top: 0; color: #555; }
        input { 
            padding: 15px; 
            margin: 8px 0; 
            width: 100%; 
            box-sizing: border-box; 
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px; /* ì•„ì´í° ì¤Œ ë°©ì§€ */
        }
        button { 
            padding: 15px; 
            width: 100%;
            cursor: pointer; 
            background-color: #333;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: bold;
            margin-top: 10px;
        }
        .toggle-btn {
            background: none;
            color: #2196F3;
            padding: 5px;
            font-size: 14px;
            text-decoration: underline;
            width: auto;
            margin-top: 0;
        }
        .hidden { display: none; }
    </style>
</head>
<body>
    <h1>ğŸ”’ ì‹œìŠ¤í…œ ì ‘ê·¼</h1>

    <div id="login-box" class="container">
        <h3>ë¡œê·¸ì¸</h3>
        <input type="text" id="login-id" placeholder="ì•„ì´ë””">
        <input type="password" id="login-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <button onclick="login()">ë¡œê·¸ì¸</button>
        <p style="font-size: 14px; color: #666; margin-top: 20px;">
            ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <button class="toggle-btn" onclick="toggleView()">íšŒì›ê°€ì… ì‹ ì²­</button>
        </p>
    </div>

    <div id="register-box" class="container hidden">
        <h3>íšŒì›ê°€ì… ì‹ ì²­</h3>
        <input type="text" id="reg-id" placeholder="ì•„ì´ë””">
        <input type="password" id="reg-pw" placeholder="ë¹„ë°€ë²ˆí˜¸">
        <input type="text" id="reg-nick" placeholder="ë‹‰ë„¤ì„">
        <button onclick="register()">ì‹ ì²­í•˜ê¸°</button>
        <p style="font-size: 14px; color: #666; margin-top: 20px;">
            ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <button class="toggle-btn" onclick="toggleView()">ë¡œê·¸ì¸ í•˜ëŸ¬ê°€ê¸°</button>
        </p>
    </div>

    <script>
        function toggleView() {
            document.getElementById('login-box').classList.toggle('hidden');
            document.getElementById('register-box').classList.toggle('hidden');
        }

        async function register() {
            const username = document.getElementById('reg-id').value;
            const password = document.getElementById('reg-pw').value;
            const nickname = document.getElementById('reg-nick').value;
            const res = await fetch('/api/register', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password, nickname })
            });
            const data = await res.json();
            alert(data.message);
            if (res.ok) toggleView();
        }

        async function login() {
    const username = document.getElementById('login-id').value;
    const password = document.getElementById('login-pw').value;
    const res = await fetch('/api/login', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username, password })
    });
    const data = await res.json();
    
    if (res.ok) {
        // [ìˆ˜ì •] ì•„ì´ë””ì™€ ë‹‰ë„¤ì„ì„ ê°ê° ì €ì¥í•©ë‹ˆë‹¤.
        localStorage.setItem('username', data.user.username);
        localStorage.setItem('nickname', data.user.nickname); 
        
        alert("ë¡œê·¸ì¸ ì„±ê³µ! " + data.user.nickname + "ë‹˜ í™˜ì˜í•©ë‹ˆë‹¤.");
        
        location.href = '/main.html';
    } else {
        alert(data.message);
    }
}
    </script>
</body>
</html>

// --- END OF FILE: public\index.html ---


// ==========================================
// [14/24] FILE: public\inventory.html
// ==========================================

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“¦ ìŠ¤ë§ˆíŠ¸ ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
        body { padding: 15px; font-family: 'Pretendard', sans-serif; background-color: #f4f7f9; margin: 0; color: #333; }
        .header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        
        /* ì…ë ¥ ì¹´ë“œ */
        .card { background: white; padding: 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
        .input-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 768px) { .input-grid { grid-template-columns: repeat(3, 1fr) 120px 140px 120px; } }

        select, input { width: 100%; height: 50px; border: 2px solid #edf2f7; border-radius: 12px; padding: 0 15px; font-size: 15px; box-sizing: border-box; }
        .btn-submit { background: #333; color: white; border: none; cursor: pointer; font-weight: bold; border-radius: 12px; height: 50px; }

        /* í•„í„° ë²„íŠ¼ */
        .filter-container { display: flex; gap: 10px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { padding: 10px 18px; border-radius: 20px; border: none; background: white; cursor: pointer; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.05); white-space: nowrap; }
        .filter-btn.active { background: #2196F3; color: white; }

        /* --- í…Œì´ë¸” ë””ìì¸ (PC) --- */
        .pc-table { width: 100%; border-collapse: separate; border-spacing: 0; display: none; background: white; border-radius: 16px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        @media (min-width: 768px) { .pc-table { display: table; } }

        .pc-table th { background: #f8fafc; color: #64748b; padding: 15px; font-size: 13px; border-bottom: 2px solid #edf2f7; }
        .pc-table td { padding: 15px; text-align: center; border-bottom: 1px solid #edf2f7; }

        /* ì§€ê·¸ì¬ê·¸ íš¨ê³¼ ë° í˜¸ë²„ ê°•í™” */
        .pc-table tbody tr:nth-child(even) { background-color: #f1f5f9 !important; }
        .pc-table tbody tr:nth-child(odd) { background-color: #ffffff !important; }
        .pc-table tbody tr:hover { background-color: #e2e8f0 !important; }

        /* --- ëª¨ë°”ì¼ ì¹´ë“œ ë””ìì¸ --- */
        .mobile-only-section { display: block; }
        @media (min-width: 768px) { .mobile-only-section { display: none; } }

        .mobile-card { background: white; border-radius: 16px; padding: 18px; margin-bottom: 15px; border: 1px solid #edf2f7; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        
        /* ìˆ˜ëŸ‰ ì»¨íŠ¸ë¡¤ ìœ ë‹› */
        .qty-control { display: inline-flex; align-items: center; background: #e2e8f0; padding: 4px; border-radius: 12px; gap: 8px; }
        .qty-text { font-size: 1.2rem; font-weight: 900; min-width: 50px; text-align: center; color: #1e293b; }
        .qty-text.zero { color: #ef4444; }
        .qty-control button { width: 35px; height: 35px; border: none; border-radius: 8px; background: white; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }

        /* ë°°ì§€ ìŠ¤íƒ€ì¼ */
        .badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; color: white; }
        .badge-finished { background: #10b981; }
        .badge-raw { background: #3b82f6; }
        .badge-stock-out { background: #ef4444; margin-left: 5px; }

        /* ë¡œë”© ë ˆì´ì–´ */
        #loading-layer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #2196F3; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-layer">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: bold;">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</p>
    </div>

    <div class="header-box">
        <h1>ğŸ“¦ ìŠ¤ë§ˆíŠ¸ ì¬ê³  ê´€ë¦¬</h1>
        <div style="display: flex; gap: 8px; align-items: center;">
            <button onclick="location.href='/main.html'" style="padding:10px 15px; background:#334155; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:bold; display: flex; align-items: center; gap: 5px;">
                <span>ğŸ </span> í™ˆ
            </button>
            <button onclick="location.href='/calendar.html'" style="padding:10px 15px; background:#2196F3; color:white; border:none; border-radius:12px; cursor:pointer; font-weight:bold;">ğŸ“… ë‹¬ë ¥ë³´ê¸°</button>
            <button onclick="logout()" style="padding:10px 10px; background:none; border:none; color:#64748b; cursor:pointer; font-size: 14px;">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="card">
        <div class="input-grid">
            <select id="new-name"></select>
            <select id="new-size"></select>
            <select id="new-length"></select>
            <input type="number" id="new-qty" value="0" placeholder="ìˆ˜ëŸ‰">
            <select id="new-category">
                <option value="ì™„ì œí’ˆ">ğŸŸ¢ ì™„ì œí’ˆ</option>
                <option value="ì›ìì¬">ğŸ”µ ì›ìì¬</option>
            </select>
            <button class="btn-submit" onclick="addItem()">ë¬¼í’ˆ ë“±ë¡</button>
        </div>
    </div>

    <div class="filter-container">
        <button class="filter-btn active" onclick="filterItems('ì „ì²´', this)">ì „ì²´</button>
        <button class="filter-btn" onclick="filterItems('ì™„ì œí’ˆ', this)">ì™„ì œí’ˆ</button>
        <button class="filter-btn" onclick="filterItems('ì›ìì¬', this)">ì›ìì¬</button>
        <button class="filter-btn" onclick="filterItems('í’ˆì ˆ', this)" style="color:#ef4444;">ğŸš¨ í’ˆì ˆ/ë¶€ì¡±</button>
        <input type="text" id="search-input" placeholder="ê²€ìƒ‰..." onkeyup="searchItems()" style="height:40px; width:150px; border-radius:10px; border:1px solid #ddd; padding:0 10px;">
    </div>

    <div id="inventory-content">
        <div id="finished-section">
            <h2 style="color:#2e7d32; font-size: 1.2rem;">ğŸŸ¢ ì™„ì œí’ˆ í˜„í™© <span id="count-finished" style="font-size:0.8rem; color:#94a3b8; font-weight: normal;"></span></h2>
            <table class="pc-table">
                <thead><tr><th>ìƒíƒœ</th><th>í’ˆëª© ì •ë³´</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰ ì œì–´</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="pc-list-finished"></tbody>
            </table>
            <div class="mobile-only-section" id="mobile-list-finished"></div>
        </div>
        
        <div id="raw-section" style="margin-top:40px;">
            <h2 style="color:#1565c0; font-size: 1.2rem;">ğŸ”µ ì›ìì¬ í˜„í™© <span id="count-raw" style="font-size:0.8rem; color:#94a3b8; font-weight: normal;"></span></h2>
            <table class="pc-table">
                <thead><tr><th>ìƒíƒœ</th><th>í’ˆëª© ì •ë³´</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰ ì œì–´</th><th>ê´€ë¦¬</th></tr></thead>
                <tbody id="pc-list-raw"></tbody>
            </table>
            <div class="mobile-only-section" id="mobile-list-raw"></div>
        </div>
    </div>

    <script>
        const API_URL = '/api/inventory';
        const API_OPT = '/api/options';
        const currentUser = localStorage.getItem('username');
        const currentNick = localStorage.getItem('nickname');
        let allItemsData = [];

        // [ì¶”ê°€] ê³µíœ´ì¼ ë¯¸ë¦¬ ê°€ì ¸ì˜¤ê¸° í•¨ìˆ˜
    async function prefetchHolidays() {
        const currentYear = new Date().getFullYear();
        const yearsToFetch = [currentYear, currentYear + 1]; // ì˜¬í•´, ë‚´ë…„
        // ê¸°ì¡´ ìºì‹œ í™•ì¸
        let cache = JSON.parse(localStorage.getItem('holiday_cache')) || {};

        for (const year of yearsToFetch) {
            if (cache[year]) continue; // ì´ë¯¸ ìˆìœ¼ë©´ íŒ¨ìŠ¤

            try {
                const res = await fetch(`/api/holidays/${year}`);
                const data = await res.json();
                cache[year] = data;
                localStorage.setItem('holiday_cache', JSON.stringify(cache));
                console.log(`âœ… ${year}ë…„ ê³µíœ´ì¼ ë¯¸ë¦¬ ì¤€ë¹„ ì™„ë£Œ`);
            } catch (e) {
                console.error(`${year}ë…„ ê³µíœ´ì¼ ì˜ˆì—´ ì‹¤íŒ¨`, e);
            }
        }
    }

        window.onload = () => {
            if (!currentUser) { location.href = '/'; return; }
            initPage();
            prefetchHolidays();
        };

        async function initPage() {
            await loadOptions();
            await loadItems();
        }

        async function loadOptions() {
            try {
                const res = await fetch(API_OPT);
                const options = await res.json();
                const sel = {
                    name: document.getElementById('new-name'),
                    size: document.getElementById('new-size'),
                    len: document.getElementById('new-length')
                };

                sel.name.innerHTML = '<option value="">í’ˆëª© ì„ íƒ</option>';
                sel.size.innerHTML = '<option value="">ì‚¬ì´ì¦ˆ ì„ íƒ</option>';
                sel.len.innerHTML = '<option value="">ê¸¸ì´ ì„ íƒ</option>';

                options.forEach(opt => {
                    const o = document.createElement('option');
                    o.value = opt.value; o.innerText = opt.value;
                    if (opt.type === 'itemName') sel.name.appendChild(o);
                    else if (opt.type === 'size') sel.size.appendChild(o);
                    else if (opt.type === 'length') sel.len.appendChild(o);
                });
            } catch (e) { console.error(e); }
        }

        async function loadItems() {
            showLoading(true);
            try {
                const res = await fetch(API_URL);
                allItemsData = await res.json();
                renderItems(allItemsData);
            } catch (err) { console.error(err); }
            finally { showLoading(false); }
        }

        function renderItems(items) {
            const pcF = document.getElementById('pc-list-finished');
            const pcR = document.getElementById('pc-list-raw');
            const mobF = document.getElementById('mobile-list-finished');
            const mobR = document.getElementById('mobile-list-raw');

            [pcF, pcR, mobF, mobR].forEach(el => el.innerHTML = '');

            // --- ì •ë ¬ ë¡œì§ ì ìš©: ìˆ˜ëŸ‰ ìˆëŠ” ê²ƒ ìš°ì„  -> ìµœì‹  ìˆ˜ì •ìˆœ ---
            items.sort((a, b) => {
                if (a.quantity > 0 && b.quantity <= 0) return -1;
                if (a.quantity <= 0 && b.quantity > 0) return 1;
                return new Date(b.updatedAt || 0) - new Date(a.updatedAt || 0);
            });

            items.forEach(item => {
                const isRaw = item.category === 'ì›ìì¬';
                const qtyClass = item.quantity <= 0 ? 'zero' : '';
                const badgeClass = isRaw ? 'badge-raw' : 'badge-finished';
                const stockOut = item.quantity <= 0 ? '<span class="badge badge-stock-out">í’ˆì ˆ</span>' : '';

                const row = `
                    <tr>
                        <td><span class="badge ${badgeClass}">${item.category}</span>${stockOut}</td>
                        <td style="text-align:left; font-weight:800; padding-left:20px;">${item.name}</td>
                        <td><b>${item.size}</b></td>
                        <td><b>${item.length}</b></td>
                        <td>
                            <div class="qty-control">
                                <button onclick="updateStock('${item._id}', ${item.quantity - 1})">ï¼</button>
                                <span class="qty-text ${qtyClass}">${item.quantity}</span>
                                <button onclick="updateStock('${item._id}', ${item.quantity + 1})">ï¼‹</button>
                            </div>
                        </td>
                        <td><button onclick="deleteItem('${item._id}')" style="color:#cbd5e1; background:none; border:none; cursor:pointer; font-size:12px;">ì‚­ì œ</button></td>
                    </tr>`;
                
                const card = `
                    <div class="mobile-card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                            <span class="badge ${badgeClass}">${item.category}</span>
                            ${stockOut}
                        </div>
                        <div style="font-weight:800; font-size:1.1rem; margin-bottom:5px;">${item.name}</div>
                        <div style="color:#64748b; font-size:0.9rem; margin-bottom:15px;">ê·œê²©: ${item.size} / ${item.length}</div>
                        <div style="display:flex; justify-content:space-between; align-items:center;">
                            <div class="qty-control">
                                <button onclick="updateStock('${item._id}', ${item.quantity - 1})">ï¼</button>
                                <span class="qty-text ${qtyClass}">${item.quantity}</span>
                                <button onclick="updateStock('${item._id}', ${item.quantity + 1})">ï¼‹</button>
                            </div>
                            <button onclick="deleteItem('${item._id}')" style="color:#ef4444; background:none; border:none; font-weight:bold;">ì‚­ì œ</button>
                        </div>
                    </div>`;

                if(isRaw) {
                    pcR.innerHTML += row;
                    mobR.innerHTML += card;
                } else {
                    pcF.innerHTML += row;
                    mobF.innerHTML += card;
                }
            });

            document.getElementById('count-finished').innerText = `(${pcF.children.length}ê±´)`;
            document.getElementById('count-raw').innerText = `(${pcR.children.length}ê±´)`;
        }

        async function updateStock(id, newQty) {
            if(newQty < 0) return;
            await fetch(`${API_URL}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantity: newQty, username: currentNick || currentUser })
            });
            loadItems();
        }

        async function addItem() {
            const data = {
                name: document.getElementById('new-name').value,
                size: document.getElementById('new-size').value,
                length: document.getElementById('new-length').value,
                quantity: document.getElementById('new-qty').value,
                category: document.getElementById('new-category').value,
                username: currentNick || currentUser
            };
            if(!data.name) return alert("í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”.");
            showLoading(true);
            await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });
            loadItems();
        }

        async function deleteItem(id) {
            if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            loadItems();
        }

        function filterItems(type, btn) {
            document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            if(type === 'ì „ì²´') renderItems(allItemsData);
            else if(type === 'í’ˆì ˆ') renderItems(allItemsData.filter(i => i.quantity <= 0));
            else renderItems(allItemsData.filter(i => i.category === type));
        }

        function searchItems() {
            const term = document.getElementById('search-input').value.toLowerCase();
            renderItems(allItemsData.filter(i => i.name.toLowerCase().includes(term) || i.size.toLowerCase().includes(term)));
        }

        function showLoading(show) { document.getElementById('loading-layer').style.display = show ? 'flex' : 'none'; }
        function logout() { localStorage.clear(); location.href = '/'; }
    </script>
</body>
</html>

// --- END OF FILE: public\inventory.html ---


// ==========================================
// [15/24] FILE: public\js\script.js
// ==========================================

// ëª¨ë°”ì¼ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
const mobileBtn = document.getElementById("mobileAddBtn");

if (mobileBtn) {
  mobileBtn.addEventListener("click", function () {
    // 1. ì˜¤ëŠ˜ ë‚ ì§œ êµ¬í•˜ê¸° (YYYY-MM-DD)
    const today = new Date().toISOString().split("T")[0];

    // 2. ë‚ ì§œ ì…ë ¥ì¹¸(id="date")ì— ì˜¤ëŠ˜ ë‚ ì§œ ì±„ì›Œì£¼ê¸°
    // (ë³¸ì¸ HTMLì˜ ë‚ ì§œ ì…ë ¥ì¹¸ IDê°€ 'date'ì¸ì§€ í™•ì¸ í•„ìš”)
    const dateInput = document.querySelector('input[type="date"]');
    if (dateInput) {
      dateInput.value = today;
    }

    // 3. ëª¨ë‹¬ì°½ ë„ìš°ê¸° í•¨ìˆ˜ ì‹¤í–‰
    // â˜…ì¤‘ìš”â˜…: ë³¸ì¸ ì½”ë“œì—ì„œ ëª¨ë‹¬ì°½ ë„ìš°ëŠ” í•¨ìˆ˜ ì´ë¦„ì´ openModalì´ ì•„ë‹ˆë©´ ìˆ˜ì •í•˜ì„¸ìš”!
    if (typeof openModal === "function") {
      openModal();
    } else {
      console.error("ëª¨ë‹¬ ë„ìš°ëŠ” í•¨ìˆ˜ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”!");
      alert("ì¼ì • ì¶”ê°€ ì°½ì„ ë„ìš°ëŠ” í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    }
  });
}


// --- END OF FILE: public\js\script.js ---


// ==========================================
// [16/24] FILE: public\main.html
// ==========================================

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ  ìŠ¤ë§ˆíŠ¸ ê³µì¥ ì‹œìŠ¤í…œ</title>
    <style>
        /* ê¸°ë³¸ ë² ì´ìŠ¤ ìŠ¤íƒ€ì¼ */
        body { 
            padding: 20px; 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; 
            background-color: #f4f7f9; 
            margin: 0; 
            color: #334155; 
            -webkit-tap-highlight-color: transparent;
        }

        .header { margin: 30px 0; text-align: center; }
        .header h1 { font-size: 1.4rem; margin-bottom: 5px; color: #1e293b; }
        .user-name { color: #2196F3; font-weight: 800; }
        .header p { color: #64748b; font-size: 0.9rem; margin: 0; }

        /* ë©”ë‰´ ê·¸ë¦¬ë“œ: 2ì—´ ìë™ ë°°ì¹˜ */
        .menu-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            max-width: 500px; 
            margin: 0 auto; 
        }

        /* ë©”ë‰´ ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .menu-card {
            background: white; 
            border-radius: 24px; 
            padding: 25px 10px; 
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.03); 
            border: 2px solid transparent; 
            cursor: pointer;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            gap: 12px;
            transition: all 0.2s ease;
            min-height: 150px;
        }

        .menu-card:active { 
            transform: scale(0.95); 
            background-color: #f8fafc; 
        }

        .menu-card .icon { font-size: 2.2rem; }
        .menu-card span { font-weight: 700; font-size: 1.05rem; }

        /* ìƒíƒœë³„ ìƒ‰ìƒ í¬ì¸íŠ¸ */
        .card-stock { color: #3b82f6; }
        .card-cal { color: #f59e0b; }
        
        /* ìƒì‚° ê¸°ë¡ ë²„íŠ¼ (ê°•ì¡°í˜•) */
        .card-prod { 
            grid-column: span 2; /* 5ë²ˆì§¸ ë²„íŠ¼ì´ë¯€ë¡œ ê°€ë¡œ ì „ì²´ ì±„ìš°ê¸° */
            background: #ecfdf5; 
            border-color: #10b981; 
            color: #047857;
            flex-direction: row; /* ëª¨ë°”ì¼ì—ì„œ ê°€ë¡œí˜•ìœ¼ë¡œ í‘œì‹œ */
            min-height: 100px;
            margin-top: 5px;
        }
        .card-prod .icon { font-size: 2rem; margin-right: 10px; }

        /* ê´€ë¦¬ì ì „ìš© ìŠ¤íƒ€ì¼ */
        .card-admin { 
            grid-column: span 2; 
            border: 2px dashed #6366f1; 
            color: #4f46e5;
            background: #f5f3ff;
            min-height: 80px;
            flex-direction: row;
        }

        /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */
        .logout-btn {
            margin: 40px auto 20px auto; 
            width: 120px; 
            padding: 12px;
            background: #e2e8f0; 
            color: #64748b; 
            border: none; 
            border-radius: 12px;
            font-weight: 600; 
            cursor: pointer; 
            display: block;
            font-size: 0.9rem;
        }

        /* ë¡œë”© ë ˆì´ì–´ */
        #loading-layer { 
            display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.9); z-index: 9999; 
            justify-content: center; align-items: center; flex-direction: column; 
            backdrop-filter: blur(5px);
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2196F3; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ëª¨ë°”ì¼ ìµœì í™” ë¯¸ì„¸ ì¡°ì • */
        @media (max-width: 400px) {
            .menu-grid { gap: 10px; }
            .menu-card { min-height: 130px; border-radius: 20px; }
            .menu-card span { font-size: 0.95rem; }
        }
    </style>
</head>
<body>
    <div id="loading-layer">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: bold;">ì •ë³´ ë™ê¸°í™” ì¤‘...</p>
    </div>

    <div class="header">
        <h1>ì•ˆë…•í•˜ì„¸ìš”, <span id="user-display" class="user-name">...</span>ë‹˜!</h1>
        <p>ì˜¤ëŠ˜ì˜ ì—…ë¬´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
    </div>

    <div class="menu-grid">
        <button class="menu-card" id="btn-check-in" onclick="handleAttendance('check-in')">
            <div class="icon">ğŸŒ…</div>
            <span>ì¶œê·¼ ì²´í¬</span>
        </button>
        <button class="menu-card" id="btn-check-out" onclick="handleAttendance('check-out')">
            <div class="icon">ğŸŒ™</div>
            <span>í‡´ê·¼ ì²´í¬</span>
        </button>

        <button class="menu-card card-stock" onclick="location.href='/inventory.html'">
            <div class="icon">ğŸ“¦</div>
            <span>ì¬ê³  ê´€ë¦¬</span>
        </button>
        <button class="menu-card card-cal" onclick="location.href='/calendar.html'">
            <div class="icon">ğŸ“…</div>
            <span>ì‘ì—…/ê·¼ë¬´ ë‹¬ë ¥</span>
        </button>
        
        <button class="menu-card card-prod" onclick="location.href='/production.html'">
            <div class="icon">ğŸ”¨</div>
            <span>ìƒì‚° ê¸°ë¡ ë“±ë¡</span>
        </button>

        <button id="admin-menu" class="menu-card card-admin" style="display:none;" onclick="location.href='/admin.html'">
            <div class="icon">ğŸ›¡ï¸</div>
            <span>ì‹œìŠ¤í…œ ê´€ë¦¬ì ëª¨ë“œ</span>
        </button>
    </div>

    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>

    <script>
        const currentUser = localStorage.getItem('username');
        const currentNick = localStorage.getItem('nickname');

        window.onload = async () => {
            if (!currentUser) { location.href = '/'; return; }
            document.getElementById('user-display').innerText = currentNick || currentUser;
            
            try {
                await Promise.all([
                    checkAdminStatus(),
                    checkAttendanceStatus()
                ]);
            } catch (err) {
                console.error(err);
            } finally {
                setTimeout(() => {
                    document.getElementById('loading-layer').style.display = 'none';
                }, 300);
            }
        };

        async function checkAdminStatus() {
            try {
                const res = await fetch(`/api/admin/check`);
                const data = await res.json();
                if (data.isAdmin) {
                    document.getElementById('admin-menu').style.display = 'flex';
                }
            } catch (err) { console.log("ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œ"); }
        }

        async function checkAttendanceStatus() {
            try {
                const res = await fetch(`/api/attendance/status/${currentUser}`);
                const data = await res.json();
                if (data) {
                    if (data.clockIn) updateButtonUI('check-in', data.clockIn);
                    if (data.clockOut) updateButtonUI('check-out', data.clockOut);
                }
            } catch (err) { console.error(err); }
        }

        function updateButtonUI(type, isoTime) {
            const time = new Date(isoTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isBtnIn = type === 'check-in';
            const btn = document.getElementById(isBtnIn ? 'btn-check-in' : 'btn-check-out');
            btn.onclick = null;
            btn.style.backgroundColor = '#f1f5f9';
            btn.innerHTML = `
                <div class="icon">${isBtnIn ? 'âœ…' : 'ğŸ'}</div>
                <span style="color: #94a3b8;">${isBtnIn ? 'ì¶œê·¼' : 'í‡´ê·¼'} ì™„ë£Œ</span>
                <small style="font-size: 0.8rem; color: #64748b; font-weight: bold;">${time}</small>
            `;
        }

        async function handleAttendance(type) {
            const modeName = type === 'check-in' ? 'ì¶œê·¼' : 'í‡´ê·¼';
            if (!confirm(`${modeName} ì²´í¬ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                const res = await fetch(`/api/attendance/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, nickname: currentNick })
                });
                if (res.ok) { location.reload(); } 
                else { const data = await res.json(); alert(data.message); }
            } catch (err) { alert("í†µì‹  ì˜¤ë¥˜"); }
        }

        function logout() {
            localStorage.clear();
            location.href = '/';
        }
    </script>
</body>
</html>

// --- END OF FILE: public\main.html ---


// ==========================================
// [17/24] FILE: public\production.html
// ==========================================

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìƒì‚° ê¸°ë¡ - ìŠ¤ë§ˆíŠ¸ íŒ©í† ë¦¬</title>
    <style>
        body { background-color: #f4f7f9; padding: 20px; font-family: -apple-system, sans-serif; margin: 0; }
        .prod-container { max-width: 500px; margin: 0 auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); box-sizing: border-box; }
        h1 { font-size: 1.5rem; display: flex; align-items: center; gap: 10px; margin-bottom: 25px; color: #1e293b; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #475569; font-size: 0.9rem; }
        select, input { width: 100%; padding: 15px; font-size: 16px; border-radius: 12px; border: 1px solid #ddd; background-color: #fff; box-sizing: border-box; }
        .submit-btn { width: 100%; padding: 20px; font-size: 18px; background: #28a745; color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-top: 10px; }
        .submit-btn:active { transform: scale(0.98); opacity: 0.9; }
        .back-link { display: block; text-align: center; margin-top: 20px; color: #64748b; text-decoration: none; font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="prod-container">
        <h1>ğŸ”¨ ìƒì‚° ê¸°ë¡ ë“±ë¡</h1>

        <div class="input-group">
    <label>ì‚¬ìš© ì§€ê´€ ì„ íƒ</label>
    <div style="display: flex; gap: 20px; padding: 10px 0;">
        <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
            <input type="radio" name="tubeType" value="ì¢…ì´ì§€ê´€(6)" checked style="width: 20px; height: 20px;"> ì¢…ì´ì§€ê´€(6)
        </label>
        <label style="display: flex; align-items: center; gap: 8px; font-weight: normal; cursor: pointer;">
            <input type="radio" name="tubeType" value="ppì§€ê´€(6)" style="width: 20px; height: 20px;"> ppì§€ê´€(6)
        </label>
    </div>
</div>
        
        <div class="input-group">
            <label>ì‚¬ìš©í•œ ì›ìì¬ (ì›ë‹¨)</label>
            <select id="select-material"><option value="">ì›ë‹¨ ì„ íƒ</option></select>
        </div>

        <hr style="border: 0; border-top: 1px solid #eee; margin: 25px 0;">

        <div class="input-group">
            <label>í­ (Width)</label>
            <select id="width"><option value="">í­ ì„ íƒ</option></select>
        </div>

        <div class="input-group">
            <label>ì‚¬ì´ì¦ˆ (ê¸¸ì´)</label>
            <select id="size"><option value="">ì‚¬ì´ì¦ˆ ì„ íƒ</option></select>
        </div>

        <div class="input-group">
            <label>ìƒì‚° ìˆ˜ëŸ‰ (ê°œ)</label>
            <input type="number" id="quantity" placeholder="ì´ë²ˆ ì‹œê°„ ìƒì‚°ëŸ‰ ì…ë ¥" inputmode="numeric">
        </div>

        <button class="submit-btn" onclick="submitProduction()">ê¸°ë¡ ì €ì¥ (ì¬ê³ /ì¼ì • ë°˜ì˜)</button>
        <a href="main.html" class="back-link">ë©”ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>

    <script>
        window.onload = async () => {
            try {
                const [invRes, optRes] = await Promise.all([
                    fetch('/api/inventory'),
                    fetch('/api/options') 
                ]);

                if (!invRes.ok || !optRes.ok) throw new Error("ë°ì´í„° ì‘ë‹µ ì˜¤ë¥˜");

                const inventory = await invRes.json();
                const options = await optRes.json();

                // 1. ì›ìì¬ ì±„ìš°ê¸°
                const materialSelect = document.getElementById('select-material');
                inventory.filter(item => item.category === 'ì›ìì¬').forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m._id;
                    opt.dataset.rawName = m.name;
                    opt.textContent = `${m.name} (ì”ì—¬: ${m.quantity})`;
                    materialSelect.appendChild(opt);
                });

                // 2. ì˜µì…˜ ë¶„ë¥˜ (ê´€ë¦¬ì í˜ì´ì§€ ë°ì´í„° íƒ€ì… ë§¤ì¹­)
                const widthSelect = document.getElementById('width');
                const sizeSelect = document.getElementById('size');

                options.forEach(opt => {
                    const element = document.createElement('option');
                    element.value = opt.value;
                    element.textContent = opt.value;

                    if (opt.type === 'size') { // ê´€ë¦¬ì í˜ì´ì§€ì˜ 'ì‚¬ì´ì¦ˆ' ì¹¸
                        widthSelect.appendChild(element);
                    } else if (opt.type === 'length') { // ê´€ë¦¬ì í˜ì´ì§€ì˜ 'ê¸¸ì´' ì¹¸
                        element.textContent = opt.value + "m";
                        sizeSelect.appendChild(element);
                    }
                });

            } catch (err) {
                console.error("ë¡œë“œ ì‹¤íŒ¨:", err);
                alert("ì„¤ì • ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
            }
        };

        async function submitProduction() {
            const materialEl = document.getElementById('select-material');
            if (!materialEl.value) return alert("ì›ìì¬ë¥¼ ì„ íƒí•˜ì„¸ìš”.");
            
            const selectedTube = document.querySelector('input[name="tubeType"]:checked').value;
    const selectedText = materialEl.options[materialEl.selectedIndex].text;
    const selectedRawName = materialEl.options[materialEl.selectedIndex].dataset.rawName;
    
    const data = {
        materialId: materialEl.value,
        materialName: selectedText,
        category: selectedRawName,
        width: document.getElementById('width').value,
        size: document.getElementById('size').value,
        quantity: parseInt(document.getElementById('quantity').value),
        tubeName: selectedTube // [ì¶”ê°€] ì„ íƒëœ ì§€ê´€ ì´ë¦„ ì „ë‹¬
    };

            if(!data.width || !data.size || !data.quantity) {
                alert("ëª¨ë“  í•­ëª©ì„ ì„ íƒí•˜ê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”."); return;
            }

            const res = await fetch('/api/inventory/produce', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            });

            if(res.ok) {
                alert("ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                location.reload();
            } else {
                const errData = await res.json();
                alert("ì €ì¥ ì‹¤íŒ¨: " + errData.error);
            }
        }
    </script>
</body>
</html>

// --- END OF FILE: public\production.html ---


// ==========================================
// [18/24] FILE: routes\attendance.js
// ==========================================

const express = require("express");
const router = express.Router();
const Attendance = require("../models/Attendance");
const User = require("../models/User");

// 1. ìƒíƒœ í™•ì¸ (ì˜¤ëŠ˜ ì¶œí‡´ê·¼ í–ˆëŠ”ì§€)
router.get("/status/:username", async (req, res) => {
  try {
    const today = new Date().toISOString().split("T")[0];
    const user = await User.findOne({ username: req.params.username });
    const record = await Attendance.findOne({ userId: user._id, date: today });
    res.json(record);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

// 2. ì¶œê·¼ ì²˜ë¦¬
router.post("/check-in", async (req, res) => {
  try {
    const { username, nickname } = req.body;
    const today = new Date().toISOString().split("T")[0];
    const user = await User.findOne({ username });
    const exists = await Attendance.findOne({ userId: user._id, date: today });
    if (exists) return res.status(400).json({ message: "ì´ë¯¸ ì¶œê·¼í–ˆìŠµë‹ˆë‹¤." });

    const newIn = new Attendance({
      userId: user._id,
      username,
      nickname,
      date: today,
      clockIn: new Date(),
    });
    await newIn.save();
    res.json({ time: newIn.clockIn });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

// 3. í‡´ê·¼ ì²˜ë¦¬
router.post("/check-out", async (req, res) => {
  try {
    const { username } = req.body;
    const today = new Date().toISOString().split("T")[0];
    const user = await User.findOne({ username });
    const record = await Attendance.findOne({ userId: user._id, date: today });
    if (!record)
      return res.status(400).json({ message: "ì¶œê·¼ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤." });
    if (record.clockOut)
      return res.status(400).json({ message: "ì´ë¯¸ í‡´ê·¼í–ˆìŠµë‹ˆë‹¤." });

    record.clockOut = new Date();
    record.duration = Math.floor((record.clockOut - record.clockIn) / 1000);
    await record.save();
    res.json({ time: record.clockOut });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

// 4. ëª¨ë“  ê¸°ë¡ ì¡°íšŒ (ë‹¬ë ¥ìš©)
router.get("/all", async (req, res) => {
  try {
    const records = await Attendance.find().sort({ clockIn: 1 });
    res.json(records);
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

// 5. ê·¼ë¬´ ê¸°ë¡ ìˆ˜ì • (ë‹¬ë ¥ìš©)
router.put("/edit/:id", async (req, res) => {
  try {
    const { id } = req.params;
    const { nickname, clockIn, clockOut } = req.body;

    const record = await Attendance.findById(id);
    if (!record)
      return res.status(404).json({ message: "ê¸°ë¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });

    record.nickname = nickname;
    record.clockIn = new Date(clockIn);
    if (clockOut) {
      record.clockOut = new Date(clockOut);
      // ê·¼ë¬´ ì‹œê°„ ì¬ê³„ì‚° (ì´ˆ ë‹¨ìœ„)
      record.duration = Math.floor((record.clockOut - record.clockIn) / 1000);
    }

    await record.save();
    res.json({ message: "ìˆ˜ì • ì™„ë£Œ" });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

// [ì¶”ê°€] íŠ¹ì • ì§ì› ê²€ìƒ‰ ë° ì›”ê°„ í†µê³„ API
router.get("/summary", async (req, res) => {
  try {
    const { nickname, month } = req.query; // nickname: ê²€ìƒ‰ì–´, month: "2025-12"
    let query = {};

    // 1. ì´ë¦„/ë‹‰ë„¤ì„ ê²€ìƒ‰ (ë¶€ë¶„ ì¼ì¹˜ ê²€ìƒ‰ ì ìš©)
    if (nickname && nickname.trim() !== "") {
      query.$or = [
        { nickname: { $regex: nickname, $options: "i" } },
        { username: { $regex: nickname, $options: "i" } },
      ];
    }

    // 2. ì›”ë³„ í•„í„°ë§ (í•´ë‹¹ ì›”ì˜ ì‹œì‘ì¼ë¶€í„° ëì¼ê¹Œì§€)
    if (month && month.trim() !== "") {
      // date í•„ë“œê°€ "2025-12-01" í˜•ì‹ì´ë¯€ë¡œ "2025-12"ë¡œ ì‹œì‘í•˜ëŠ” ëª¨ë“  ë°ì´í„°ë¥¼ ì°¾ìŒ
      query.date = { $regex: `^${month}` };
    }

    const records = await Attendance.find(query).sort({ date: -1 });

    // 3. ì´ ê·¼ë¬´ ì‹œê°„ ê³„ì‚°
    const totalSeconds = records.reduce(
      (acc, rec) => acc + (rec.duration || 0),
      0
    );
    const totalHours = (totalSeconds / 3600).toFixed(1);

    res.json({
      records,
      totalHours,
      count: records.length,
    });
  } catch (err) {
    console.error("ê²€ìƒ‰ ì—ëŸ¬:", err);
    res.status(500).json({ message: "ì„œë²„ ê²€ìƒ‰ ì˜¤ë¥˜" });
  }
});

module.exports = router;


// --- END OF FILE: routes\attendance.js ---


// ==========================================
// [19/24] FILE: routes\auth.js
// ==========================================

const express = require("express");
const router = express.Router();
const User = require("../models/User");

// 1. íšŒì›ê°€ì… ì‹ ì²­
router.post("/register", async (req, res) => {
  console.log("1. ìš”ì²­ ë°›ìŒ! ë°ì´í„°:", req.body); // ì—¬ê¸°ëŠ” ëœ° ê²ƒì„

  try {
    const { username, password, nickname } = req.body;

    console.log("2. ì¤‘ë³µ ê²€ì‚¬ ì‹œì‘...");
    // ì—¬ê¸°ì„œ ë©ˆì¶œ í™•ë¥ ì´ ë†’ìŒ (DB ì¡°íšŒ)
    const existingUser = await User.findOne({ username });
    console.log("3. ì¤‘ë³µ ê²€ì‚¬ í†µê³¼ (ê²°ê³¼):", existingUser);

    if (existingUser) {
      console.log("âŒ ì¤‘ë³µëœ ìœ ì €ì„");
      return res.status(400).json({ message: "ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì•„ì´ë””ì…ë‹ˆë‹¤." });
    }

    console.log("4. ìœ ì € ê°ì²´ ìƒì„± ì¤‘...");
    const newUser = new User({ username, password, nickname });

    console.log("5. DB ì €ì¥ ì‹œë„...");
    // ë˜ëŠ” ì—¬ê¸°ì„œ ë©ˆì¶œ ìˆ˜ ìˆìŒ (DB ì“°ê¸°)
    await newUser.save();
    console.log("6. DB ì €ì¥ ì™„ë£Œ!");

    res.status(201).json({ message: "ê°€ì… ì‹ ì²­ ì™„ë£Œ!" });
  } catch (err) {
    console.error("ğŸ”¥ ì—ëŸ¬ ë°œìƒ:", err);
    res.status(500).json({ error: err.message });
  }
});

// 2. ë¡œê·¸ì¸
router.post("/login", async (req, res) => {
  try {
    const { username, password } = req.body;
    const user = await User.findOne({ username });

    // 1. ê³„ì • í™•ì¸
    if (!user || user.password !== password) {
      return res
        .status(400)
        .json({ message: "ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤." });
    }

    // 2. ìŠ¹ì¸ ì—¬ë¶€ í™•ì¸
    if (user.isApproved === false) {
      return res
        .status(403)
        .json({ message: "ì•„ì§ ìŠ¹ì¸ë˜ì§€ ì•Šì€ ê³„ì •ì…ë‹ˆë‹¤." });
    }

    // â˜… 3. [ë³µêµ¬ ë° ìˆ˜ì •] ì„¸ì…˜ ì €ì¥ (Redisì— ì €ì¥ë©ë‹ˆë‹¤)
    req.session.user = {
      id: user._id,
      username: user.username,
      nickname: user.nickname,
      role: user.role, // "admin" í˜¹ì€ "user"
    };

    // â˜… ì„¸ì…˜ì„ ëª…ì‹œì ìœ¼ë¡œ ì €ì¥ í›„ ì‘ë‹µì„ ë³´ëƒ…ë‹ˆë‹¤.
    req.session.save((err) => {
      if (err) {
        console.error("ì„¸ì…˜ ì €ì¥ ì‹¤íŒ¨:", err);
        return res.status(500).json({ message: "ì„¸ì…˜ ì €ì¥ ì˜¤ë¥˜" });
      }

      console.log(`âœ… ${user.username} ë¡œê·¸ì¸ ë° ì„¸ì…˜ ì €ì¥ ì™„ë£Œ`);

      // 4. ì‘ë‹µ ë³´ë‚´ê¸°
      res.status(200).json({
        message: "ë¡œê·¸ì¸ ì„±ê³µ",
        user: req.session.user,
      });
    });
  } catch (err) {
    console.error("ë¡œê·¸ì¸ ì—ëŸ¬:", err);
    res.status(500).json({ error: err.message });
  }
});

// 3. (ê´€ë¦¬ììš©) ëŒ€ê¸° ëª©ë¡ ì¡°íšŒ
router.get("/admin/pending", async (req, res) => {
  try {
    const users = await User.find({ isApproved: false });
    res.json(users);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 4. (ê´€ë¦¬ììš©) ìŠ¹ì¸ ì²˜ë¦¬ - ID ê¸°ë°˜ìœ¼ë¡œ ìˆ˜ì • ë° ê¶Œí•œ ë¶€ì—¬
router.post("/admin/approve", async (req, res) => {
  try {
    const { userId } = req.body; // í”„ë¡ íŠ¸ì—”ë“œì—ì„œ ë„˜ê²¨ì£¼ëŠ” ë°ì´í„° ì´ë¦„ í™•ì¸

    console.log("ìŠ¹ì¸ ìš”ì²­ ID:", userId); // ì„œë²„ í„°ë¯¸ë„ì— IDê°€ ì˜ ì°íˆëŠ”ì§€ í™•ì¸ìš©

    if (!userId) {
      return res.status(400).json({ message: "userIdê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤." });
    }

    // [ìˆ˜ì •] findOneAndUpdateë¥¼ ì‚¬ìš©í•˜ì—¬ ë” ìœ ì—°í•˜ê²Œ ë§¤ì¹­
    const updatedUser = await User.findOneAndUpdate(
      { _id: userId },
      { $set: { isApproved: true, role: "user" } },
      { new: true }
    );

    if (!updatedUser) {
      return res.status(404).json({ message: "í•´ë‹¹ ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    console.log(`âœ… ${updatedUser.username} ìŠ¹ì¸ ì™„ë£Œ`);
    res.json({ message: `${updatedUser.username} ìŠ¹ì¸ ì™„ë£Œ` });
  } catch (err) {
    console.error("ğŸ”¥ ì„œë²„ ìŠ¹ì¸ ë¡œì§ ì—ëŸ¬:", err);
    res.status(500).json({ error: err.message });
  }
});

// 5. (ê´€ë¦¬ììš©) ê°€ì… ê±°ì ˆ (ìœ ì € ì‚­ì œ)
router.post("/admin/reject", async (req, res) => {
  try {
    const { userId } = req.body;
    await User.findByIdAndDelete(userId);
    res.json({ message: "ê°€ì… ì‹ ì²­ì´ ê±°ì ˆ ë° ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤." });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ API
router.get("/admin/check", (req, res) => {
  if (req.session.user && req.session.user.role === "admin") {
    res.json({ isAdmin: true });
  } else {
    res.json({ isAdmin: false });
  }
});

// [ì¶”ê°€] ì „ì²´ íšŒì› ëª©ë¡ ì¡°íšŒ (ì´ë¯¸ ìŠ¹ì¸ëœ ìœ ì €ë§Œ)
router.get("/admin/users", async (req, res) => {
  try {
    // isApprovedê°€ trueì¸ ìœ ì €ë§Œ ì°¾ê¸°
    const users = await User.find({ isApproved: true });
    res.json(users);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// [ì¶”ê°€] ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” (1234ë¡œ ì´ˆê¸°í™”)
router.post("/admin/reset-password", async (req, res) => {
  try {
    const { userId } = req.body;

    // ë³´ì•ˆì„ ìœ„í•´ ì‹¤ì œ ì„œë¹„ìŠ¤ ì‹œì—ëŠ” ì•”í˜¸í™”(bcrypt ë“±)ë¥¼ ê¶Œì¥í•˜ì§€ë§Œ,
    // í˜„ì¬ êµ¬ì¡°ì— ë§ì¶° í‰ë¬¸ ë˜ëŠ” ê¸°ì¡´ ë°©ì‹ëŒ€ë¡œ ì €ì¥í•©ë‹ˆë‹¤.
    const user = await User.findByIdAndUpdate(
      userId,
      { password: "1234" },
      { new: true }
    );

    if (!user) {
      return res.status(404).json({ message: "ìœ ì €ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });
    }

    res.json({
      message: `${user.username}ë‹˜ì˜ ë¹„ë°€ë²ˆí˜¸ê°€ '1234'ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`,
    });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

module.exports = router;


// --- END OF FILE: routes\auth.js ---


// ==========================================
// [20/24] FILE: routes\caleandar.js
// ==========================================

const express = require("express");
const router = express.Router();
const Event = require("../models/Event");
const Item = require("../models/Item");
const redisClient = require("../config/redis");

// 1. ì¼ì • ì¡°íšŒ (ë‹¬ë ¥ ë¡œë”©ìš©)
router.get("/", async (req, res) => {
  try {
    const events = await Event.find();
    res.json(events);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 2. ì¼ì • ì¶”ê°€ (ì¬ê³  ì—°ë™ ë° ì†Œìˆ˜ì  ì²˜ë¦¬ í¬í•¨)
router.post("/", async (req, res) => {
  const { type, products, materials, start, username } = req.body;

  try {
    if (!products || products.length === 0 || !products[0].name) {
      return res
        .status(400)
        .json({ message: "ìœ íš¨í•œ í’ˆëª© ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤." });
    }

    const mainItem = products[0].name;
    const extraCount =
      products.length > 1 ? ` ì™¸ ${products.length - 1}ê±´` : "";
    const generatedTitle = `[${type}] ${mainItem}${extraCount}`;

    const combinedItems = [];
    // ì œí’ˆ ì²˜ë¦¬
    products.forEach((p) => {
      combinedItems.push({
        name: p.name.trim(),
        size: p.size ? p.size.toString().trim() : "-",
        length: p.length ? p.length.toString().trim() : "-",
        quantity: parseFloat(Number(p.quantity).toFixed(1)), // ì†Œìˆ˜ì  í•œìë¦¬ ê³ ì •
        role: "product",
      });
    });

    // ì›ìì¬ ì²˜ë¦¬
    if (type === "ìƒì‚°" && materials) {
      materials.forEach((m) => {
        combinedItems.push({
          name: m.name.trim(),
          size: m.size ? m.size.toString().trim() : "-",
          length: m.length ? m.length.toString().trim() : "-",
          quantity: parseFloat(Number(m.quantity).toFixed(1)),
          role: "material",
        });
      });
    }

    const newEvent = new Event({
      title: generatedTitle,
      start,
      type,
      items: combinedItems,
      createdBy: username,
    });
    await newEvent.save();

    // ì¬ê³  ì—°ë™ ë¡œì§
    for (const item of combinedItems) {
      if (item.quantity === 0) continue;

      let amount = 0;
      if (item.role === "product") {
        amount =
          type === "ì…ê³ " || type === "ìƒì‚°" ? item.quantity : -item.quantity;
      } else {
        amount = -item.quantity;
      }

      // [ìˆ˜ì •] ë¶€ë™ ì†Œìˆ˜ì  ì˜¤ì°¨ ë°©ì§€ë¥¼ ìœ„í•´ ê¸°ì¡´ ìˆ˜ëŸ‰ì„ ê°€ì ¸ì™€ì„œ ê³„ì‚° í›„ ì €ì¥
      const targetItem = await Item.findOne({
        name: item.name,
        size: item.size,
        length: item.length,
      });
      if (targetItem) {
        targetItem.quantity = parseFloat(
          (targetItem.quantity + amount).toFixed(1)
        );
        targetItem.lastUpdatedBy = username;
        targetItem.updatedAt = Date.now();
        await targetItem.save();
      } else {
        await Item.create({
          name: item.name,
          size: item.size,
          length: item.length,
          quantity: parseFloat(item.quantity.toFixed(1)),
          lastUpdatedBy: username,
          updatedAt: Date.now(),
        });
      }
    }

    await redisClient.del("cache:inventory");
    res.status(201).json(newEvent);
  } catch (err) {
    console.error("ì €ì¥ ì—ëŸ¬:", err);
    res.status(500).json({ message: "ì„œë²„ ì €ì¥ ì˜¤ë¥˜: " + err.message });
  }
});

// 3. ì¼ì • ìˆ˜ì • (PUT) - ê¸°ì¡´ ì¬ê³  ë³µêµ¬ í›„ ìƒˆ ë°ì´í„° ë°˜ì˜
router.put("/:id", async (req, res) => {
  try {
    const oldEvent = await Event.findById(req.params.id);
    if (!oldEvent)
      return res.status(404).json({ message: "ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });

    // [A] ê¸°ì¡´ ì¬ê³  ì›ìƒë³µêµ¬ (ì—­ê³„ì‚°)
    for (const item of oldEvent.items) {
      let restoreAmount = 0;
      if (item.role === "product") {
        restoreAmount =
          oldEvent.type === "ì…ê³ " || oldEvent.type === "ìƒì‚°"
            ? -item.quantity
            : item.quantity;
      } else {
        restoreAmount = item.quantity; // ì†Œëª¨ëë˜ ì›ìì¬ ë‹¤ì‹œ ì±„ì›Œì¤Œ
      }

      const target = await Item.findOne({
        name: item.name,
        size: item.size,
        length: item.length,
      });
      if (target) {
        target.quantity = parseFloat(
          (target.quantity + restoreAmount).toFixed(1)
        );
        await target.save();
      }
    }

    // [B] ìƒˆë¡œìš´ ë°ì´í„° ì •ê·œí™”
    const { type, products, materials, start, username } = req.body;
    const combinedItems = [];
    products.forEach((p) =>
      combinedItems.push({
        ...p,
        role: "product",
        quantity: parseFloat(Number(p.quantity).toFixed(1)),
      })
    );
    if (type === "ìƒì‚°" && materials) {
      materials.forEach((m) =>
        combinedItems.push({
          ...m,
          role: "material",
          quantity: parseFloat(Number(m.quantity).toFixed(1)),
        })
      );
    }

    const generatedTitle = `[${type}] ${combinedItems[0].name}${
      combinedItems.length > 1 ? " ì™¸ " + (combinedItems.length - 1) + "ê±´" : ""
    }`;

    // [C] ì¼ì • ë¬¸ì„œ ì—…ë°ì´íŠ¸
    const updatedEvent = await Event.findByIdAndUpdate(
      req.params.id,
      {
        title: generatedTitle,
        start,
        type,
        items: combinedItems,
        createdBy: username,
        updatedAt: Date.now(),
      },
      { new: true }
    );

    // [D] ìƒˆë¡œìš´ ì¬ê³  ìˆ˜ëŸ‰ ë°˜ì˜
    for (const item of combinedItems) {
      let amount =
        item.role === "product"
          ? type === "ì…ê³ " || type === "ìƒì‚°"
            ? item.quantity
            : -item.quantity
          : -item.quantity;

      const target = await Item.findOne({
        name: item.name,
        size: item.size,
        length: item.length,
      });
      if (target) {
        target.quantity = parseFloat((target.quantity + amount).toFixed(1));
        target.lastUpdatedBy = username;
        await target.save();
      } else {
        await Item.create({
          ...item,
          quantity: parseFloat(amount.toFixed(1)),
          lastUpdatedBy: username,
        });
      }
    }

    await redisClient.del("cache:inventory");
    res.json(updatedEvent);
  } catch (err) {
    console.error("ìˆ˜ì • ì—ëŸ¬:", err);
    res.status(500).json({ message: err.message });
  }
});

// 4. ì¼ì • ì‚­ì œ (ì¬ê³  ë³µêµ¬ í¬í•¨)
router.delete("/:id", async (req, res) => {
  try {
    const event = await Event.findById(req.params.id);
    if (!event)
      return res.status(404).json({ message: "ì¼ì •ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤." });

    for (const item of event.items) {
      let restoreAmount =
        item.role === "product"
          ? event.type === "ì…ê³ " || event.type === "ìƒì‚°"
            ? -item.quantity
            : item.quantity
          : item.quantity;

      const target = await Item.findOne({
        name: item.name,
        size: item.size,
        length: item.length,
      });
      if (target) {
        target.quantity = parseFloat(
          (target.quantity + restoreAmount).toFixed(1)
        );
        await target.save();
      }
    }

    await Event.findByIdAndDelete(req.params.id);
    await redisClient.del("cache:inventory");

    res.json({ message: "ì‚­ì œ ë° ì¬ê³  ë³µêµ¬ ì™„ë£Œ" });
  } catch (err) {
    res.status(500).json({ message: err.message });
  }
});

module.exports = router;


// --- END OF FILE: routes\caleandar.js ---


// ==========================================
// [21/24] FILE: routes\holidays.js
// ==========================================

const express = require("express");
const router = express.Router();
const axios = require("axios");
const client = require("../config/redis");

router.get("/:year", async (req, res) => {
  const year = req.params.year;
  // ë°ì´í„° êµ¬ì¡°ê°€ ë³€ê²½ë˜ì—ˆìœ¼ë¯€ë¡œ í‚¤ ì´ë¦„ì„ v2ë¡œ ì—…ë°ì´íŠ¸í•˜ì—¬ ì¶©ëŒì„ ë°©ì§€í•©ë‹ˆë‹¤.
  const redisKey = `holidays_v2:${year}`;

  const SERVICE_KEY = process.env.DATA_GO_KR_KEY;

  try {
    // 1. Redis ìºì‹œ í™•ì¸
    const cachedData = await client.get(redisKey);
    if (cachedData) {
      console.log(`ğŸš€ Redis ìºì‹œ ì‚¬ìš© (${year}ë…„)`);
      return res.json(JSON.parse(cachedData));
    }

    // 2. ê³µê³µë°ì´í„° API í˜¸ì¶œ
    const baseUrl =
      "http://apis.data.go.kr/B090041/openapi/service/SpcdeInfoService/getRestDeInfo";
    const fullUrl = `${baseUrl}?ServiceKey=${SERVICE_KEY}&solYear=${year}&_type=json&numOfRows=100`;

    console.log(`ğŸŒ ê³µê³µë°ì´í„° API í˜¸ì¶œ ì¤‘: ${year}ë…„`);
    const response = await axios.get(fullUrl);

    if (response.data.response?.header?.resultCode !== "00") {
      console.error(
        "âŒ API ì¸ì¦ ì‹¤íŒ¨:",
        response.data.response?.header?.resultMsg
      );
      return res.status(401).json({ error: "ì¸ì¦ ì‹¤íŒ¨" });
    }

    const items = response.data.response.body.items?.item;
    const holidayList = Array.isArray(items) ? items : items ? [items] : [];

    // ë‚ ì§œì™€ ì´ë¦„ì„ ëª¨ë‘ í¬í•¨í•œ ê°ì²´ ë°°ì—´ ìƒì„±
    const formattedHolidays = holidayList.map((item) => {
      const date = String(item.locdate);
      return {
        date: `${date.substring(0, 4)}-${date.substring(4, 6)}-${date.substring(
          6,
          8
        )}`,
        name: item.dateName, // ê³µíœ´ì¼ ëª…ì¹­ (ì˜ˆ: ì‹ ì •, ì„¤ë‚ )
      };
    }); // ì´ ë¶€ë¶„ ê´„í˜¸ê°€ ëˆ„ë½ë˜ì–´ ìˆ˜ì •í–ˆìŠµë‹ˆë‹¤.

    // 3. Redis ì €ì¥ (30ì¼ ìœ ì§€)
    if (formattedHolidays.length > 0) {
      await client.setEx(redisKey, 2592000, JSON.stringify(formattedHolidays));
    }

    res.json(formattedHolidays);
  } catch (error) {
    console.error(`${year}ë…„ ê³µíœ´ì¼ ì²˜ë¦¬ ì¤‘ ì—ëŸ¬:`, error.message);
    res.status(500).json([]);
  }
});

module.exports = router;


// --- END OF FILE: routes\holidays.js ---


// ==========================================
// [22/24] FILE: routes\inventory.js
// ==========================================

const express = require("express");
const router = express.Router();
const Item = require("../models/Item");
const Event = require("../models/Event");
const redisClient = require("../config/redis");

const CACHE_KEY = "cache:inventory";

// 1. ì¬ê³  ëª©ë¡ ì¡°íšŒ (Redis ìš°ì„ )
router.get("/", async (req, res) => {
  try {
    let cachedData = await redisClient.get(CACHE_KEY);
    if (cachedData) {
      try {
        const parsed = JSON.parse(cachedData);
        console.log("âš¡ Redis ìºì‹œ ì¡°íšŒ ì„±ê³µ");
        return res.json(parsed);
      } catch (parseErr) {
        console.error("âŒ ìºì‹œ ë°ì´í„° íŒŒì‹± ì—ëŸ¬");
      }
    }
    const items = await Item.find().sort({ updatedAt: -1 });
    await redisClient.set(CACHE_KEY, JSON.stringify(items));
    res.json(items);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 2. ì¬ê³  ì¶”ê°€
router.post("/", async (req, res) => {
  try {
    const { name, size, length, quantity, category, username } = req.body;
    const newItem = new Item({
      name: name.trim(),
      size: size ? size.toString().trim() : "-",
      length: length ? length.toString().trim() : "-",
      quantity,
      category,
      lastUpdatedBy: username,
    });
    await newItem.save();
    await redisClient.del(CACHE_KEY);
    res.status(201).json({ message: "ë“±ë¡ë¨", item: newItem });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 3. ìˆ˜ì • (ìˆ˜ëŸ‰ ì—…ë°ì´íŠ¸)
router.put("/:id", async (req, res) => {
  try {
    const { quantity, username } = req.body;
    const updatedItem = await Item.findByIdAndUpdate(
      req.params.id,
      { quantity, lastUpdatedBy: username, updatedAt: Date.now() },
      { new: true }
    );
    await redisClient.del(CACHE_KEY);
    res.json({ message: "ìˆ˜ì •ë¨", item: updatedItem });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 4. ì‚­ì œ
router.delete("/:id", async (req, res) => {
  try {
    await Item.findByIdAndDelete(req.params.id);
    await redisClient.del(CACHE_KEY);
    res.json({ message: "ì‚­ì œë¨" });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 5. ìƒì‚° ê¸°ë¡ ë“±ë¡ (í•µì‹¬ ìˆ˜ì • ë¶€ë¶„)
router.post("/produce", async (req, res) => {
  try {
    const {
      materialId,
      materialName,
      category,
      width,
      size,
      quantity,
      tubeName,
    } = req.body;
    const nickname = req.session.user ? req.session.user.nickname : "ì‘ì—…ì";
    const today = new Date().toISOString().split("T")[0]; // YYYY-MM-DD

    // 1. ê¸°ì´ˆ ë°ì´í„° ì¤€ë¹„
    const rawMaterial = await Item.findById(materialId);
    if (!rawMaterial) throw new Error("ì›ìì¬ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

    const productName = rawMaterial.name; // ì™„ì œí’ˆ ì´ë¦„ (ì˜ˆ: íˆ¬ëª…(38))
    const productSize = width;
    const productLength = size;
    const TUBE_NAME = tubeName || "ì¢…ì´ì§€ê´€(6)";
    const TUBE_SIZE = "1560";

    // 2. ì‹¤ì œ ì¬ê³  ë°˜ì˜ (DB ì—°ì‚°)
    await Item.findByIdAndUpdate(materialId, { $inc: { quantity: -1 } });
    await Item.findOneAndUpdate(
      { name: productName, size: productSize, length: productLength },
      {
        $inc: { quantity: quantity },
        $set: {
          category: "ì™„ì œí’ˆ",
          updatedAt: Date.now(),
          lastUpdatedBy: nickname,
        },
      },
      { upsert: true }
    );
    await Item.findOneAndUpdate(
      { name: TUBE_NAME, size: TUBE_SIZE },
      { $inc: { quantity: -quantity } }
    );

    // 3. í†µí•© ì¼ì •(Event) ì²˜ë¦¬ (ê·¸ë‚ ì˜ ì²« ìƒì‚° ì¼ì • ì°¾ê¸°)
    let existingEvent = await Event.findOne({
      start: {
        $gte: new Date(today),
        $lt: new Date(new Date(today).getTime() + 24 * 60 * 60 * 1000),
      },
      type: "ìƒì‚°",
    });

    if (existingEvent) {
      // --- í†µí•© í•©ì‚° ë¡œì§ ---
      let hasProduct = false;
      let hasMaterial = false;
      let hasTube = false;

      existingEvent.items.forEach((item) => {
        // ë™ì¼í•œ ì™„ì œí’ˆ(ì´ë¦„/í­/ê¸¸ì´ ì¼ì¹˜)ì´ ì´ë¯¸ ëª©ë¡ì— ìˆìœ¼ë©´ ìˆ˜ëŸ‰ í•©ì‚°
        if (
          item.role === "product" &&
          item.name === productName &&
          item.size === productSize &&
          item.length === productLength
        ) {
          item.quantity += quantity;
          hasProduct = true;
        }
        // ë™ì¼í•œ ì›ë‹¨ì´ ì´ë¯¸ ëª©ë¡ì— ìˆìœ¼ë©´ í•©ì‚°
        else if (item.role === "material" && item.name === rawMaterial.name) {
          item.quantity += 1;
          hasMaterial = true;
        }
        // ë™ì¼í•œ ì§€ê´€ì´ ì´ë¯¸ ëª©ë¡ì— ìˆìœ¼ë©´ í•©ì‚°
        else if (item.role === "material" && item.name === TUBE_NAME) {
          item.quantity += quantity;
          hasTube = true;
        }
      });

      // ëª©ë¡ì— ì—†ëŠ” ìƒˆë¡œìš´ í•­ëª©ë“¤ì´ë©´ push
      if (!hasProduct) {
        existingEvent.items.push({
          name: productName,
          size: productSize,
          length: productLength,
          quantity: quantity,
          role: "product",
        });
      }
      if (!hasMaterial) {
        existingEvent.items.push({
          name: rawMaterial.name,
          size: rawMaterial.size || "-",
          length: rawMaterial.length || "-",
          quantity: 1,
          role: "material",
        });
      }
      if (!hasTube) {
        existingEvent.items.push({
          name: TUBE_NAME,
          size: TUBE_SIZE,
          length: "-",
          quantity: quantity,
          role: "material",
        });
      }

      // ì œëª© ì—…ë°ì´íŠ¸ (ì²« í’ˆëª© ì´ë¦„ ì™¸ Xê±´)
      const prodItems = existingEvent.items.filter((i) => i.role === "product");
      existingEvent.title = `[ìƒì‚°] ${prodItems[0].name}${
        prodItems.length > 1 ? " ì™¸ " + (prodItems.length - 1) + "ê±´" : ""
      }`;

      existingEvent.markModified("items");
      await existingEvent.save();
    } else {
      // --- ê·¸ë‚ ì˜ ì²« ìƒì‚° ê¸°ë¡ ìƒì„± ---
      const newEvent = new Event({
        title: `[ìƒì‚°] ${productName} ${productSize}/${productLength}m - ${quantity}ê°œ`,
        start: new Date(today),
        type: "ìƒì‚°",
        items: [
          {
            name: productName,
            size: productSize,
            length: productLength,
            quantity: quantity,
            role: "product",
          },
          {
            name: rawMaterial.name,
            size: rawMaterial.size || "-",
            length: rawMaterial.length || "-",
            quantity: 1,
            role: "material",
          },
          {
            name: TUBE_NAME,
            size: TUBE_SIZE,
            length: "-",
            quantity: quantity,
            role: "material",
          },
        ],
        createdBy: nickname,
      });
      await newEvent.save();
    }

    await redisClient.del("cache:inventory");
    res.json({ success: true });
  } catch (err) {
    console.error("âŒ í†µí•© ìƒì‚° ê¸°ë¡ ì—ëŸ¬:", err);
    res.status(500).json({ error: err.message });
  }
});

module.exports = router;


// --- END OF FILE: routes\inventory.js ---


// ==========================================
// [23/24] FILE: routes\options.js
// ==========================================

const express = require("express");
const router = express.Router();
const Option = require("../models/Option");
const redisClient = require("../config/redis"); // â˜… Redis ì¶”ê°€

const OPTIONS_CACHE_KEY = "cache:options"; // ì˜µì…˜ ì „ìš© ìºì‹œ í‚¤

// 1. ëª¨ë“  ì˜µì…˜ ì¡°íšŒ (ì¼ë°˜ ìœ ì €/ê´€ë¦¬ì ê³µìš©)
router.get("/", async (req, res) => {
  try {
    // Redis í™•ì¸
    let cachedOptions = await redisClient.get(OPTIONS_CACHE_KEY);

    if (cachedOptions) {
      console.log("âš¡ Redisì—ì„œ ì˜µì…˜ ë¦¬ìŠ¤íŠ¸ ë°˜í™˜");
      return res.json(JSON.parse(cachedOptions));
    }

    // ìºì‹œì— ì—†ìœ¼ë©´ DBì—ì„œ ê°€ì ¸ì˜¤ê¸°
    console.log("ğŸ¢ ìºì‹œ ì—†ìŒ: DBì—ì„œ ì˜µì…˜ ì§ì ‘ ì¡°íšŒ");
    const options = await Option.find();

    // ë‹¤ìŒì„ ìœ„í•´ ìºì‹œì— ì €ì¥
    await redisClient.set(OPTIONS_CACHE_KEY, JSON.stringify(options));

    res.json(options);
  } catch (err) {
    console.error("ì˜µì…˜ ì¡°íšŒ ì—ëŸ¬:", err);
    res.status(500).json({ error: err.message });
  }
});

// 2. ì˜µì…˜ ì¶”ê°€ (ê´€ë¦¬ììš© - ì„¸ì…˜ ì²´í¬ëŠ” server.jsì—ì„œ ìˆ˜í–‰)
router.post("/", async (req, res) => {
  try {
    const { type, value } = req.body;
    const exists = await Option.findOne({ type, value });
    if (exists) return res.status(400).json({ message: "ì´ë¯¸ ì¡´ì¬í•¨" });

    const newOption = new Option({ type, value });
    await newOption.save();

    // â˜… ê´€ë¦¬ìê°€ ì¶”ê°€í•˜ë©´ ì¦‰ì‹œ ìºì‹œ ì‚­ì œ (ë‹¤ìŒ ì¡°íšŒ ë•Œ ê°±ì‹ ë˜ë„ë¡)
    await redisClient.del(OPTIONS_CACHE_KEY);
    console.log("â™»ï¸ ì˜µì…˜ ì—…ë°ì´íŠ¸: ìºì‹œ ì‚­ì œë¨");

    res.status(201).json(newOption);
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

// 3. ì˜µì…˜ ì‚­ì œ (ê´€ë¦¬ììš©)
router.delete("/:id", async (req, res) => {
  try {
    await Option.findByIdAndDelete(req.params.id);

    // â˜… ì¤‘ìš”: ì˜µì…˜ì´ ì‚­ì œë˜ì—ˆìœ¼ë¯€ë¡œ ê¸°ì¡´ ìºì‹œ ì‚­ì œ
    await redisClient.del(OPTIONS_CACHE_KEY);
    console.log("â™»ï¸ ì˜µì…˜ ì‚­ì œë¡œ ì¸í•œ ìºì‹œ ì´ˆê¸°í™”");

    res.json({ message: "ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤." });
  } catch (err) {
    res.status(500).json({ error: err.message });
  }
});

module.exports = router;


// --- END OF FILE: routes\options.js ---


// ==========================================
// [24/24] FILE: server.js
// ==========================================

const express = require("express");
const http = require("http");
const dotenv = require("dotenv");
const mongoose = require("mongoose");
const cors = require("cors");
const authRoutes = require("./routes/auth");
const inventoryRoutes = require("./routes/inventory");
const calendarRoutes = require("./routes/caleandar");
const optionRoutes = require("./routes/options");

const session = require("express-session");
const { RedisStore } = require("connect-redis");
const redisClient = require("./config/redis");

const holidayRoutes = require(`./routes/holidays`);

const attendanceRoutes = require(`./routes/attendance`);

dotenv.config();

// 1. ì•± ì´ˆê¸°í™”
const app = express();
const server = http.createServer(app);

app.set("trust proxy", 1);

// 2. ë¯¸ë“¤ì›¨ì–´ ì„¤ì •
app.use(cors());
app.use(express.json());
app.use(express.urlencoded({ extended: true }));
app.use(express.static("public"));

// 3. ëª½ê³ DB ì—°ê²°
mongoose
  .connect(process.env.MONGO_URI)
  .then(() => console.log("âœ… MongoDB ì—°ê²° ì„±ê³µ!"))
  .catch((err) => console.error("âŒ MongoDB ì—°ê²° ì‹¤íŒ¨:", err));

// 4. ì„¸ì…˜ ì„¤ì • (ë¼ìš°í„° ì—°ê²°ë³´ë‹¤ ë¨¼ì € ì™€ì•¼ í•¨)
app.use(
  session({
    store: new RedisStore({
      client: redisClient,
      prefix: "session:",
    }),
    secret: "my-super-secret-key-reset",
    resave: false,
    saveUninitialized: false,
    cookie: {
      secure: false,
      httpOnly: true,
      maxAge: 1000 * 60 * 60 * 24,
      sameSite: "lax",
    },
  })
);

// --- ê¶Œí•œ ì²´í¬ ë¯¸ë“¤ì›¨ì–´ ë¶„ë¦¬ ---

// [A] ë¡œê·¸ì¸ ì—¬ë¶€ë§Œ ì²´í¬ (ì¼ë°˜ ìœ ì €/ê´€ë¦¬ì ëª¨ë‘ í†µê³¼)
const checkLogin = (req, res, next) => {
  if (!req.session || !req.session.user) {
    console.log(">> íƒˆë½: ë¡œê·¸ì¸ ì•ˆë¨");
    return res.send(
      '<script>alert("ë¡œê·¸ì¸í•˜ì„¸ìš”"); location.href="/login";</script>'
    );
  }
  next();
};

// [B] ê´€ë¦¬ì ê¶Œí•œê¹Œì§€ ì²´í¬ (ê´€ë¦¬ìë§Œ í†µê³¼)
const checkAdmin = (req, res, next) => {
  // ë¨¼ì € ë¡œê·¸ì¸ì´ ë˜ì–´ìˆëŠ”ì§€ í™•ì¸
  if (!req.session || !req.session.user) {
    return res.send(
      '<script>alert("ë¡œê·¸ì¸í•˜ì„¸ìš”"); location.href="/login";</script>'
    );
  }
  // ê´€ë¦¬ìì¸ì§€ í™•ì¸
  if (req.session.user.role !== "admin") {
    console.log(`>> íƒˆë½: ê´€ë¦¬ì ì•„ë‹˜ (í˜„ì¬ ì—­í• : ${req.session.user.role})`);
    return res
      .status(403)
      .send(
        '<script>alert("ê´€ë¦¬ìë§Œ ì ‘ê·¼ ê°€ëŠ¥í•©ë‹ˆë‹¤."); location.href="/";</script>'
      );
  }
  next();
};

app.get("/ping", (req, res) => {
  res.status(200).send("pong");
});

// 5. ë¼ìš°í„° ì—°ê²° (ê¶Œí•œ ë¯¸ë“¤ì›¨ì–´ ì ìš©)
app.use("/api", authRoutes); // ë¡œê·¸ì¸/íšŒì›ê°€ì…ì€ ì²´í¬ ì•ˆí•¨
app.use("/api/inventory", checkLogin, inventoryRoutes); // ì¬ê³ ëŠ” ë¡œê·¸ì¸í•´ì•¼ í•¨
app.use("/api/calendar", checkLogin, calendarRoutes); // ë‹¬ë ¥ì€ ë¡œê·¸ì¸ë§Œ í•˜ë©´ ë¨
app.use(
  "/api/options",
  (req, res, next) => {
    // GET(ì¡°íšŒ)ì€ ëˆ„êµ¬ë‚˜ ê°€ëŠ¥, POST/DELETE(ìˆ˜ì •)ëŠ” ê´€ë¦¬ìë§Œ ê°€ëŠ¥í•˜ê²Œ ë¶„ë¦¬
    if (req.method === "GET") {
      return next(); // ì¡°íšŒëŠ” checkAdmin ê±´ë„ˆëœ€
    }
    checkAdmin(req, res, next); // ê·¸ ì™¸ì—” ê´€ë¦¬ì ì²´í¬
  },
  optionRoutes
); // ì˜µì…˜ì€ ê´€ë¦¬ìë§Œ!

app.use(`/api/holidays`, holidayRoutes);

app.use("/api/attendance", checkLogin, attendanceRoutes);

const Item = require("./models/Item");

// 6. ì„œë²„ ì‹œì‘
const PORT = process.env.PORT || 3000;

server.listen(PORT, async () => {
  console.log(`ğŸš€ ì„œë²„ ì‹¤í–‰ ì¤‘: http://localhost:${PORT}`);
  try {
    if (!redisClient.isOpen) await redisClient.connect();

    // 1. [ì„ì‹œ ì¶”ê°€] ê¸°ì¡´ DBì˜ ì§€ì €ë¶„í•œ ì†Œìˆ˜ì  ë°ì´í„° ì¼ê´„ ì •ì œ
    const Item = require("./models/Item");
    const allItems = await Item.find({});

    console.log("ğŸ” ì†Œìˆ˜ì  ë°ì´í„° ì •ì œ ì‹œì‘...");
    for (const item of allItems) {
      // ì†Œìˆ˜ì  í•œ ìë¦¬ë¡œ ë°˜ì˜¬ë¦¼ (7.7999 -> 7.8)
      const cleanedQty = parseFloat(item.quantity.toFixed(1));

      // ê¸°ì¡´ ìˆ˜ëŸ‰ê³¼ ì •ì œëœ ìˆ˜ëŸ‰ì´ ë‹¤ë¥¼ ë•Œë§Œ ì—…ë°ì´íŠ¸
      if (item.quantity !== cleanedQty) {
        await Item.updateOne(
          { _id: item._id },
          { $set: { quantity: cleanedQty } }
        );
        console.log(
          `âœ… ì •ì œë¨: ${item.name} (${item.quantity} -> ${cleanedQty})`
        );
      }
    }
    console.log("âœ¨ ëª¨ë“  ì¬ê³  ë°ì´í„° ì •ì œ ì™„ë£Œ");

    // 2. ìºì‹œ ì´ˆê¸°í™” ë° ì˜ˆì—´
    await redisClient.del("cache:inventory");
    await redisClient.del("cache:options");

    const items = await Item.find().sort({ updatedAt: -1 });
    await redisClient.set("cache:inventory", JSON.stringify(items));

    const Option = require("./models/Option");
    const options = await Option.find();
    await redisClient.set("cache:options", JSON.stringify(options));

    console.log(
      `ğŸ”¥ ë°ì´í„° ì˜ˆì—´ ì™„ë£Œ: ì¬ê³  ${items.length}ê°œ, ì˜µì…˜ ${options.length}ê°œ`
    );
  } catch (e) {
    console.error("ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:", e);
  }
});


// --- END OF FILE: server.js ---
