<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì í˜ì´ì§€</title>
    <style>
        body { padding: 15px; font-family: sans-serif; max-width: 1000px; margin: 0 auto; background-color: #f9f9f9; }
        h1 { font-size: 1.6rem; color: #333; }
        .nav-links { margin-bottom: 20px; font-size: 14px; }
        .section { background: white; margin-bottom: 25px; border: 1px solid #ddd; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h2 { margin-top: 0; border-bottom: 2px solid #333; padding-bottom: 10px; font-size: 1.2rem; }
        h3 { font-size: 1rem; margin-bottom: 10px; color: #555; }
        
        /* ê¸°ì´ˆ ë°ì´í„° ê´€ë¦¬ ê·¸ë¦¬ë“œ */
        .option-grid { display: grid; grid-template-columns: 1fr; gap: 20px; }
        @media (min-width: 768px) { .option-grid { grid-template-columns: repeat(3, 1fr); } }

        .input-group { display: flex; gap: 5px; margin-bottom: 15px; }
        input { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 15px; }
        button { padding: 10px 15px; cursor: pointer; border-radius: 6px; border: none; background: #333; color: white; font-weight: bold; }
        
        .tag-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .tag { background: #eee; padding: 6px 12px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .tag button { background: #ff4444; color: white; width: 18px; height: 18px; padding: 0; line-height: 18px; font-size: 10px; border-radius: 50%; }

        /* í…Œì´ë¸” ìŠ¤í¬ë¡¤ */
        .table-wrapper { overflow-x: auto; margin-top: 10px; }
        table { width: 100%; border-collapse: collapse; min-width: 500px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; font-size: 14px; }
        th { background: #f2f2f2; }
        .btn-approve { background: #4CAF50; color: white; padding: 8px 12px; }
        .btn-ban { background: #F44336; color: white; padding: 8px 12px; }
    </style>
</head>
<body>
    <h1>ğŸ›¡ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <div class="nav-links">
        <a href="/inventory.html">ğŸ“¦ ì¬ê³ ê´€ë¦¬</a> | 
        <a href="/calendar.html">ğŸ“… ë‹¬ë ¥ë³´ê¸°</a>
    </div>

    <div class="section">
        <h2>âš™ï¸ ê¸°ì´ˆ ë°ì´í„° ê´€ë¦¬</h2>
        <div class="option-grid">
            <div>
                <h3>í’ˆëª©ëª… (Item Name)</h3>
                <div class="input-group">
                    <input type="text" id="new-item" placeholder="ì¶”ê°€">
                    <button onclick="addOption('itemName', 'new-item')">ì¶”ê°€</button>
                </div>
                <div id="list-itemName" class="tag-container"></div>
            </div>

            <div>
                <h3>ì‚¬ì´ì¦ˆ (Size)</h3>
                <div class="input-group">
                    <input type="text" id="new-size" placeholder="ì¶”ê°€">
                    <button onclick="addOption('size', 'new-size')">ì¶”ê°€</button>
                </div>
                <div id="list-size" class="tag-container"></div>
            </div>

            <div>
                <h3>ê¸¸ì´ (Length)</h3>
                <div class="input-group">
                    <input type="text" id="new-length" placeholder="ì¶”ê°€">
                    <button onclick="addOption('length', 'new-length')">ì¶”ê°€</button>
                </div>
                <div id="list-length" class="tag-container"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ‘¥ íšŒì› ê°€ì… ìŠ¹ì¸</h2>
        <button onclick="loadPendingUsers()" style="background:#2196F3; margin-bottom:15px;">ëª©ë¡ ìƒˆë¡œê³ ì¹¨</button>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr><th>ì•„ì´ë””</th><th>ë‹‰ë„¤ì„</th><th>ì‹ ì²­ì¼</th><th>ê´€ë¦¬</th></tr>
                </thead>
                <tbody id="user-list"></tbody>
            </table>
        </div>
    </div>

    <div class="section">
    <h2>ğŸ‘¥ ì „ì²´ íšŒì› ê´€ë¦¬</h2>
    <div class="table-wrapper">
        <table>
            <thead>
                <tr><th>ì•„ì´ë””</th><th>ë‹‰ë„¤ì„</th><th>ê¶Œí•œ</th><th>ê´€ë¦¬</th></tr>
            </thead>
            <tbody id="full-user-list"></tbody>
        </table>
    </div>
</div>

    <script>
        const API_OPT = '/api/options';
        const API_ADMIN = '/api/admin';

        window.onload = function() { loadOptions(); loadPendingUsers(); loadFullUsers();};

// ì „ì²´ íšŒì› ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
async function loadFullUsers() {
    try {
        const res = await fetch('/api/admin/users'); // server.js ì„¤ì •ì— ë”°ë¼ ì£¼ì†Œ í™•ì¸ í•„ìš”
        const users = await res.json();
        const list = document.getElementById('full-user-list');
        list.innerHTML = '';

        if (users.length === 0) {
            list.innerHTML = '<tr><td colspan="4">ë“±ë¡ëœ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
            return;
        }

        users.forEach(user => {
            list.innerHTML += `
                <tr>
                    <td>${user.username}</td>
                    <td>${user.nickname}</td>
                    <td>${user.role === 'admin' ? '<b>ê´€ë¦¬ì</b>' : 'ì¼ë°˜'}</td>
                    <td>
                        <button onclick="resetPassword('${user._id}')" style="background:#f59e0b;">PWì´ˆê¸°í™”</button>
                        <button class="btn-ban" onclick="banUser('${user._id}')">ê°•í‡´</button>
                    </td>
                </tr>`;
        });
    } catch (err) {
        console.error("íšŒì› ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", err);
    }
}

// ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™” í•¨ìˆ˜
async function resetPassword(id) {
    if (!confirm("ë¹„ë°€ë²ˆí˜¸ë¥¼ '1234'ë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
        const response = await fetch('/api/admin/reset-password', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: id })
        });

        const data = await response.json();
        if (response.ok) {
            alert(data.message);
        } else {
            alert("ì´ˆê¸°í™” ì‹¤íŒ¨: " + data.message);
        }
    } catch (err) {
        console.error("ì´ˆê¸°í™” ì—ëŸ¬:", err);
        alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
    }
}

        async function loadOptions() {
            const res = await fetch(API_OPT);
            const options = await res.json();
            document.getElementById('list-itemName').innerHTML = '';
            document.getElementById('list-size').innerHTML = '';
            document.getElementById('list-length').innerHTML = '';

            options.forEach(opt => {
                const tag = document.createElement('div');
                tag.className = 'tag';
                tag.innerHTML = `${opt.value} <button onclick="deleteOption('${opt._id}')">x</button>`;
                document.getElementById(`list-${opt.type}`).appendChild(tag);
            });
        }

        async function addOption(type, inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            if(!value) return;
            const res = await fetch(API_OPT, {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({ type, value })
            });
            if(res.ok) { input.value = ''; loadOptions(); }
        }

        async function deleteOption(id) {
            if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            await fetch(`${API_OPT}/${id}`, { method: 'DELETE' });
            loadOptions();
        }

        async function loadPendingUsers() {
    const res = await fetch(`${API_ADMIN}/pending`);
    const users = await res.json();
    const list = document.getElementById('user-list');
    list.innerHTML = '';
    
    if (users.length === 0) {
        list.innerHTML = '<tr><td colspan="4">ëŒ€ê¸° ì¤‘ì¸ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
        return;
    }

    users.forEach(user => {
        list.innerHTML += `
            <tr>
                <td>${user.username}</td>
                <td>${user.nickname}</td>
                <td>${new Date(user.createdAt).toLocaleDateString()}</td>
                <td>
                    <button class="btn-approve" onclick="approveUser('${user._id}')">ìŠ¹ì¸</button>
                    <button class="btn-ban" onclick="banUser('${user._id}')">ê±°ì ˆ</button>
                </td>
            </tr>`;
    });
}
        
        // admin.html ë‚´ ìŠ¹ì¸ í•¨ìˆ˜ ì˜ˆì‹œ
async function approveUser(id) { // ì—¬ê¸°ì„œ idëŠ” ìœ ì €ì˜ _id ê°’ì´ì–´ì•¼ í•©ë‹ˆë‹¤.
    if (!confirm("ìŠ¹ì¸í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    try {
        const response = await fetch('/api/admin/approve', { 
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: id }) // ì„œë²„ê°€ ê¸°ë‹¤ë¦¬ëŠ” 'userId'ì™€ ë§¤ì¹­
        });

        if (!response.ok) {
            // ì„œë²„ì—ì„œ ë³´ë‚¸ ì—ëŸ¬ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ê¸° ìœ„í•´ json íŒŒì‹±
            const errData = await response.json();
            throw new Error(errData.message || 'ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜');
        }

        const data = await response.json();
        alert(data.message);
        loadPendingUsers(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
        
    } catch (err) {
        console.error("ë„¤íŠ¸ì›Œí¬ ì—ëŸ¬:", err);
        alert(err.message);
    }
}

        async function banUser(id) {
    if(!confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        const res = await fetch(`/api/admin/reject`, { // ì£¼ì†Œ í™•ì¸!
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ userId: id }) // userIdë¡œ í†µì¼
        });
        
        if(res.ok) {
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadPendingUsers();
        }
    } catch (err) {
        console.error(err);
    }
}
    </script>
</body>
</html>