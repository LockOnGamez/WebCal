<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê´€ë¦¬ì ì„¤ì •</title>
    <link rel="stylesheet" href="css/themes.css">
    <style>
        body {
            padding: 20px;
            font-family: 'Pretendard', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            max-width: 1200px;
            margin: 0 auto;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-x: hidden;
        }

        h1 {
            font-size: 2.2rem;
            margin-bottom: 30px;
            font-weight: 900;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1.5px;
            border-bottom: 2px solid var(--card-border);
            padding-bottom: 15px;
            filter: drop-shadow(0 0 10px var(--highlight-glow));
        }

        .nav-links {
            margin-bottom: 30px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .nav-links a {
            color: var(--text-sub);
            text-decoration: none;
            transition: 0.3s;
            font-weight: 600;
            padding: 8px 15px;
            border-radius: 12px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
        }

        .nav-links a:hover {
            color: var(--highlight);
            border-color: var(--highlight);
            transform: translateY(-2px);
        }

        .theme-toggle {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--card-border);
            color: var(--text-main);
            width: 45px;
            height: 45px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.4rem;
            cursor: pointer;
            box-shadow: var(--card-shadow);
            transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .theme-toggle:hover {
            transform: scale(1.1) rotate(15deg);
        }

        .section {
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--card-border);
            margin-bottom: 30px;
            padding: 30px;
            border-radius: 28px;
            box-shadow: var(--card-shadow);
            transition: transform 0.3s ease;
        }

        .section:hover {
            transform: translateY(-5px);
        }

        h2 {
            margin-top: 0;
            color: var(--highlight);
            font-size: 1.5rem;
            margin-bottom: 25px;
            font-weight: 800;
        }

        h3 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--text-sub);
            font-weight: 600;
        }

        /* Grid */
        .option-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 25px;
        }

        @media (min-width: 768px) {
            .option-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .input-group {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        input {
            flex: 1;
            padding: 14px;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            color: var(--text-main);
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        input:focus {
            outline: none;
            border-color: var(--highlight);
            box-shadow: 0 0 0 4px var(--highlight-glow);
        }

        button {
            padding: 12px 20px;
            cursor: pointer;
            border-radius: 12px;
            border: none;
            background: var(--accent-gradient);
            color: white;
            font-weight: 800;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 4px 10px var(--highlight-glow);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px var(--highlight-glow);
        }

        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 15px;
        }

        .tag {
            background: var(--card-bg);
            padding: 8px 16px;
            border-radius: 25px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
        }

        .tag button {
            background: #ef4444;
            color: white;
            width: 22px;
            height: 22px;
            padding: 0;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            box-shadow: none;
        }

        /* Table */
        .table-wrapper {
            overflow-x: auto;
            margin-top: 20px;
            border-radius: 20px;
            border: 1px solid var(--card-border);
            box-shadow: var(--card-shadow);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            min-width: 700px;
            background: var(--card-bg);
        }

        th,
        td {
            border-bottom: 1px solid var(--card-border);
            padding: 18px;
            text-align: center;
            font-size: 15px;
            color: var(--text-main);
        }

        th {
            background: var(--highlight-glow);
            color: var(--text-main);
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .btn-approve {
            background: #10b981;
            box-shadow: 0 4px 10px rgba(16, 185, 129, 0.3);
        }

        .btn-ban {
            background: #ef4444;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }

        .btn-refresh {
            background: var(--highlight);
            box-shadow: 0 4px 10px var(--highlight-glow);
            margin-bottom: 20px;
        }

        /* ë°°ê²½ ì¥ì‹ */
        .bg-blob {
            position: fixed;
            width: 500px;
            height: 500px;
            background: var(--highlight-glow);
            filter: blur(120px);
            border-radius: 50%;
            z-index: -1;
            opacity: 0.2;
            display: none;
        }

        [data-theme="glass"] .bg-blob {
            display: block;
        }

        .blob-1 {
            top: -200px;
            left: -200px;
        }

        .blob-2 {
            bottom: -200px;
            right: -200px;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: var(--highlight);
        }

        input:checked+.slider:before {
            transform: translateX(26px);
        }
    </style>
</head>

<body class="animate-fade">
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>
    <h1>ğŸ›¡ï¸ ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</h1>
    <div class="nav-links">
        <button class="theme-toggle" onclick="toggleTheme()" id="theme-btn">ğŸŒ™</button>
        <a href="/inventory.html">ğŸ“¦ ì¬ê³ ê´€ë¦¬</a>
        <a href="/calendar.html">ğŸ“… ë‹¬ë ¥</a>
        <a href="/main.html">ğŸ  ë©”ì¸</a>
    </div>

    <div class="section">
        <h2>âš™ï¸ ê¸°ì´ˆ ë°ì´í„° ê´€ë¦¬</h2>
        <div class="option-grid">
            <div>
                <h3>í’ˆëª©ëª…</h3>
                <div class="input-group"><input type="text" id="new-item" placeholder="ì˜ˆ: íˆ¬ëª…"><button
                        onclick="addOption('itemName', 'new-item')">ì¶”ê°€</button></div>
                <div id="list-itemName" class="tag-container"></div>
            </div>
            <div>
                <h3>ì‚¬ì´ì¦ˆ</h3>
                <div class="input-group"><input type="text" id="new-size" placeholder="ì˜ˆ: 38"><button
                        onclick="addOption('size', 'new-size')">ì¶”ê°€</button></div>
                <div id="list-size" class="tag-container"></div>
            </div>
            <div>
                <h3>ê¸¸ì´</h3>
                <div class="input-group"><input type="text" id="new-length" placeholder="ì˜ˆ: 500"><button
                        onclick="addOption('length', 'new-length')">ì¶”ê°€</button></div>
                <div id="list-length" class="tag-container"></div>
            </div>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ‘‹ ê°€ì… ìŠ¹ì¸ ëŒ€ê¸°</h2>
        <button onclick="loadPendingUsers()" class="btn-refresh">ìƒˆë¡œê³ ì¹¨</button>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ë‹‰ë„¤ì„</th>
                        <th>ì‹ ì²­ì¼</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="user-list"></tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ‘¥ ì „ì²´ íšŒì›</h2>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>ë‹‰ë„¤ì„</th>
                        <th>ê¶Œí•œ</th>
                        <th>ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody id="full-user-list"></tbody>
            </table>
        </div>
    </div>

    <div class="section">
        <h2>ğŸ”” ì¬ê³  ë¶€ì¡± ì•Œë¦¼ ì„¤ì •</h2>
        <p style="font-size: 0.9rem; color: var(--text-sub); margin-bottom: 20px;">í’ˆëª©ë³„ ì•Œë¦¼ í™œì„±í™” ì—¬ë¶€ì™€ ì„ê³„ê°’ì„ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

        <h3 style="color:var(--highlight); margin-bottom:10px;">ğŸ“¦ ì™„ì œí’ˆ (Finished Goods)</h3>
        <div class="table-wrapper" style="margin-bottom:30px;">
            <table>
                <thead>
                    <tr>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th>í’ˆëª©ëª…</th>
                        <th>ê·œê²©</th>
                        <th>ì•Œë¦¼ On/Off</th>
                        <th>ì„ê³„ê°’(ë¯¸ë§Œ)</th>
                        <th>ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody id="item-alert-list-finished"></tbody>
            </table>
        </div>

        <h3 style="color:#10b981; margin-bottom:10px;">ğŸ—ï¸ ì›ìì¬ (Raw Materials)</h3>
        <div class="table-wrapper">
            <table>
                <thead>
                    <tr>
                        <th>ì¹´í…Œê³ ë¦¬</th>
                        <th>í’ˆëª©ëª…</th>
                        <th>ê·œê²©</th>
                        <th>ì•Œë¦¼ On/Off</th>
                        <th>ì„ê³„ê°’(ë¯¸ë§Œ)</th>
                        <th>ìƒíƒœ</th>
                    </tr>
                </thead>
                <tbody id="item-alert-list-raw"></tbody>
            </table>
        </div>
    </div>

    <!-- 5. ì‹œìŠ¤í…œ í™œë™ ë¡œê·¸ ë° ë°ì´í„° ê´€ë¦¬ -->
    <div
        style="display: grid; grid-template-columns: 1.5fr 1fr; gap: 30px; margin-top: 30px; padding: 0 40px 40px 40px;">
        <!-- í™œë™ ë¡œê·¸ -->
        <div class="card" style="margin-bottom: 0;">
            <h2 class="card-title">ğŸš¨ ì‹œìŠ¤í…œ í™œë™ ë¡œê·¸</h2>

            <!-- í•„í„° ì¹© ì¶”ê°€ -->
            <div id="log-filters"
                style="display: flex; gap: 8px; margin-bottom: 20px; overflow-x: auto; padding-bottom: 10px; scrollbar-width: none;">
                <button class="filter-chip active" onclick="filterLogs('ALL', this)">ì „ì²´</button>
                <button class="filter-chip" onclick="filterLogs('Auth', this)">ğŸ”“ ì ‘ì†/ê¶Œí•œ</button>
                <button class="filter-chip" onclick="filterLogs('Production', this)">ğŸ—ï¸ ìƒì‚°</button>
                <button class="filter-chip" onclick="filterLogs('Inventory', this)">ğŸ“¦ ì¬ê³ </button>
                <button class="filter-chip" onclick="filterLogs('Attendance', this)">â° ê·¼íƒœ</button>
            </div>

            <div id="log-list" style="max-height: 400px; overflow-y: auto; padding-right: 10px;">
                <div style="text-align:center; padding:50px; color:var(--text-sub);">ë¡œê·¸ ë¡œë“œ ì¤‘...</div>
            </div>
        </div>

        <!-- ë°ì´í„° ë°±ì—… ë° ë³µêµ¬ -->
        <div class="card" style="margin-bottom: 0;">
            <h2 class="card-title">ğŸ’¾ ì‹œìŠ¤í…œ ë°ì´í„° ê´€ë¦¬</h2>
            <div style="display: flex; flex-direction: column; gap: 20px;">
                <div>
                    <h4 style="margin: 0 0 10px 0; font-size: 0.95rem; color: var(--text-sub);">ì „ì²´ ë°ì´í„° ë°±ì—…</h4>
                    <p style="font-size: 0.85rem; margin-bottom: 15px; color:var(--text-sub);">í˜„ì¬ ëª¨ë“  ì •ë³´ë¥¼ JSON íŒŒì¼ë¡œ
                        ë‚´ë ¤ë°›ìŠµë‹ˆë‹¤.</p>
                    <button class="action-btn" onclick="exportData('full')" style="padding: 12px; font-size: 0.9rem;">ì „ì²´
                        ë°±ì—… ë‹¤ìš´ë¡œë“œ</button>
                </div>

                <hr style="border:0; border-top:1px solid var(--card-border);">

                <div>
                    <h4 style="margin: 0 0 10px 0; font-size: 0.95rem; color: var(--text-sub);">ê¸°ê°„ë³„ ê¸°ë¡ ì¶”ì¶œ</h4>
                    <div style="display: flex; gap: 10px; margin-bottom: 10px;">
                        <input type="date" id="export-start"
                            style="padding:8px; font-size:0.8rem; border-radius:8px; border:1px solid var(--card-border); background:var(--card-bg); color:var(--text-main);">
                        <input type="date" id="export-end"
                            style="padding:8px; font-size:0.8rem; border-radius:8px; border:1px solid var(--card-border); background:var(--card-bg); color:var(--text-main);">
                    </div>
                    <button class="action-btn" onclick="exportData('filtered')"
                        style="padding: 12px; font-size: 0.9rem; background: var(--text-main); color: var(--bg-color);">ê¸°ê°„
                        ê¸°ë¡ ì¶”ì¶œ</button>
                </div>

                <hr style="border:0; border-top:1px solid var(--card-border);">

                <div>
                    <h4 style="margin: 0 0 10px 0; font-size: 0.95rem; color: var(--text-sub);">ë°ì´í„° ë³µêµ¬ (Import)</h4>
                    <input type="file" id="import-file" style="margin-bottom: 10px; font-size: 0.8rem; width:100%;">
                    <button class="action-btn" onclick="importData()"
                        style="padding: 12px; font-size: 0.9rem; background: #ef4444;">íŒŒì¼ë¡œ ë³µì›í•˜ê¸°</button>
                    <p style="font-size: 0.75rem; color: #ef4444; margin-top: 5px;">* ì£¼ì˜: ê¸°ì¡´ ë°ì´í„°ê°€ ë®ì–´ì”Œì›Œì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const themes = ['light', 'dark', 'glass', 'street'];
        const themeIcons = { 'light': 'â˜€ï¸', 'dark': 'ğŸŒ™', 'glass': 'ğŸ’', 'street': 'ğŸ¤' };

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
        }

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme') || 'dark';
            let index = themes.indexOf(current);
            index = (index + 1) % themes.length;
            const next = themes[index];
            applyTheme(next);
            localStorage.setItem('theme', next);
        }

        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            const btn = document.getElementById('theme-btn');
            if (btn) btn.innerHTML = themeIcons[theme] || 'ğŸŒ™';

            document.body.classList.remove('animate-fade');
            void document.body.offsetWidth;
            document.body.classList.add('animate-fade');
        }
        initTheme();
    </script>
    <script src="js/ui.js"></script>
    <script src="js/nav.js"></script>
    <script>
        const API_OPT = '/api/options';
        const API_ADMIN = '/api/admin';
        const API_INV = '/api/inventory';

        window.onload = function () {
            initTheme();
            loadOptions();
            loadPendingUsers();
            loadFullUsers();
            loadItemAlertSettings();
            loadLogs();
        };

        async function loadItemAlertSettings() {
            try {
                const res = await fetch(API_INV);
                const items = await res.json();
                const listF = document.getElementById('item-alert-list-finished');
                const listR = document.getElementById('item-alert-list-raw');
                listF.innerHTML = '';
                listR.innerHTML = '';

                items.forEach(item => {
                    const isRaw = item.category === 'ì›ìì¬';
                    const list = isRaw ? listR : listF;
                    const badgeColor = isRaw ? 'rgba(16, 185, 129, 0.2)' : 'rgba(59, 130, 246, 0.2)';
                    const badgeTextColor = isRaw ? '#10b981' : '#3b82f6';

                    list.innerHTML += `
                        <tr>
                            <td><span style="font-size:0.75rem; font-weight:800; padding:4px 10px; border-radius:10px; background:${badgeColor}; color:${badgeTextColor}; border:1px solid ${badgeTextColor}55;">${item.category}</span></td>
                            <td style="font-weight:700;">${item.name}</td>
                            <td style="color:var(--text-sub);">${item.size} / ${item.length}</td>
                            <td>
                                <label class="switch">
                                    <input type="checkbox" ${item.alertEnabled ? 'checked' : ''} onchange="updateAlertSetting('${item._id}', 'alertEnabled', this.checked)">
                                    <span class="slider"></span>
                                </label>
                            </td>
                            <td>
                                <input type="number" value="${item.alertThreshold || 10}" 
                                    style="width:70px; padding:6px; text-align:center;"
                                    onchange="updateAlertSetting('${item._id}', 'alertThreshold', this.value)">
                            </td>
                            <td id="status-${item._id}" style="font-size:0.8rem; color:var(--text-sub);">ëŒ€ê¸°ì¤‘</td>
                        </tr>
                    `;
                });

                if (listF.innerHTML === '') listF.innerHTML = '<tr><td colspan="6" style="padding:30px; color:var(--text-sub);">ë“±ë¡ëœ ì™„ì œí’ˆì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                if (listR.innerHTML === '') listR.innerHTML = '<tr><td colspan="6" style="padding:30px; color:var(--text-sub);">ë“±ë¡ëœ ì›ìì¬ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';

            } catch (err) { console.error(err); }
        }

        async function updateAlertSetting(id, field, value) {
            const statusEl = document.getElementById(`status-${id}`);
            statusEl.innerText = 'ì €ì¥ ì¤‘...';
            statusEl.style.color = 'var(--highlight)';

            try {
                const body = { username: localStorage.getItem('nickname') || 'admin' };
                body[field] = field === 'alertThreshold' ? Number(value) : value;

                const res = await fetch(`${API_INV}/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                if (res.ok) {
                    statusEl.innerText = 'âœ… ì €ì¥ë¨';
                    statusEl.style.color = '#10b981';
                    setTimeout(() => { statusEl.innerText = 'ëŒ€ê¸°ì¤‘'; statusEl.style.color = 'var(--text-sub)'; }, 2000);
                } else {
                    statusEl.innerText = 'âŒ ì‹¤íŒ¨';
                    statusEl.style.color = '#ef4444';
                }
            } catch (err) {
                statusEl.innerText = 'âŒ ì—ëŸ¬';
                statusEl.style.color = '#ef4444';
            }
        }

        async function loadFullUsers() {
            try {
                const res = await fetch('/api/admin/users');
                if (res.status === 404) return;
                const users = await res.json();
                const list = document.getElementById('full-user-list');
                list.innerHTML = '';
                if (!users || users.length === 0) { list.innerHTML = '<tr><td colspan="4">íšŒì› ì—†ìŒ</td></tr>'; return; }
                users.forEach(user => {
                    list.innerHTML += `<tr><td>${user.username}</td><td>${user.nickname}</td><td>${user.role === 'admin' ? '<b style="color:#f59e0b">ê´€ë¦¬ì</b>' : 'ì¼ë°˜'}</td><td><button onclick="resetPassword('${user._id}')" style="background:#f59e0b;">PWì´ˆê¸°í™”</button><button class="btn-ban" onclick="banUser('${user._id}')">ê°•í‡´</button></td></tr>`;
                });
            } catch (err) { console.error(err); }
        }

        async function resetPassword(id) {
            if (!confirm("ë¹„ë°€ë²ˆí˜¸ë¥¼ '1234'ë¡œ ì´ˆê¸°í™”í•©ë‹ˆê¹Œ?")) return;
            try {
                const res = await fetch('/api/admin/reset-password', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: id }) });
                const data = await res.json(); alert(data.message || "ì²˜ë¦¬ë¨");
            } catch (err) { alert("ì˜¤ë¥˜"); }
        }

        async function loadOptions() {
            const res = await fetch(API_OPT);
            const options = await res.json();
            document.getElementById('list-itemName').innerHTML = '';
            document.getElementById('list-size').innerHTML = '';
            document.getElementById('list-length').innerHTML = '';
            options.forEach(opt => {
                const tag = document.createElement('div'); tag.className = 'tag';
                tag.innerHTML = `${opt.value} <button onclick="deleteOption('${opt._id}')">x</button>`;
                document.getElementById(`list-${opt.type}`).appendChild(tag);
            });
        }

        async function addOption(type, inputId) {
            const input = document.getElementById(inputId);
            const value = input.value.trim();
            if (!value) return;
            const res = await fetch(API_OPT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ type, value }) });
            if (res.ok) { input.value = ''; loadOptions(); }
        }

        async function deleteOption(id) {
            if (!confirm('ì‚­ì œ?')) return;
            await fetch(`${API_OPT}/${id}`, { method: 'DELETE' });
            loadOptions();
        }

        async function loadPendingUsers() {
            const res = await fetch(`${API_ADMIN}/pending`);
            const users = await res.json();
            const list = document.getElementById('user-list');
            list.innerHTML = '';
            if (users.length === 0) { list.innerHTML = '<tr><td colspan="4">ëŒ€ê¸° ì—†ìŒ</td></tr>'; return; }
            users.forEach(user => {
                list.innerHTML += `<tr><td>${user.username}</td><td>${user.nickname}</td><td>${new Date(user.createdAt).toLocaleDateString()}</td><td><button class="btn-approve" onclick="approveUser('${user._id}')">ìŠ¹ì¸</button><button class="btn-ban" onclick="banUser('${user._id}')">ê±°ì ˆ</button></td></tr>`;
            });
        }

        async function approveUser(id) {
            if (!confirm("ìŠ¹ì¸í•©ë‹ˆê¹Œ?")) return;
            try {
                const res = await fetch('/api/admin/approve', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: id }) });
                const data = await res.json(); alert(data.message); loadPendingUsers();
            } catch (err) { alert(err.message); }
        }

        async function banUser(id) {
            if (!confirm('ì‚­ì œí•©ë‹ˆê¹Œ?')) return;
            try {
                const res = await fetch(`/api/admin/reject`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ userId: id }) });
                if (res.ok) { alert('ì‚­ì œë¨'); loadPendingUsers(); loadFullUsers(); }
            } catch (err) { console.error(err); }
        }

        let currentLogCategory = 'ALL';
        function filterLogs(category, btn) {
            currentLogCategory = category;
            // ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼ ì²˜ë¦¬
            document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
            btn.classList.add('active');
            loadLogs(category);
        }

        async function loadLogs(category = 'ALL') {
            try {
                const res = await fetch(`/api/admin/logs?category=${category}`);
                const logs = await res.json();
                const container = document.getElementById('log-list');
                container.innerHTML = '';

                logs.forEach(log => {
                    const time = new Date(log.timestamp).toLocaleTimeString();
                    const date = new Date(log.timestamp).toLocaleDateString();
                    const colors = {
                        'Inventory': '#f59e0b',
                        'Attendance': '#10b981',
                        'Auth': '#3b82f6',
                        'Production': '#8b5cf6',
                        'System': '#94a3b8'
                    };
                    const color = colors[log.category] || '#94a3b8';

                    container.innerHTML += `
                        <div style="padding: 12px; border-bottom: 1px solid var(--card-border); font-size: 0.85rem;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                <span style="font-weight: 800; color: ${color}; text-transform:uppercase;">[${log.category}] ${log.action}</span>
                                <span style="color: var(--text-sub); font-size: 0.75rem;">${date} ${time}</span>
                            </div>
                            <div style="color: var(--text-main);">
                                <span style="font-weight: 700; color: var(--highlight);">${log.user}</span>: ${log.details}
                            </div>
                        </div>
                    `;
                });
                if (logs.length === 0) container.innerHTML = '<div style="text-align:center; padding:30px; color:var(--text-sub);">ì¡°ê±´ì— ë§ëŠ” í™œë™ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            } catch (err) { console.error("Log Load Err:", err); }
        }

        async function exportData(mode) {
            let url = '/api/admin/export';
            if (mode === 'filtered') {
                const start = document.getElementById('export-start').value;
                const end = document.getElementById('export-end').value;
                if (!start || !end) return UI.showToast("ê¸°ê°„ì„ ì„ íƒí•˜ì„¸ìš”.", "warning");
                url += `?start=${start}&end=${end}`;
            }

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("ë‹¤ìš´ë¡œë“œ ê¶Œí•œì´ ì—†ê±°ë‚˜ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                const blob = await res.blob();
                const downloadUrl = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = downloadUrl;
                a.download = `factory_backup_${mode}_${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(a);
                a.click();
                a.remove();
                UI.showToast("âœ… ë°±ì—… íŒŒì¼ ë‹¤ìš´ë¡œë“œ ì‹œì‘", "success");
            } catch (err) { UI.alert("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨", err.message, "error"); }
        }

        async function importData() {
            const fileInput = document.getElementById('import-file');
            if (!fileInput.files.length) return UI.showToast("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.", "warning");

            if (!confirm("âš ï¸ ì£¼ì˜: í˜„ì¬ DB ë°ì´í„°ê°€ ì„ íƒí•œ íŒŒì¼ ë‚´ìš©ìœ¼ë¡œ êµì²´ë˜ê±°ë‚˜ ì¶”ê°€ë©ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const formData = new FormData();
            formData.append('backup', fileInput.files[0]);

            try {
                const res = await fetch('/api/admin/import', { method: 'POST', body: formData });
                const result = await res.json();
                if (res.ok) {
                    await UI.alert("âœ… ë³µêµ¬ ì„±ê³µ", result.message, "success");
                    location.reload();
                } else {
                    UI.alert("âŒ ë³µêµ¬ ì‹¤íŒ¨", result.message || "íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.", "error");
                }
            } catch (err) { UI.alert("ì˜¤ë¥˜ ë°œìƒ", "ì„œë²„ì™€ í†µì‹  ì¤‘ ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.", "error"); }
        }
    </script>
</body>

</html>