<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ­ ìƒì‚°/ì¬ê³  ë‹¬ë ¥</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        body { padding: 30px; font-family: 'Pretendard', sans-serif; max-width: 1000px; margin: 0 auto; background-color: #f5f5f5; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #calendar { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-blue { background: #2196F3; color: white; }
        .btn-green { background: #4CAF50; color: white; }
        .btn-red { background: #F44336; color: white; }
        .btn-gray { background: #999; color: white; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; width: 550px; padding: 25px; margin: 5% auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group select, .form-group input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; }
        
        .item-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        .item-table th { background: #eee; font-size: 0.8em; padding: 5px; }
        .item-table td { border-bottom: 1px solid #eee; padding: 5px; }
        .item-table select, .item-table input { width: 100%; border: 1px solid #ccc; padding: 5px; }
        .section-title { font-size: 1.1em; font-weight: bold; margin-top: 20px; margin-bottom: 5px; border-bottom: 2px solid #ddd; padding-bottom: 5px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ­ ìƒì‚° ë° ì¬ê³  ë‹¬ë ¥</h1>
        <div>
            <span id="user-display" style="margin-right: 10px; font-weight: bold;"></span>
            <button class="btn-gray" onclick="location.href='/admin.html'">âš™ï¸ ê´€ë¦¬ì</button>
            <button class="btn-gray" onclick="location.href='/inventory.html'">ğŸ“¦ ì¬ê³ í˜„í™©</button>
        </div>
    </div>

    <div id="calendar"></div>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">ğŸ“ ì‘ì—… ë“±ë¡</h3>
            <input type="hidden" id="edit-event-id"> <div class="form-group">
                <label>ë‚ ì§œ</label>
                <input type="text" id="modal-date" readonly style="background: #eee;">
            </div>
            
            <div class="form-group">
                <label>ì‘ì—… êµ¬ë¶„</label>
                <select id="modal-type" onchange="toggleProductionMode()">
                    <option value="ì…ê³ ">ğŸŸ¢ ì…ê³  (êµ¬ë§¤/ë°˜í’ˆ ë“±)</option>
                    <option value="ì¶œê³ ">ğŸ”´ ì¶œê³  (íŒë§¤/íê¸° ë“±)</option>
                    <option value="ìƒì‚°">ğŸ”µ ìƒì‚° (ì œì¡°)</option>
                </select>
            </div>

            <div class="section-title">
                <span id="label-product">ğŸ“¦ ëŒ€ìƒ í’ˆëª©</span>
                <button class="btn-green" onclick="addRow('product-tbody')" style="font-size:0.8em;">+ ì¶”ê°€</button>
            </div>
            <table class="item-table">
                <thead><tr><th>í’ˆëª©</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th><th>ì‚­ì œ</th></tr></thead>
                <tbody id="product-tbody"></tbody>
            </table>

            <div id="material-section" style="display:none;">
                <div class="section-title">
                    <span>ğŸ”¨ ì‚¬ìš©ëœ ì›ìì¬ (ì°¨ê°)</span>
                    <button class="btn-red" onclick="addRow('material-tbody')" style="font-size:0.8em;">+ ì¶”ê°€</button>
                </div>
                <table class="item-table">
                    <thead><tr><th>í’ˆëª©</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th><th>ì‚­ì œ</th></tr></thead>
                    <tbody id="material-tbody"></tbody>
                </table>
            </div>

            <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                <button id="btn-delete" class="btn-red" onclick="deleteEvent()" style="display:none;">ğŸ—‘ ì‚­ì œ (ì¬ê³ ë³µêµ¬)</button>
                <div>
                    <button class="btn-gray" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button class="btn-blue" onclick="saveEvent()">ğŸ’¾ ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/calendar';
        const API_OPT = '/api/options';
        const currentUser = localStorage.getItem('username');
        let dropdownOptions = { items: [], sizes: [], lengths: [] };
        let calendarInstance;

        if (!currentUser) { alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); location.href = '/'; }
        document.getElementById('user-display').innerText = currentUser + "ë‹˜";

        document.addEventListener('DOMContentLoaded', async function() {
            await loadDropdownOptions();
            initCalendar();
        });

        async function loadDropdownOptions() {
            const res = await fetch(API_OPT);
            const data = await res.json();
            dropdownOptions.items = data.filter(o => o.type === 'itemName').map(o => o.value);
            dropdownOptions.sizes = data.filter(o => o.type === 'size').map(o => o.value);
            dropdownOptions.lengths = data.filter(o => o.type === 'length').map(o => o.value);
        }

        function initCalendar() {
            var calendarEl = document.getElementById('calendar');
            calendarInstance = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'ko',
                selectable: true,
                height: 'auto',
                events: async function(info, successCallback, failureCallback) {
                    try {
                        const res = await fetch(API_URL);
                        const events = await res.json();
                        successCallback(events);
                    } catch (err) { failureCallback(err); }
                },
                select: function(info) {
                    openModal(info.startStr, null); // ì‹ ê·œ ë“±ë¡
                },
                eventClick: function(info) {
                    openModal(info.event.startStr, info.event); // ìˆ˜ì • ëª¨ë“œ
                }
            });
            calendarInstance.render();
        }

        // --- ëª¨ë‹¬ ì—´ê¸° (ì‹ ê·œ/ìˆ˜ì • ê³µìš©) ---
        function openModal(dateStr, event) {
            // ì´ˆê¸°í™”
            document.getElementById('modal-date').value = dateStr.split('T')[0];
            document.getElementById('product-tbody').innerHTML = '';
            document.getElementById('material-tbody').innerHTML = '';
            
            if (event) {
                // [ìˆ˜ì • ëª¨ë“œ]
                document.getElementById('modal-title').innerText = "ğŸ“ ì‘ì—… ìˆ˜ì •";
                document.getElementById('edit-event-id').value = event.id; // ID ì €ì¥
                document.getElementById('btn-delete').style.display = 'inline-block';
                
                const props = event.extendedProps;
                document.getElementById('modal-type').value = props.type;
                
                // ê¸°ì¡´ ì•„ì´í…œë“¤ ì±„ì›Œë„£ê¸°
                if(props.items) {
                    props.items.forEach(item => {
                        const tbodyId = item.role === 'material' ? 'material-tbody' : 'product-tbody';
                        addRow(tbodyId, item);
                    });
                }
            } else {
                // [ì‹ ê·œ ëª¨ë“œ]
                document.getElementById('modal-title').innerText = "ğŸ“ ìƒˆ ì‘ì—… ë“±ë¡";
                document.getElementById('edit-event-id').value = ''; // ID ë¹„ì›€
                document.getElementById('btn-delete').style.display = 'none';
                document.getElementById('modal-type').value = 'ì…ê³ ';
                addRow('product-tbody'); // ë¹ˆ ì¤„ í•˜ë‚˜ ì¶”ê°€
            }
            
            toggleProductionMode();
            document.getElementById('eventModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        function toggleProductionMode() {
            const type = document.getElementById('modal-type').value;
            const matSection = document.getElementById('material-section');
            const labelProduct = document.getElementById('label-product');

            if (type === 'ìƒì‚°') {
                matSection.style.display = 'block';
                labelProduct.innerText = "ğŸ“¦ ìƒì‚°ëœ ì œí’ˆ (ì…ê³ )";
            } else {
                matSection.style.display = 'none';
                labelProduct.innerText = type === 'ì…ê³ ' ? "ğŸ“¦ ì…ê³ í•  í’ˆëª©" : "ğŸ“¦ ì¶œê³ í•  í’ˆëª©";
            }
        }

        // --- í–‰ ì¶”ê°€ (ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì±„ì›Œì„œ, ì—†ìœ¼ë©´ ë¹ˆ ê°’ìœ¼ë¡œ) ---
        function addRow(tbodyId, data = null) {
            const tbody = document.getElementById(tbodyId);
            const tr = document.createElement('tr');
            
            const createOpts = (list, selectedVal) => {
                let html = '<option value="">ì„ íƒ</option>';
                list.forEach(v => {
                    const selected = (v === selectedVal) ? 'selected' : '';
                    html += `<option value="${v}" ${selected}>${v}</option>`;
                });
                return html;
            };

            tr.innerHTML = `
                <td><select class="input-name">${createOpts(dropdownOptions.items, data?.name)}</select></td>
                <td><select class="input-size">${createOpts(dropdownOptions.sizes, data?.size)}</select></td>
                <td><select class="input-length">${createOpts(dropdownOptions.lengths, data?.length)}</select></td>
                <td><input type="number" class="input-qty" value="${data?.quantity || 1}" style="width:50px;"></td>
                <td><button onclick="this.closest('tr').remove()" style="background: #eee; border:none;">x</button></td>
            `;
            tbody.appendChild(tr);
        }

        // --- ì €ì¥ (ì‹ ê·œ:POST, ìˆ˜ì •:PUT) ---
        async function saveEvent() {
            const id = document.getElementById('edit-event-id').value;
            const type = document.getElementById('modal-type').value;
            const date = document.getElementById('modal-date').value;

            const getItems = (tbodyId) => {
                const rows = document.querySelectorAll(`#${tbodyId} tr`);
                const arr = [];
                rows.forEach(tr => {
                    const name = tr.querySelector('.input-name').value;
                    const size = tr.querySelector('.input-size').value;
                    const length = tr.querySelector('.input-length').value;
                    const qty = tr.querySelector('.input-qty').value;
                    if(name && qty) arr.push({ name, size, length, quantity: qty });
                });
                return arr;
            };

            const products = getItems('product-tbody');
            const materials = type === 'ìƒì‚°' ? getItems('material-tbody') : [];

            if(products.length === 0) return alert("ìµœì†Œ í•˜ë‚˜ì˜ í’ˆëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.");

            const payload = {
                start: date, type, username: currentUser,
                products, materials
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/${id}` : API_URL;

            const res = await fetch(url, {
                method: method,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            if(res.ok) {
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                closeModal();
                calendarInstance.refetchEvents();
            } else {
                const d = await res.json();
                alert("ì˜¤ë¥˜: " + d.message);
            }
        }

        // --- ì‚­ì œ (ì¬ê³  ë³µêµ¬) ---
        async function deleteEvent() {
            const id = document.getElementById('edit-event-id').value;
            if(!id) return;
            
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê´€ë ¨ëœ ì¬ê³  ìˆ˜ëŸ‰ì´ ì·¨ì†Œë©ë‹ˆë‹¤)")) return;

            const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            if(res.ok) {
                alert("ì‚­ì œ ë° ì¬ê³  ë³µêµ¬ ì™„ë£Œ");
                closeModal();
                calendarInstance.refetchEvents();
            } else {
                alert("ì‚­ì œ ì‹¤íŒ¨");
            }
        }
    </script>
</body>
</html>