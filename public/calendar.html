<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ­ ìƒì‚°/ì¬ê³  ë‹¬ë ¥</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        body { padding: 30px; font-family: 'Pretendard', sans-serif; max-width: 1000px; margin: 0 auto; background-color: #f5f5f5; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #calendar { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        button { padding: 8px 15px; cursor: pointer; border: none; border-radius: 4px; font-weight: bold; }
        .btn-blue { background: #2196F3; color: white; }
        .btn-green { background: #4CAF50; color: white; }
        .btn-red { background: #F44336; color: white; }
        .btn-gray { background: #999; color: white; }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; }
        .modal-content { background: white; width: 550px; padding: 25px; margin: 5% auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; font-size: 0.9em; }
        .form-group select, .form-group input { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ddd; }
        
        .item-table { width: 100%; border-collapse: collapse; margin-top: 5px; }
        .item-table th { background: #eee; font-size: 0.8em; padding: 5px; }
        .item-table td { border-bottom: 1px solid #eee; padding: 5px; }
        .item-table select, .item-table input { width: 100%; border: 1px solid #ccc; padding: 5px; }
        .section-title { font-size: 1.1em; font-weight: bold; margin-top: 20px; margin-bottom: 5px; border-bottom: 2px solid #ddd; padding-bottom: 5px; display: flex; justify-content: space-between; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ­ ìƒì‚° ë° ì¬ê³  ë‹¬ë ¥</h1>
        <div>
            <span id="user-display" style="margin-right: 10px; font-weight: bold;"></span>
            <button class="btn-gray" onclick="location.href='/admin.html'">âš™ï¸ ê´€ë¦¬ì</button>
            <button class="btn-gray" onclick="location.href='/inventory.html'">ğŸ“¦ ì¬ê³ í˜„í™©</button>
        </div>
    </div>

    <div id="calendar"></div>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">ğŸ“ ì‘ì—… ë“±ë¡</h3>
            <input type="hidden" id="edit-event-id">
            <div class="form-group">
                <label>ë‚ ì§œ</label>
                <input type="text" id="modal-date" readonly style="background: #eee;">
            </div>
            
            <div class="form-group">
                <label>ì‘ì—… êµ¬ë¶„</label>
                <select id="modal-type" onchange="toggleProductionMode()">
                    <option value="ì…ê³ ">ğŸŸ¢ ì…ê³  (êµ¬ë§¤/ë°˜í’ˆ ë“±)</option>
                    <option value="ì¶œê³ ">ğŸ”´ ì¶œê³  (íŒë§¤/íê¸° ë“±)</option>
                    <option value="ìƒì‚°">ğŸ”µ ìƒì‚° (ì œì¡°)</option>
                </select>
            </div>

            <div class="section-title">
                <span id="label-product">ğŸ“¦ ëŒ€ìƒ í’ˆëª©</span>
                <button class="btn-green" onclick="addRow('product-tbody')" style="font-size:0.8em;">+ ì¶”ê°€</button>
            </div>
            <table class="item-table">
                <thead><tr><th>í’ˆëª©</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th><th>ì‚­ì œ</th></tr></thead>
                <tbody id="product-tbody"></tbody>
            </table>

            <div id="material-section" style="display:none;">
                <div class="section-title">
                    <span>ğŸ”¨ ì‚¬ìš©ëœ ì›ìì¬ (ì°¨ê°)</span>
                    <button class="btn-red" onclick="addRow('material-tbody')" style="font-size:0.8em;">+ ì¶”ê°€</button>
                </div>
                <table class="item-table">
                    <thead><tr><th>í’ˆëª©</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th><th>ì‚­ì œ</th></tr></thead>
                    <tbody id="material-tbody"></tbody>
                </table>
            </div>

            <div style="margin-top: 20px; display: flex; justify-content: space-between;">
                <button id="btn-delete" class="btn-red" onclick="deleteEvent()" style="display:none;">ğŸ—‘ ì‚­ì œ (ì¬ê³ ë³µêµ¬)</button>
                <div>
                    <button class="btn-gray" onclick="closeModal()">ì·¨ì†Œ</button>
                    <button class="btn-blue" onclick="saveEvent()">ğŸ’¾ ì €ì¥</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/calendar';
        const API_OPT = '/api/options';
        const currentUser = localStorage.getItem('username');
        let dropdownOptions = { items: [], sizes: [], lengths: [] };
        let calendarInstance;

        if (!currentUser) { 
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤."); 
            location.href = '/login'; 
        }
        document.getElementById('user-display').innerText = currentUser + "ë‹˜";

        document.addEventListener('DOMContentLoaded', async function() {
            await loadDropdownOptions();
            initCalendar();
        });

        async function loadDropdownOptions() {
            try {
                const res = await fetch(API_OPT);
                if (!res.ok) throw new Error("ì˜µì…˜ ë¡œë”© ì‹¤íŒ¨");
                const data = await res.json();
                dropdownOptions.items = data.filter(d => d.type === 'itemName' || d.type === 'item' || d.type === 'í’ˆëª©').map(d => d.value);
                dropdownOptions.sizes = data.filter(d => d.type === 'size' || d.type === 'ì‚¬ì´ì¦ˆ').map(d => d.value);
                dropdownOptions.lengths = data.filter(d => d.type === 'length' || d.type === 'ê¸¸ì´').map(d => d.value);
            } catch (err) {
                console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", err);
            }
        }

        function initCalendar() {
    var calendarEl = document.getElementById('calendar');
    
    calendarInstance = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'ko',
        selectable: true,
        height: 'auto',
        // ì„œë²„ì—ì„œ ì¼ì •ì„ ê°€ì ¸ì™€ì„œ ìƒ‰ìƒì„ ì…íˆëŠ” í•µì‹¬ ë¡œì§
        events: async function(info, successCallback, failureCallback) {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨");
                const rawEvents = await res.json();
                
                // ì„œë²„ ë°ì´í„°ë¥¼ FullCalendar í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                const events = rawEvents.map(event => {
                    // 1. ì‘ì—… êµ¬ë¶„(type)ì— ë”°ë¥¸ ìƒ‰ìƒ ì„¤ì •
                    let eventColor = '#999999'; // ê¸°ë³¸ê°’ (íšŒìƒ‰)
                    if (event.type === 'ì…ê³ ') {
                        eventColor = '#4CAF50'; // ì´ˆë¡ìƒ‰
                    } else if (event.type === 'ì¶œê³ ') {
                        eventColor = '#F44336'; // ë¹¨ê°„ìƒ‰
                    } else if (event.type === 'ìƒì‚°') {
                        eventColor = '#2196F3'; // íŒŒë€ìƒ‰
                    }

                    return {
                        id: event._id,              // ì‚­ì œ ì‹œ í•„ìš”í•œ ê³ ìœ  ID
                        title: event.title,        // ë‹¬ë ¥ì— í‘œì‹œë  ì œëª©
                        start: event.start,        // ì‹œì‘ ë‚ ì§œ
                        backgroundColor: eventColor, // ì¼ì • ë°°ê²½ìƒ‰
                        borderColor: eventColor,     // ì¼ì • í…Œë‘ë¦¬ìƒ‰
                        textColor: '#ffffff',       // ê¸€ììƒ‰ (í°ìƒ‰)
                        // ìƒì„¸ íŒì—…ì— ë„˜ê²¨ì¤„ ì¶”ê°€ ë°ì´í„°
                        extendedProps: {
                            type: event.type,
                            items: event.items,
                            createdBy: event.createdBy
                        }
                    };
                });
                
                successCallback(events);
            } catch (err) {
                console.error("ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬:", err);
                failureCallback(err);
            }
        },
        // ë‚ ì§œ ë¹ˆ ì¹¸ í´ë¦­ ì‹œ í˜¸ì¶œ (ìƒˆ ì¼ì • ë“±ë¡)
        select: function(info) {
            openModal(info.startStr, null);
        },
        // ë“±ë¡ëœ ì¼ì • í´ë¦­ ì‹œ í˜¸ì¶œ (ìƒì„¸ë³´ê¸°/ìˆ˜ì •/ì‚­ì œ)
        eventClick: function(info) {
            openModal(info.event.startStr, info.event);
        }
    });

    calendarInstance.render();
}

        // calendar.html ë‚´ì˜ openModal í•¨ìˆ˜ë¥¼ ì•„ë˜ ë‚´ìš©ìœ¼ë¡œ êµì²´í•˜ì„¸ìš”.
function openModal(dateStr, event) {
    // ê¸°ì´ˆ ì´ˆê¸°í™”
    document.getElementById('modal-date').value = dateStr.split('T')[0];
    document.getElementById('product-tbody').innerHTML = '';
    document.getElementById('material-tbody').innerHTML = '';
    
    if (event) {
        // [í•µì‹¬ ìˆ˜ì •] FullCalendarì˜ event.id ê°’ì„ hidden inputì— ì €ì¥
        // FullCalendar v6ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ DBì˜ _idë¥¼ event.idë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
        document.getElementById('edit-event-id').value = event.id; 
        
        document.getElementById('modal-title').innerText = "ğŸ“ ì‘ì—… ìˆ˜ì •";
        document.getElementById('btn-delete').style.display = 'inline-block';
        
        const props = event.extendedProps; // ìƒì„¸ ë°ì´í„°ê°€ ë‹´ê¸´ ê³³
        document.getElementById('modal-type').value = props.type;
        
        // ì„œë²„ ìŠ¤í‚¤ë§ˆ êµ¬ì¡°ì¸ 'items' ë°°ì—´ì„ ìˆœíšŒí•˜ë©° í…Œì´ë¸”ì— ë°°ì •
        if (props.items && Array.isArray(props.items)) {
            props.items.forEach(item => {
                if (item.role === 'material') {
                    addRow('material-tbody', item);
                } else {
                    addRow('product-tbody', item);
                }
            });
        }
    } else {
        // ì‹ ê·œ ë“±ë¡ ëª¨ë“œ
        document.getElementById('edit-event-id').value = '';
        document.getElementById('modal-title').innerText = "ğŸ“ ìƒˆ ì‘ì—… ë“±ë¡";
        document.getElementById('btn-delete').style.display = 'none';
        document.getElementById('modal-type').value = 'ì…ê³ ';
        addRow('product-tbody'); 
    }
    
    toggleProductionMode();
    document.getElementById('eventModal').style.display = 'block';
}

        function closeModal() {
            document.getElementById('eventModal').style.display = 'none';
        }

        function toggleProductionMode() {
            const type = document.getElementById('modal-type').value;
            const matSection = document.getElementById('material-section');
            const labelProduct = document.getElementById('label-product');

            if (type === 'ìƒì‚°') {
                matSection.style.display = 'block';
                labelProduct.innerText = "ğŸ“¦ ìƒì‚°ëœ ì œí’ˆ (ì…ê³ )";
            } else {
                matSection.style.display = 'none';
                labelProduct.innerText = type === 'ì…ê³ ' ? "ğŸ“¦ ì…ê³ í•  í’ˆëª©" : "ğŸ“¦ ì¶œê³ í•  í’ˆëª©";
            }
        }

        function addRow(tbodyId, data = null) {
            const tbody = document.getElementById(tbodyId);
            const tr = document.createElement('tr');
            
            const createOpts = (list, selectedVal) => {
                let html = '<option value="">ì„ íƒ</option>';
                if(list && list.length > 0) {
                    list.forEach(v => {
                        const selected = (String(v) === String(selectedVal)) ? 'selected' : '';
                        html += `<option value="${v}" ${selected}>${v}</option>`;
                    });
                }
                return html;
            };

            tr.innerHTML = `
                <td><select class="input-name">${createOpts(dropdownOptions.items, data?.name)}</select></td>
                <td><select class="input-size">${createOpts(dropdownOptions.sizes, data?.size)}</select></td>
                <td><select class="input-length">${createOpts(dropdownOptions.lengths, data?.length)}</select></td>
                <td><input type="number" class="input-qty" value="${data?.quantity || 1}" style="width:50px;"></td>
                <td><button onclick="this.closest('tr').remove()" style="background: #eee; border:none;">x</button></td>
            `;
            tbody.appendChild(tr);
        }

        async function saveEvent() {
            const id = document.getElementById('edit-event-id').value;
            const type = document.getElementById('modal-type').value;
            const date = document.getElementById('modal-date').value;

            const getItems = (tbodyId) => {
                const rows = document.querySelectorAll(`#${tbodyId} tr`);
                const arr = [];
                rows.forEach(tr => {
                    const name = tr.querySelector('.input-name').value;
                    const size = tr.querySelector('.input-size').value;
                    const length = tr.querySelector('.input-length').value;
                    const qty = tr.querySelector('.input-qty').value;
                    if(name && qty) {
                        arr.push({ name, size, length, quantity: Number(qty) });
                    }
                });
                return arr;
            };

            const products = getItems('product-tbody');
            const materials = type === 'ìƒì‚°' ? getItems('material-tbody') : [];

            if(products.length === 0) return alert("ìµœì†Œ í•˜ë‚˜ì˜ í’ˆëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.");

            const payload = {
                start: date, type, username: currentUser,
                products, materials
            };

            const method = id ? 'PUT' : 'POST';
            const url = id ? `${API_URL}/${id}` : API_URL;

            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if(res.ok) {
                    alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeModal();
                    calendarInstance.refetchEvents();
                } else {
                    const d = await res.json();
                    alert("ì˜¤ë¥˜: " + (d.message || "ì €ì¥ ì¤‘ ì—ëŸ¬ ë°œìƒ"));
                }
            } catch(e) {
                alert("ì„œë²„ í†µì‹  ì˜¤ë¥˜");
            }
        }

        async function deleteEvent() {
            const id = document.getElementById('edit-event-id').value;
            if(!id) return alert("ì‚­ì œí•  ì¼ì • IDê°€ ì—†ìŠµë‹ˆë‹¤.");
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ê´€ë ¨ëœ ì¬ê³  ìˆ˜ëŸ‰ì´ ì·¨ì†Œë©ë‹ˆë‹¤)")) return;

            try {
                const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
                if(res.ok) {
                    alert("ì‚­ì œ ë° ì¬ê³  ë³µêµ¬ ì™„ë£Œ");
                    closeModal();
                    calendarInstance.refetchEvents();
                } else {
                    const d = await res.json();
                    alert("ì‚­ì œ ì‹¤íŒ¨: " + d.message);
                }
            } catch(e) {
                alert("ì„œë²„ì™€ í†µì‹  ì¤‘ ì—ëŸ¬ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
    </script>
</body>
</html>