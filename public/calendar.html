<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ­ ìƒì‚° ë° ì¬ê³  ë‹¬ë ¥</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        /* ê¸°ë³¸ ë ˆì´ì•„ì›ƒ */
        body { padding: 10px; font-family: 'Pretendard', sans-serif; background-color: #f5f5f5; margin: 0; }
        .header { display: flex; flex-direction: column; gap: 10px; margin-bottom: 15px; }
        .header h1 { font-size: 1.5rem; margin: 0; }
        .nav-btns { display: flex; gap: 5px; flex-wrap: wrap; }
        
        #calendar { background: white; padding: 10px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

        /* ëª¨ë‹¬ ì°½ (ëª¨ë°”ì¼ ëŒ€ì‘) */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 1000; overflow-y: auto; }
        .modal-content { 
            background: white; 
            width: 95%; 
            max-width: 550px; 
            padding: 20px; 
            margin: 20px auto; 
            border-radius: 12px; 
            box-sizing: border-box;
        }

        /* ì…ë ¥ í¼ ê°€ë…ì„± ê°•í™” */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; color: #333; }
        .form-group select, .form-group input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #ddd; 
            border-radius: 6px; 
            font-size: 16px; /* ëª¨ë°”ì¼ ì•„ì´í° ì¤Œ ë°©ì§€ */
            box-sizing: border-box;
        }

        /* í…Œì´ë¸” ëª¨ë°”ì¼ ê°€ë¡œ ìŠ¤í¬ë¡¤ í—ˆìš© */
        .table-container { width: 100%; overflow-x: auto; margin-top: 10px; border: 1px solid #eee; border-radius: 6px; }
        .item-table { width: 100%; border-collapse: collapse; min-width: 450px; }
        .item-table th { background: #f8f9fa; padding: 10px; font-size: 13px; }
        .item-table td { padding: 8px; border-bottom: 1px solid #eee; }

        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        button { padding: 10px 15px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; font-size: 14px; }
        .btn-blue { background: #2196F3; color: white; width: 100%; margin-top: 10px; }
        .btn-green { background: #4CAF50; color: white; }
        .btn-red { background: #F44336; color: white; }
        .btn-gray { background: #eee; color: #333; }

        /* ëª¨ë°”ì¼ìš© í”Œë¡œíŒ… ì¶”ê°€ ë²„íŠ¼ (ìš°ì¸¡ í•˜ë‹¨) */
        .floating-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: #2196F3;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 30px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            z-index: 999;
            text-decoration: none;
            border: none;
        }

        /* FullCalendar ëª¨ë°”ì¼ ë†’ì´ ì¡°ì ˆ */
        @media (max-width: 600px) {
            .fc-toolbar-title { font-size: 1.2rem !important; }
            .fc-button { padding: 4px 8px !important; font-size: 12px !important; }
        }

        /* --- ë‹¬ë ¥ ìš”ì¼ ë° ë‚ ì§œ ìƒ‰ìƒ ì»¤ìŠ¤í…€ --- */
        /* ì¼ìš”ì¼(0) ë‚ ì§œ ë° ìš”ì¼ ë¹¨ê°„ìƒ‰ */
        .fc-day-sun a {
            color: #F44336 !important; 
        }
        .fc-col-header-cell.fc-day-sun .fc-col-header-cell-cushion {
            color: #F44336 !important; 
        }

        /* í† ìš”ì¼(6) ë‚ ì§œ ë° ìš”ì¼ íŒŒë€ìƒ‰ */
        .fc-day-sat a {
            color: #2196F3 !important; 
        }
        .fc-col-header-cell.fc-day-sat .fc-col-header-cell-cushion {
            color: #2196F3 !important; 
        }
        
        /* ì˜¤ëŠ˜ ë‚ ì§œ ìˆ«ì ê°•ì¡° */
        .fc-daygrid-day-number {
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ­ ìƒì‚° ë° ì¬ê³  ë‹¬ë ¥</h1>
        <div class="nav-btns">
            <span id="user-display" style="font-weight: bold; padding: 5px;"></span>
            <button class="btn-gray" onclick="location.href='/admin.html'">âš™ï¸ ê´€ë¦¬ì</button>
            <button class="btn-gray" onclick="location.href='/inventory.html'">ğŸ“¦ ì¬ê³ í˜„í™©</button>
        </div>
    </div>

    <div style="margin-bottom: 10px; display: flex; gap: 10px; font-size: 0.8rem; flex-wrap: wrap;">
        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 10px; height: 10px; background: #4CAF50; border-radius: 2px;"></span> ì…ê³ </span>
        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 10px; height: 10px; background: #F44336; border-radius: 2px;"></span> ì¶œê³ </span>
        <span style="display: flex; align-items: center; gap: 3px;"><span style="width: 10px; height: 10px; background: #2196F3; border-radius: 2px;"></span> ìƒì‚°</span>
    </div>

    <div id="calendar"></div>

    <button class="floating-btn" onclick="openQuickAdd()">+</button>

    <div id="eventModal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title">ğŸ“ ì‘ì—… ë“±ë¡</h3>
            <input type="hidden" id="edit-event-id">
            
            <div class="form-group">
                <label>ë‚ ì§œ</label>
                <input type="date" id="modal-date">
            </div>
            
            <div class="form-group">
                <label>ì‘ì—… êµ¬ë¶„</label>
                <select id="modal-type" onchange="toggleProductionMode()">
                    <option value="ì…ê³ ">ğŸŸ¢ ì…ê³ </option>
                    <option value="ì¶œê³ ">ğŸ”´ ì¶œê³ </option>
                    <option value="ìƒì‚°">ğŸ”µ ìƒì‚°</option>
                </select>
            </div>

            <div class="section-title" style="display:flex; justify-content:space-between; align-items:center; margin-top:20px;">
                <label id="label-product" style="font-weight:bold;">ğŸ“¦ ëŒ€ìƒ í’ˆëª©</label>
                <button class="btn-green" onclick="addRow('product-tbody')" style="padding:5px 10px;">+ ì¶”ê°€</button>
            </div>
            <div class="table-container">
                <table class="item-table">
                    <thead><tr><th>í’ˆëª©</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th><th>ì‚­ì œ</th></tr></thead>
                    <tbody id="product-tbody"></tbody>
                </table>
            </div>

            <div id="material-section" style="display:none; margin-top:20px;">
                <div class="section-title" style="display:flex; justify-content:space-between; align-items:center;">
                    <label style="font-weight:bold; color: #F44336;">ğŸ”¨ ì†Œëª¨ ì›ìì¬</label>
                    <button class="btn-red" onclick="addRow('material-tbody')" style="padding:5px 10px;">+ ì¶”ê°€</button>
                </div>
                <div class="table-container">
                    <table class="item-table">
                        <thead><tr><th>í’ˆëª©</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th><th>ì‚­ì œ</th></tr></thead>
                        <tbody id="material-tbody"></tbody>
                    </table>
                </div>
            </div>

            <div style="margin-top: 25px; display: flex; flex-direction: column; gap: 10px;">
                <button class="btn-blue" onclick="saveEvent()">ğŸ’¾ ì €ì¥í•˜ê¸°</button>
                <div style="display: flex; gap: 10px;">
                    <button class="btn-gray" onclick="closeModal()" style="flex:1;">ì·¨ì†Œ</button>
                    <button id="btn-delete" class="btn-red" onclick="deleteEvent()" style="flex:1; display:none;">ğŸ—‘ ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = '/api/calendar';
        const API_OPT = '/api/options';
        const currentUser = localStorage.getItem('username');
        let dropdownOptions = { items: [], sizes: [], lengths: [] };
        let calendarInstance;

        if (!currentUser) { location.href = '/'; }
        document.getElementById('user-display').innerText = currentUser + "ë‹˜";

        document.addEventListener('DOMContentLoaded', async function() {
            await loadDropdownOptions();
            initCalendar();
        });

        async function loadDropdownOptions() {
            try {
                const res = await fetch(API_OPT);
                const data = await res.json();
                dropdownOptions.items = data.filter(d => d.type === 'itemName' || d.type === 'item').map(d => d.value);
                dropdownOptions.sizes = data.filter(d => d.type === 'size').map(d => d.value);
                dropdownOptions.lengths = data.filter(d => d.type === 'length').map(d => d.value);
            } catch (err) { console.error(err); }
        }

        function initCalendar() {
    const calendarEl = document.getElementById('calendar');
    
    calendarInstance = new FullCalendar.Calendar(calendarEl, {
        // 1. ëª¨ë°”ì¼/PC ìƒê´€ì—†ì´ ê¸°ë³¸ì„ 'ì›”ê°„ ë‹¬ë ¥'ìœ¼ë¡œ ì„¤ì •
        initialView: 'dayGridMonth', 
        
        // 2. í—¤ë” íˆ´ë°” ì„¤ì • (ëª¨ë°”ì¼ì—ì„œë„ ë³´ê¸° ë²„íŠ¼ ìœ ì§€)
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,listMonth' // ì›”ê°„ ë‹¬ë ¥ê³¼ ë¦¬ìŠ¤íŠ¸ í˜•íƒœ ë³´ê¸° ì œê³µ
        },
        
        locale: 'ko',
        selectable: true,
        height: 'auto', // ë‚´ìš©ì— ë§ê²Œ ë†’ì´ ìë™ ì¡°ì ˆ
        
        // ì¼ì •ì„ ê°€ì ¸ì™€ì„œ ìƒ‰ìƒì„ ì…íˆëŠ” ë¡œì§
        events: async function(info, successCallback, failureCallback) {
            try {
                const res = await fetch(API_URL);
                if (!res.ok) throw new Error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨");
                const rawEvents = await res.json();
                
                const events = rawEvents.map(event => {
                    let eventColor = '#999999';
                    if (event.type === 'ì…ê³ ') eventColor = '#4CAF50';
                    else if (event.type === 'ì¶œê³ ') eventColor = '#F44336';
                    else if (event.type === 'ìƒì‚°') eventColor = '#2196F3';

                    return {
                        id: event._id,
                        title: event.title,
                        start: event.start,
                        backgroundColor: eventColor,
                        borderColor: eventColor,
                        textColor: '#ffffff',
                        extendedProps: {
                            type: event.type,
                            items: event.items
                        }
                    };
                });
                successCallback(events);
            } catch (err) {
                console.error("ì¼ì • ë¶ˆëŸ¬ì˜¤ê¸° ì—ëŸ¬:", err);
                failureCallback(err);
            }
        },
        
        // ë‚ ì§œ í´ë¦­ ì‹œ ìƒˆ ì¼ì • ë“±ë¡
        select: function(info) {
            openModal(info.startStr, null);
        },
        
        // ë“±ë¡ëœ ì¼ì • í´ë¦­ ì‹œ ìƒì„¸ë³´ê¸°/ìˆ˜ì •
        eventClick: function(info) {
            openModal(info.event.startStr, info.event);
        },

        // 3. [ìˆ˜ì •] í™”ë©´ í¬ê¸°ê°€ ë³€í•´ë„ ë·°ë¥¼ ê°•ì œë¡œ ë°”ê¾¸ì§€ ì•Šë„ë¡ ì„¤ì •
        windowResize: function(view) {
            // ê°•ì œ ë·° ì „í™˜ ë¡œì§ ì‚­ì œ
        }
    });

    calendarInstance.render();
}

        function openQuickAdd() {
            const today = new Date().toISOString().split('T')[0];
            openModal(today, null);
        }

        function openModal(dateStr, event) {
            document.getElementById('modal-date').value = dateStr.split('T')[0];
            document.getElementById('product-tbody').innerHTML = '';
            document.getElementById('material-tbody').innerHTML = '';
            
            if (event) {
                document.getElementById('edit-event-id').value = event.id;
                document.getElementById('modal-title').innerText = "ğŸ“ ì‘ì—… ìˆ˜ì •";
                document.getElementById('btn-delete').style.display = 'inline-block';
                const props = event.extendedProps;
                document.getElementById('modal-type').value = props.type;
                if (props.items) {
                    props.items.forEach(item => {
                        const target = item.role === 'material' ? 'material-tbody' : 'product-tbody';
                        addRow(target, item);
                    });
                }
            } else {
                document.getElementById('edit-event-id').value = '';
                document.getElementById('modal-title').innerText = "ğŸ“ ìƒˆ ì‘ì—… ë“±ë¡";
                document.getElementById('btn-delete').style.display = 'none';
                addRow('product-tbody'); 
            }
            toggleProductionMode();
            document.getElementById('eventModal').style.display = 'block';
        }

        function closeModal() { document.getElementById('eventModal').style.display = 'none'; }

        function toggleProductionMode() {
            const type = document.getElementById('modal-type').value;
            document.getElementById('material-section').style.display = (type === 'ìƒì‚°') ? 'block' : 'none';
        }

        function addRow(tbodyId, data = null) {
            const tbody = document.getElementById(tbodyId);
            const tr = document.createElement('tr');
            const createOpts = (list, selectedVal) => {
                let html = '<option value="">ì„ íƒ</option>';
                list.forEach(v => html += `<option value="${v}" ${String(v)===String(selectedVal)?'selected':''}>${v}</option>`);
                return html;
            };
            tr.innerHTML = `
                <td><select class="input-name">${createOpts(dropdownOptions.items, data?.name)}</select></td>
                <td><select class="input-size">${createOpts(dropdownOptions.sizes, data?.size)}</select></td>
                <td><select class="input-length">${createOpts(dropdownOptions.lengths, data?.length)}</select></td>
                <td><input type="number" class="input-qty" value="${data?.quantity || 1}" style="width:50px;"></td>
                <td><button onclick="this.closest('tr').remove()">âŒ</button></td>
            `;
            tbody.appendChild(tr);
        }

        async function saveEvent() {
            const id = document.getElementById('edit-event-id').value;
            const type = document.getElementById('modal-type').value;
            const date = document.getElementById('modal-date').value;
            const getItems = (id) => Array.from(document.querySelectorAll(`#${id} tr`)).map(tr => ({
                name: tr.querySelector('.input-name').value,
                size: tr.querySelector('.input-size').value,
                length: tr.querySelector('.input-length').value,
                quantity: Number(tr.querySelector('.input-qty').value)
            })).filter(i => i.name);

            const products = getItems('product-tbody');
            const materials = type === 'ìƒì‚°' ? getItems('material-tbody') : [];
            if(!products.length) return alert("í’ˆëª©ì„ ì„ íƒí•˜ì„¸ìš”.");

            const url = id ? `${API_URL}/${id}` : API_URL;
            const res = await fetch(url, {
                method: id ? 'PUT' : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ start: date, type, username: currentUser, products, materials })
            });
            if(res.ok) { closeModal(); calendarInstance.refetchEvents(); }
        }

        async function deleteEvent() {
            if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const id = document.getElementById('edit-event-id').value;
            const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            if(res.ok) { closeModal(); calendarInstance.refetchEvents(); }
        }
    </script>
</body>
</html>