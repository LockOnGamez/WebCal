<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“… ì‘ì—… ë° ê·¼ë¬´ ë‹¬ë ¥</title>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
    <style>
        body { padding: 15px; font-family: 'Pretendard', sans-serif; background-color: #f0f2f5; margin: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        #calendar { background: white; padding: 15px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        .nav-btns { display: flex; gap: 8px; align-items: center; }
        .mode-toggles { background: #eee; padding: 5px; border-radius: 12px; display: flex; gap: 5px; }
        .mode-btn { border: none; padding: 8px 15px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 13px; }
        .active-work { background: #2196F3; color: white; }
        .active-att { background: #10b981; color: white; }
        
        /* ì‹œê°„ í‘œê¸° ê°•ì œ ìˆ¨ê¹€ */
        .fc-event-time { display: none !important; }
        
        /* íœ´ì¼ ë° ë‚ ì§œ ìŠ¤íƒ€ì¼ */
        .holiday-name { font-size: 0.65rem; color: #F44336; margin-top: -2px; font-weight: 500; text-align: right; display: block; }
        .fc-daygrid-day-top { flex-direction: column !important; align-items: flex-end !important; padding-right: 5px !important; }
        .fc-daygrid-day-number { float: none !important; padding: 0 !important; }
        .fc-day-sun .fc-daygrid-day-number { color: #F44336 !important; }
        
        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; overflow-y: auto; backdrop-filter: blur(4px); }
        .modal-content { background: white; width: 95%; max-width: 500px; padding: 30px; margin: 40px auto; border-radius: 24px; box-sizing: border-box; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; height: 45px; padding: 0 10px; border: 1px solid #ddd; border-radius: 10px; box-sizing: border-box; }
        
        button { padding: 12px 20px; border: none; border-radius: 12px; font-weight: 700; cursor: pointer; }
        .btn-blue { background: #2196F3; color: white; width: 100%; }
        .btn-red { background: #F44336; color: white; }
        .btn-gray { background: #eee; color: #333; }
        
        #loading-layer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #e0e0e0; border-top: 5px solid #2196F3; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-layer"><div class="spinner"></div><p>ë°ì´í„° ì²˜ë¦¬ ì¤‘...</p></div>

    <div class="header">
        <h1 id="cal-title">ğŸ“… ì‘ì—… ë‹¬ë ¥</h1>
        <div class="nav-btns">
            <div class="mode-toggles">
                <button id="m-work" class="mode-btn active-work" onclick="setMode('work')">ğŸ“¦ ì‘ì—…</button>
                <button id="m-att" class="mode-btn" onclick="setMode('att')">ğŸ•’ ê·¼ë¬´</button>
            </div>
            <button onclick="location.href='/main.html'" style="padding:8px 15px; border-radius:10px; border:none; background:#333; color:white; font-weight:bold;">ğŸ  í™ˆ</button>
        </div>
    </div>

    <div id="calendar"></div>

    <div id="attendanceModal" class="modal">
        <div class="modal-content">
            <h3>ğŸ•’ ê·¼ë¬´ ê¸°ë¡ ìˆ˜ì •</h3>
            <input type="hidden" id="att-id">
            <div class="form-group">
                <label>ì´ë¦„(ë‹‰ë„¤ì„)</label>
                <input type="text" id="att-name">
            </div>
            <div class="form-group">
                <label>ì¶œê·¼ ì‹œê°„</label>
                <input type="datetime-local" id="att-in">
            </div>
            <div class="form-group">
                <label>í‡´ê·¼ ì‹œê°„</label>
                <input type="datetime-local" id="att-out">
            </div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button class="btn-blue" onclick="saveAttendanceEdit()" style="flex:2;">ğŸ’¾ ì €ì¥</button>
                <button class="btn-gray" onclick="closeAttModal()" style="flex:1;">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        let currentMode = 'work';
        let calendarInstance;
        const holidayCache = JSON.parse(localStorage.getItem('holiday_cache')) || {};

        document.addEventListener('DOMContentLoaded', () => { initCalendar(); });

        function setMode(mode) {
            currentMode = mode;
            document.getElementById('cal-title').innerText = mode === 'work' ? 'ğŸ“… ì‘ì—… ë‹¬ë ¥' : 'ğŸ•’ ê·¼ë¬´ ì¼ì§€';
            document.getElementById('m-work').className = `mode-btn ${mode==='work'?'active-work':''}`;
            document.getElementById('m-att').className = `mode-btn ${mode==='att'?'active-att':''}`;
            calendarInstance.refetchEvents();
        }

        function formatDuration(s) {
            if (!s || s < 0) return "ê·¼ë¬´ ì¤‘";
            const h = Math.floor(s/3600); const m = Math.floor((s%3600)/60);
            return `${h}ì‹œê°„ ${m}ë¶„`;
        }

        function initCalendar() {
            calendarInstance = new FullCalendar.Calendar(document.getElementById('calendar'), {
                initialView: 'dayGridMonth',
                locale: 'ko',
                height: 'auto',
                displayEventTime: false, // ì‹œê°„ í‘œê¸° ì œê±°
                events: async function(info, success, failure) {
                    try {
                        const url = currentMode === 'work' ? '/api/calendar' : '/api/attendance/all';
                        const res = await fetch(url);
                        const data = await res.json();
                        const evts = data.map(d => {
                            if (currentMode === 'work') {
                                return { 
                                    id: d._id,
                                    title: d.title, 
                                    start: d.start, 
                                    display: 'block',
                                    backgroundColor: d.type==='ì¶œê³ '?'#F44336':d.type==='ìƒì‚°'?'#2196F3':'#4CAF50' 
                                };
                            } else {
                                const inT = new Date(d.clockIn).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                                const outT = d.clockOut ? new Date(d.clockOut).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '...';
                                return { 
                                    id: d._id,
                                    title: `${d.nickname || d.username}: ${inT}~${outT} (${formatDuration(d.duration)})`, 
                                    start: d.date, 
                                    backgroundColor: '#10b981', 
                                    allDay: true,
                                    extendedProps: { ...d } // ì›ë³¸ ë°ì´í„° ë³´ê´€
                                };
                            }
                        });
                        success(evts);
                    } catch (e) { failure(e); }
                },
                eventClick: function(info) {
                    if (currentMode === 'att') {
                        openAttModal(info.event.extendedProps);
                    } else {
                        // ê¸°ì¡´ ì‘ì—… ìˆ˜ì • ë¡œì§ í˜¸ì¶œ (í•„ìš” ì‹œ)
                        alert("ì‘ì—… ìˆ˜ì •ì€ ê´€ë¦¬ì í˜ì´ì§€ í˜¹ì€ ì „ìš© íŒì—…ì„ ì´ìš©í•˜ì„¸ìš”.");
                    }
                },
                dayCellDidMount: (info) => {
                    const dStr = info.date.toLocaleDateString('sv-SE');
                    const h = holidayCache[info.date.getFullYear()]?.find(x => x.date === dStr);
                    if (info.date.getDay() === 0 || h) {
                        const num = info.el.querySelector('.fc-daygrid-day-number');
                        if (num) {
                            num.style.setProperty('color', '#F44336', 'important');
                            if (h) {
                                const div = document.createElement('div'); div.className = 'holiday-name'; div.innerText = `(${h.name})`;
                                num.parentElement.appendChild(div);
                            }
                        }
                    }
                }
            });
            calendarInstance.render();
        }

        // ê·¼ë¬´ ê¸°ë¡ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
        function openAttModal(data) {
            document.getElementById('att-id').value = data._id;
            document.getElementById('att-name').value = data.nickname || data.username;
            
            // datetime-local í˜•ì‹ìœ¼ë¡œ ë³€í™˜ (YYYY-MM-DDTHH:mm)
            const toLocalISO = (dateStr) => {
                if(!dateStr) return "";
                const date = new Date(dateStr);
                date.setMinutes(date.getMinutes() - date.getTimezoneOffset());
                return date.toISOString().slice(0, 16);
            };
            
            document.getElementById('att-in').value = toLocalISO(data.clockIn);
            document.getElementById('att-out').value = toLocalISO(data.clockOut);
            document.getElementById('attendanceModal').style.display = 'block';
        }

        function closeAttModal() { document.getElementById('attendanceModal').style.display = 'none'; }

        // ê·¼ë¬´ ê¸°ë¡ ìˆ˜ì • ì €ì¥
        async function saveAttendanceEdit() {
            const id = document.getElementById('att-id').value;
            const nickname = document.getElementById('att-name').value;
            const clockIn = document.getElementById('att-in').value;
            const clockOut = document.getElementById('att-out').value;

            document.getElementById('loading-layer').style.display = 'flex';
            try {
                const res = await fetch(`/api/attendance/edit/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nickname, clockIn, clockOut })
                });
                
                if (res.ok) {
                    alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
                    closeAttModal();
                    calendarInstance.refetchEvents();
                } else {
                    alert("ìˆ˜ì • ì‹¤íŒ¨");
                }
            } catch (e) {
                console.error(e);
            } finally {
                document.getElementById('loading-layer').style.display = 'none';
            }
        }
    </script>
</body>
</html>