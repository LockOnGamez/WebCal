<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ğŸ“¦ ì¬ê³  ê´€ë¦¬ ì‹œìŠ¤í…œ</title>
    <style>
        body { padding: 30px; font-family: 'Pretendard', sans-serif; max-width: 800px; margin: 0 auto; }
        h1 { border-bottom: 2px solid #333; padding-bottom: 10px; }
        
        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .input-box { background: #f9f9f9; padding: 20px; border-radius: 8px; margin-bottom: 30px; border: 1px solid #ddd; }
        .input-box input, .input-box select { padding: 10px; margin-right: 5px; width: 150px; }
        .input-box button { padding: 10px 20px; background: #333; color: white; border: none; cursor: pointer; }
        
        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        table { width: 100%; border-collapse: collapse; }
        th, td { border-bottom: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background: #f1f1f1; }
        
        /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .btn-inc { background: #4CAF50; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }
        .btn-dec { background: #ff9800; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }
        .btn-del { background: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; }
    </style>
</head>
<body>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h1>ğŸ“¦ ì¬ê³  ê´€ë¦¬ í˜„í™©</h1>
        <div>
            <span id="user-display" style="font-weight: bold; margin-right: 10px;"></span>
            <button onclick="location.href='/calendar.html'" style="background-color: #2196F3; margin-right: 5px;">ğŸ“… ë‹¬ë ¥ ë³´ëŸ¬ê°€ê¸°</button>
            <button onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="input-box">
        <h3>â• ìƒˆ ë¬¼í’ˆ ë“±ë¡</h3>
        <input type="text" id="new-name" placeholder="ë¬¼í’ˆëª… (ì˜ˆ: A4ìš©ì§€)">
        <input type="number" id="new-qty" placeholder="ìˆ˜ëŸ‰" value="0">
        <select id="new-category">
            <option value="ì‚¬ë¬´ìš©í’ˆ">ì‚¬ë¬´ìš©í’ˆ</option>
            <option value="ì „ìì œí’ˆ">ì „ìì œí’ˆ</option>
            <option value="ì‹ìŒë£Œ">ì‹ìŒë£Œ</option>
            <option value="ê¸°íƒ€">ê¸°íƒ€</option>
        </select>
        <input type="text" id="new-desc" placeholder="ë¹„ê³ /ì„¤ëª…">
        <button onclick="addItem()">ë“±ë¡</button>
    </div>

    <table>
        <thead>
            <tr>
                <th>ì¹´í…Œê³ ë¦¬</th>
                <th>ë¬¼í’ˆëª…</th>
                <th>ìˆ˜ëŸ‰</th>
                <th>ì„¤ëª…</th>
                <th>ìµœê·¼ ìˆ˜ì •ì</th>
                <th>ê´€ë¦¬</th>
            </tr>
        </thead>
        <tbody id="inventory-list">
            </tbody>
    </table>

    <script>
        const API_URL = '/api/inventory';
        const currentUser = localStorage.getItem('username');

        // ë¡œê·¸ì¸ ì•ˆí–ˆìœ¼ë©´ ë‚´ì«“ê¸°
        if (!currentUser) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            location.href = '/';
        } else {
            document.getElementById('user-display').innerText = currentUser + "ë‹˜";
            loadItems(); // í˜ì´ì§€ ì—´ë¦¬ë©´ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        }

        // 1. ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadItems() {
            const res = await fetch(API_URL);
            const items = await res.json();
            
            const list = document.getElementById('inventory-list');
            list.innerHTML = '';

            items.forEach(item => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${item.category}</td>
                    <td style="font-weight:bold;">${item.name}</td>
                    <td>
                        <button class="btn-dec" onclick="updateStock('${item._id}', ${item.quantity - 1})">-</button>
                        <span style="margin: 0 10px; font-size: 1.2em;">${item.quantity}</span>
                        <button class="btn-inc" onclick="updateStock('${item._id}', ${item.quantity + 1})">+</button>
                    </td>
                    <td>${item.description || '-'}</td>
                    <td style="font-size: 0.8em; color: gray;">${item.lastUpdatedBy || '-'}</td>
                    <td>
                        <button class="btn-del" onclick="deleteItem('${item._id}')">ì‚­ì œ</button>
                    </td>
                `;
                list.appendChild(tr);
            });
        }

        // 2. ë¬¼í’ˆ ë“±ë¡
        async function addItem() {
            const name = document.getElementById('new-name').value;
            const quantity = document.getElementById('new-qty').value;
            const category = document.getElementById('new-category').value;
            const description = document.getElementById('new-desc').value;

            if(!name) return alert("ë¬¼í’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”");

            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    name, quantity, category, description, 
                    username: currentUser // ëˆ„ê°€ ë“±ë¡í–ˆëŠ”ì§€ ì „ì†¡
                })
            });

            if(res.ok) {
                alert("ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
                document.getElementById('new-name').value = '';
                document.getElementById('new-desc').value = '';
                loadItems(); // ëª©ë¡ ê°±ì‹ 
            } else {
                alert("ë“±ë¡ ì‹¤íŒ¨");
            }
        }

        // 3. ìˆ˜ëŸ‰ ìˆ˜ì • (+/-)
        async function updateStock(id, newQty) {
            if(newQty < 0) return alert("ìˆ˜ëŸ‰ì€ 0ë³´ë‹¤ ì‘ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

            const res = await fetch(`${API_URL}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    quantity: newQty, 
                    username: currentUser // ëˆ„ê°€ ìˆ˜ì •í–ˆëŠ”ì§€ ì „ì†¡
                })
            });

            if(res.ok) {
                loadItems(); // ëª©ë¡ ê°±ì‹  (í™”ë©´ ê¹œë¹¡ì„ ì—†ì´ ìˆ«ìë§Œ ë°”ê¾¸ê³  ì‹¶ì§€ë§Œ, ì¼ë‹¨ ê°„ë‹¨í•˜ê²Œ ì¬ë¡œë”©)
            }
        }

        // 4. ì‚­ì œ
        async function deleteItem(id) {
            if(!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

            const res = await fetch(`${API_URL}/${id}`, { method: 'DELETE' });

            if(res.ok) {
                loadItems();
            }
        }

        function logout() {
            localStorage.removeItem('username');
            location.href = '/';
        }
    </script>
</body>
</html>