<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ“¦ ì¬ê³  ê´€ë¦¬ (ë“œë¡­ë‹¤ìš´í˜•)</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        body { padding: 15px; font-family: 'Pretendard', sans-serif; background-color: #f8f9fa; margin: 0; color: #333; }
        h1 { font-size: 1.4rem; margin: 0; }
        .header-box { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-wrap: wrap; gap: 10px; }
        .nav-btns { display: flex; gap: 8px; }
        .btn-nav { padding: 8px 12px; border-radius: 6px; border: none; font-weight: bold; cursor: pointer; font-size: 13px; text-decoration: none; }
        .btn-blue { background: #2196F3; color: white; }
        .btn-gray { background: #ffffff; border: 1px solid #ddd; }
        .input-box { background: white; padding: 18px; border-radius: 12px; margin-bottom: 25px; border: 1px solid #e9ecef; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .input-box h3 { margin: 0 0 15px 0; font-size: 1rem; color: #495057; display: flex; align-items: center; gap: 5px; }
        .input-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        
        /* í•µì‹¬ ìˆ˜ì •: input ëŒ€ì‹  select ì‚¬ìš© */
        .input-grid select, .input-grid input { 
            width: 100%; 
            padding: 12px; 
            border: 1px solid #dee2e6; 
            border-radius: 8px; 
            font-size: 15px; 
            box-sizing: border-box; 
            background-color: #fff;
        }
        .full-width { grid-column: span 2; }
        .btn-submit { background: #343a40; color: white; border: none; padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 16px; margin-top: 10px; }

        /* ë¦¬ìŠ¤íŠ¸ ë° ì¹´ë“œ ìŠ¤íƒ€ì¼ (ì´ì „ê³¼ ë™ì¼) */
        .pc-table { width: 100%; border-collapse: collapse; background: white; border-radius: 12px; overflow: hidden; display: none; }
        .pc-table th { background: #f1f3f5; padding: 15px; font-size: 14px; border-bottom: 2px solid #dee2e6; }
        .pc-table td { padding: 15px; text-align: center; border-bottom: 1px solid #eee; }
        .mobile-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 12px; border: 1px solid #e9ecef; display: block; }
        .qty-control { display: flex; align-items: center; justify-content: space-between; background: #f8f9fa; padding: 8px 15px; border-radius: 10px; }
        .qty-btn { width: 40px; height: 40px; border: none; border-radius: 8px; font-size: 20px; font-weight: bold; cursor: pointer; }
        .btn-dec { background: #ff9f43; color: white; }
        .btn-inc { background: #28c76f; color: white; }
        .btn-del-card { background: #ff4757; color: white; border: none; padding: 8px 15px; border-radius: 8px; }

        @media (min-width: 768px) {
            .pc-table { display: table; }
            .mobile-card { display: none; }
            .input-grid { grid-template-columns: repeat(5, 1fr); }
            .full-width { grid-column: auto; }
            .btn-submit { margin-top: 0; }
        }
    </style>
</head>
<body>
    <div class="header-box">
        <h1>ğŸ“¦ ì¬ê³  ê´€ë¦¬</h1>
        <div class="nav-btns">
            <button class="btn-nav btn-blue" onclick="location.href='/calendar.html'">ğŸ“… ë‹¬ë ¥</button>
            <button class="btn-nav btn-gray" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="input-box">
        <h3>â• ìƒˆ ë¬¼í’ˆ ë“±ë¡ (ì„¤ì •ê°’ ì„ íƒ)</h3>
        <div class="input-grid">
            <select id="new-name" class="full-width"><option value="">í’ˆëª© ì„ íƒ</option></select>
            <select id="new-size"><option value="">ì‚¬ì´ì¦ˆ ì„ íƒ</option></select>
            <select id="new-length"><option value="">ê¸¸ì´ ì„ íƒ</option></select>
            <input type="number" id="new-qty" value="0" placeholder="ì´ˆê¸°ìˆ˜ëŸ‰">
            <select id="new-category">
                <option value="ê¸°íƒ€">ì¹´í…Œê³ ë¦¬</option>
                <option value="ì›ìì¬">ì›ìì¬</option>
                <option value="ì™„ì œí’ˆ">ì™„ì œí’ˆ</option>
            </select>
            <button class="btn-submit full-width" onclick="addItem()">ë¬¼í’ˆ ë“±ë¡í•˜ê¸°</button>
        </div>
    </div>

    <div id="user-info" style="margin-bottom: 10px; font-size: 14px; font-weight: bold; color: #666;"></div>

    <div class="inventory-container">
        <table class="pc-table">
            <thead>
                <tr><th>ì¹´í…Œê³ ë¦¬</th><th>í’ˆëª©ëª…</th><th>ì‚¬ì´ì¦ˆ</th><th>ê¸¸ì´</th><th>ìˆ˜ëŸ‰</th><th>ê´€ë¦¬</th></tr>
            </thead>
            <tbody id="pc-list"></tbody>
        </table>
        <div id="mobile-list"></div>
    </div>

    <script>
        const API_URL = '/api/inventory';
        const API_OPT = '/api/options'; // ì˜µì…˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ê²½ë¡œ
        const currentUser = localStorage.getItem('username');

        if (!currentUser) { location.href = '/'; }
        document.getElementById('user-info').innerText = `ğŸ‘¤ ì ‘ì†ì: ${currentUser}ë‹˜`;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì˜µì…˜ê³¼ ë¦¬ìŠ¤íŠ¸ë¥¼ í•¨ê»˜ ë¶ˆëŸ¬ì˜´
        window.onload = async function() {
            await loadOptions();
            await loadItems();
        };

        // 1. ê´€ë¦¬ì ì„¤ì •ì—ì„œ ë“±ë¡í•œ ì˜µì…˜ë“¤(í’ˆëª©, ì‚¬ì´ì¦ˆ, ê¸¸ì´)ì„ ë¶ˆëŸ¬ì™€ ë“œë¡­ë‹¤ìš´ì— ì‚½ì…
        async function loadOptions() {
            try {
                const res = await fetch(API_OPT);
                const options = await res.json();
                
                const nameSelect = document.getElementById('new-name');
                const sizeSelect = document.getElementById('new-size');
                const lenSelect = document.getElementById('new-length');

                options.forEach(opt => {
                    const el = document.createElement('option');
                    el.value = opt.value;
                    el.innerText = opt.value;

                    if (opt.type === 'itemName' || opt.type === 'item') nameSelect.appendChild(el);
                    else if (opt.type === 'size') sizeSelect.appendChild(el.cloneNode(true));
                    else if (opt.type === 'length') lenSelect.appendChild(el.cloneNode(true));
                });
            } catch (err) { console.error("ì˜µì…˜ ë¡œë“œ ì‹¤íŒ¨:", err); }
        }

        async function loadItems() {
            try {
                const res = await fetch(API_URL);
                const items = await res.json();
                const pcList = document.getElementById('pc-list');
                const mobileList = document.getElementById('mobile-list');
                pcList.innerHTML = '';
                mobileList.innerHTML = '';

                items.forEach(item => {
                    // PC í…Œì´ë¸”ìš©
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.category}</td>
                        <td style="font-weight:bold;">${item.name}</td>
                        <td>${item.size}</td>
                        <td>${item.length}</td>
                        <td>
                            <button class="qty-btn btn-dec" style="width:25px; height:25px; font-size:14px;" onclick="updateStock('${item._id}', ${item.quantity - 1})">-</button>
                            <b style="margin:0 10px">${item.quantity}</b>
                            <button class="qty-btn btn-inc" style="width:25px; height:25px; font-size:14px;" onclick="updateStock('${item._id}', ${item.quantity + 1})">+</button>
                        </td>
                        <td><button onclick="deleteItem('${item._id}')" class="btn-del-card">ì‚­ì œ</button></td>
                    `;
                    pcList.appendChild(tr);

                    // ëª¨ë°”ì¼ ì¹´ë“œìš©
                    const card = document.createElement('div');
                    card.className = 'mobile-card';
                    card.innerHTML = `
                        <div style="display:flex; justify-content:space-between;">
                            <b style="font-size:1.1rem;">${item.name}</b>
                            <span style="font-size:12px; color:#666;">${item.category}</span>
                        </div>
                        <div style="margin:8px 0; color:#666; font-size:14px;">ê·œê²©: ${item.size} / ${item.length}</div>
                        <div class="qty-control">
                            <button class="qty-btn btn-dec" onclick="updateStock('${item._id}', ${item.quantity - 1})">-</button>
                            <span style="font-size:1.2rem; font-weight:bold;">${item.quantity}</span>
                            <button class="qty-btn btn-inc" onclick="updateStock('${item._id}', ${item.quantity + 1})">+</button>
                            <button onclick="deleteItem('${item._id}')" class="btn-del-card">ì‚­ì œ</button>
                        </div>
                    `;
                    mobileList.appendChild(card);
                });
            } catch (err) { console.error(err); }
        }

        async function addItem() {
            const name = document.getElementById('new-name').value;
            const size = document.getElementById('new-size').value || "-";
            const length = document.getElementById('new-length').value || "-";
            const quantity = Number(document.getElementById('new-qty').value);
            const category = document.getElementById('new-category').value;

            if(!name) return alert("í’ˆëª©ì„ ì„ íƒí•´ ì£¼ì„¸ìš”.");

            const res = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, size, length, quantity, category, username: currentUser })
            });

            if(res.ok) {
                // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
                document.getElementById('new-qty').value = 0;
                loadItems();
            }
        }

        async function updateStock(id, newQty) {
            if(newQty < 0) return;
            await fetch(`${API_URL}/${id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ quantity: newQty, username: currentUser })
            });
            loadItems();
        }

        async function deleteItem(id) {
            if(!confirm("ì¬ê³  ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await fetch(`${API_URL}/${id}`, { method: 'DELETE' });
            loadItems();
        }

        function logout() { localStorage.removeItem('username'); location.href = '/'; }
    </script>
</body>
</html>