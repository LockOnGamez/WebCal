<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ  ìŠ¤ë§ˆíŠ¸ ê³µì¥ ì‹œìŠ¤í…œ</title>
    <style>
        body { 
            padding: 15px; 
            font-family: 'Pretendard', -apple-system, sans-serif; 
            background-color: #f4f7f9; 
            margin: 0; 
            color: #334155; 
        }
        .header { margin: 20px 0; text-align: center; }
        .header h1 { font-size: 1.5rem; margin-bottom: 5px; color: #1e293b; }
        .user-name { color: #2196F3; font-weight: 800; }

        /* ë©”ë‰´ ê·¸ë¦¬ë“œ: ëª¨ë°”ì¼ì—ì„œ í„°ì¹˜í•˜ê¸° ì‰¬ìš´ í¬ê¸°ë¡œ ì¡°ì • */
        .menu-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 12px; 
            max-width: 500px; 
            margin: 0 auto; 
        }

        .menu-card {
            background: white; 
            border-radius: 20px; 
            padding: 20px 10px; 
            text-align: center;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); 
            cursor: pointer;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            gap: 10px;
            transition: transform 0.1s;
            border: none;
            min-height: 140px;
        }
        .menu-card:active { transform: scale(0.95); background-color: #f8fafc; }
        .menu-card .icon { font-size: 2.5rem; }
        .menu-card span { font-weight: 700; font-size: 1.1rem; }

        /* ìƒì‚° ê¸°ë¡ ë²„íŠ¼ ê°•ì¡° (ê°€ë¡œ ì „í­) */
        .card-prod { 
            grid-column: span 2; 
            background: #28a745; 
            color: white;
            flex-direction: row; 
            min-height: 90px;
            margin-top: 5px;
        }
        .card-prod .icon { font-size: 2.2rem; margin-right: 15px; }
        .card-prod span { font-size: 1.3rem; }

        /* ê´€ë¦¬ì ëª¨ë“œ */
        .card-admin { 
            grid-column: span 2; 
            background: #f1f5f9; 
            color: #64748b;
            min-height: 60px;
            flex-direction: row;
        }

        .logout-btn {
            margin: 30px auto; 
            width: 100px; 
            padding: 10px;
            background: #e2e8f0; 
            color: #64748b; 
            border: none; 
            border-radius: 10px;
            font-weight: 600; 
            cursor: pointer; 
            display: block;
        }

        #loading-layer { 
            display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: white; z-index: 9999; justify-content: center; align-items: center; flex-direction: column; 
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2196F3; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-layer"><div class="spinner"></div><p>ì •ë³´ ë™ê¸°í™” ì¤‘...</p></div>

    <div class="header">
        <h1>ì•ˆë…•í•˜ì„¸ìš”, <span id="user-display" class="user-name">...</span>ë‹˜!</h1>
    </div>

    <div class="menu-grid">
        <button class="menu-card" id="btn-check-in" onclick="handleAttendance('check-in')">
            <div class="icon">ğŸŒ…</div><span>ì¶œê·¼ ì²´í¬</span>
        </button>
        <button class="menu-card" id="btn-check-out" onclick="handleAttendance('check-out')">
            <div class="icon">ğŸŒ™</div><span>í‡´ê·¼ ì²´í¬</span>
        </button>
        <button class="menu-card" style="color:#3b82f6;" onclick="location.href='/inventory.html'">
            <div class="icon">ğŸ“¦</div><span>ì¬ê³  ê´€ë¦¬</span>
        </button>
        <button class="menu-card" style="color:#f59e0b;" onclick="location.href='/calendar.html'">
            <div class="icon">ğŸ“…</div><span>ì—…ë¬´ ë‹¬ë ¥</span>
        </button>
        <button class="menu-card card-prod" onclick="location.href='/production.html'">
            <div class="icon">ğŸ”¨</div><span>ìƒì‚° ê¸°ë¡ ë“±ë¡</span>
        </button>
        <button id="admin-menu" class="menu-card card-admin" style="display:none;" onclick="location.href='/admin.html'">
            <div class="icon">ğŸ›¡ï¸</div><span>ê´€ë¦¬ì ëª¨ë“œ</span>
        </button>
    </div>

    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>

    <script>
        const currentUser = localStorage.getItem('username');
        const currentNick = localStorage.getItem('nickname');

        window.onload = async () => {
            if (!currentUser) { location.href = '/'; return; }
            document.getElementById('user-display').innerText = currentNick || currentUser;
            try {
                await Promise.all([checkAdminStatus(), checkAttendanceStatus()]);
            } catch (err) { console.error(err); }
            finally { document.getElementById('loading-layer').style.display = 'none'; }
        };

        async function checkAdminStatus() {
            const res = await fetch(`/api/admin/check`);
            const data = await res.json();
            if (data.isAdmin) document.getElementById('admin-menu').style.display = 'flex';
        }

        async function checkAttendanceStatus() {
            const res = await fetch(`/api/attendance/status/${currentUser}`);
            const data = await res.json();
            if (data) {
                if (data.clockIn) updateButtonUI('check-in', data.clockIn);
                if (data.clockOut) updateButtonUI('check-out', data.clockOut);
            }
        }

        function updateButtonUI(type, isoTime) {
            const time = new Date(isoTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isBtnIn = type === 'check-in';
            const btn = document.getElementById(isBtnIn ? 'btn-check-in' : 'btn-check-out');
            btn.onclick = null;
            btn.style.backgroundColor = '#f1f5f9';
            btn.innerHTML = `<div class="icon">${isBtnIn ? 'âœ…' : 'ğŸ'}</div><span style="color: #94a3b8;">${isBtnIn ? 'ì¶œê·¼' : 'í‡´ê·¼'} ì™„ë£Œ</span><small>${time}</small>`;
        }

        async function handleAttendance(type) {
            if (!confirm(`ì²´í¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const res = await fetch(`/api/attendance/${type}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username: currentUser, nickname: currentNick })
            });
            if (res.ok) location.reload();
        }

        function logout() { localStorage.clear(); location.href = '/'; }
    </script>
</body>
</html>