<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ  ìŠ¤ë§ˆíŠ¸ ê³µì¥ ì‹œìŠ¤í…œ</title>
    <style>
        /* ê¸°ë³¸ ë² ì´ìŠ¤ ìŠ¤íƒ€ì¼ */
        body { 
            padding: 20px; 
            font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, system-ui, Roboto, sans-serif; 
            background-color: #f4f7f9; 
            margin: 0; 
            color: #334155; 
            -webkit-tap-highlight-color: transparent;
        }

        .header { margin: 30px 0; text-align: center; }
        .header h1 { font-size: 1.4rem; margin-bottom: 5px; color: #1e293b; }
        .user-name { color: #2196F3; font-weight: 800; }
        .header p { color: #64748b; font-size: 0.9rem; margin: 0; }

        /* ë©”ë‰´ ê·¸ë¦¬ë“œ: 2ì—´ ìë™ ë°°ì¹˜ */
        .menu-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); 
            gap: 15px; 
            max-width: 500px; 
            margin: 0 auto; 
        }

        /* ë©”ë‰´ ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .menu-card {
            background: white; 
            border-radius: 24px; 
            padding: 25px 10px; 
            text-align: center;
            box-shadow: 0 10px 20px rgba(0,0,0,0.03); 
            border: 2px solid transparent; 
            cursor: pointer;
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center;
            gap: 12px;
            transition: all 0.2s ease;
            min-height: 150px;
        }

        .menu-card:active { 
            transform: scale(0.95); 
            background-color: #f8fafc; 
        }

        .menu-card .icon { font-size: 2.2rem; }
        .menu-card span { font-weight: 700; font-size: 1.05rem; }

        /* ìƒíƒœë³„ ìƒ‰ìƒ í¬ì¸íŠ¸ */
        .card-stock { color: #3b82f6; }
        .card-cal { color: #f59e0b; }
        
        /* ìƒì‚° ê¸°ë¡ ë²„íŠ¼ (ê°•ì¡°í˜•) */
        .card-prod { 
            grid-column: span 2; /* 5ë²ˆì§¸ ë²„íŠ¼ì´ë¯€ë¡œ ê°€ë¡œ ì „ì²´ ì±„ìš°ê¸° */
            background: #ecfdf5; 
            border-color: #10b981; 
            color: #047857;
            flex-direction: row; /* ëª¨ë°”ì¼ì—ì„œ ê°€ë¡œí˜•ìœ¼ë¡œ í‘œì‹œ */
            min-height: 100px;
            margin-top: 5px;
        }
        .card-prod .icon { font-size: 2rem; margin-right: 10px; }

        /* ê´€ë¦¬ì ì „ìš© ìŠ¤íƒ€ì¼ */
        .card-admin { 
            grid-column: span 2; 
            border: 2px dashed #6366f1; 
            color: #4f46e5;
            background: #f5f3ff;
            min-height: 80px;
            flex-direction: row;
        }

        /* ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ */
        .logout-btn {
            margin: 40px auto 20px auto; 
            width: 120px; 
            padding: 12px;
            background: #e2e8f0; 
            color: #64748b; 
            border: none; 
            border-radius: 12px;
            font-weight: 600; 
            cursor: pointer; 
            display: block;
            font-size: 0.9rem;
        }

        /* ë¡œë”© ë ˆì´ì–´ */
        #loading-layer { 
            display: flex; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.9); z-index: 9999; 
            justify-content: center; align-items: center; flex-direction: column; 
            backdrop-filter: blur(5px);
        }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #2196F3; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ëª¨ë°”ì¼ ìµœì í™” ë¯¸ì„¸ ì¡°ì • */
        @media (max-width: 400px) {
            .menu-grid { gap: 10px; }
            .menu-card { min-height: 130px; border-radius: 20px; }
            .menu-card span { font-size: 0.95rem; }
        }
    </style>
</head>
<body>
    <div id="loading-layer">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: bold;">ì •ë³´ ë™ê¸°í™” ì¤‘...</p>
    </div>

    <div class="header">
        <h1>ì•ˆë…•í•˜ì„¸ìš”, <span id="user-display" class="user-name">...</span>ë‹˜!</h1>
        <p>ì˜¤ëŠ˜ì˜ ì—…ë¬´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
    </div>

    <div class="menu-grid">
        <button class="menu-card" id="btn-check-in" onclick="handleAttendance('check-in')">
            <div class="icon">ğŸŒ…</div>
            <span>ì¶œê·¼ ì²´í¬</span>
        </button>
        <button class="menu-card" id="btn-check-out" onclick="handleAttendance('check-out')">
            <div class="icon">ğŸŒ™</div>
            <span>í‡´ê·¼ ì²´í¬</span>
        </button>

        <button class="menu-card card-stock" onclick="location.href='/inventory.html'">
            <div class="icon">ğŸ“¦</div>
            <span>ì¬ê³  ê´€ë¦¬</span>
        </button>
        <button class="menu-card card-cal" onclick="location.href='/calendar.html'">
            <div class="icon">ğŸ“…</div>
            <span>ì‘ì—…/ê·¼ë¬´ ë‹¬ë ¥</span>
        </button>
        
        <button class="menu-card card-prod" onclick="location.href='/production.html'">
            <div class="icon">ğŸ”¨</div>
            <span>ìƒì‚° ê¸°ë¡ ë“±ë¡</span>
        </button>

        <button id="admin-menu" class="menu-card card-admin" style="display:none;" onclick="location.href='/admin.html'">
            <div class="icon">ğŸ›¡ï¸</div>
            <span>ì‹œìŠ¤í…œ ê´€ë¦¬ì ëª¨ë“œ</span>
        </button>
    </div>

    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>

    <script>
        const currentUser = localStorage.getItem('username');
        const currentNick = localStorage.getItem('nickname');

        window.onload = async () => {
            if (!currentUser) { location.href = '/'; return; }
            document.getElementById('user-display').innerText = currentNick || currentUser;
            
            try {
                await Promise.all([
                    checkAdminStatus(),
                    checkAttendanceStatus()
                ]);
            } catch (err) {
                console.error(err);
            } finally {
                setTimeout(() => {
                    document.getElementById('loading-layer').style.display = 'none';
                }, 300);
            }
        };

        async function checkAdminStatus() {
            try {
                const res = await fetch(`/api/admin/check`);
                const data = await res.json();
                if (data.isAdmin) {
                    document.getElementById('admin-menu').style.display = 'flex';
                }
            } catch (err) { console.log("ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œ"); }
        }

        async function checkAttendanceStatus() {
            try {
                const res = await fetch(`/api/attendance/status/${currentUser}`);
                const data = await res.json();
                if (data) {
                    if (data.clockIn) updateButtonUI('check-in', data.clockIn);
                    if (data.clockOut) updateButtonUI('check-out', data.clockOut);
                }
            } catch (err) { console.error(err); }
        }

        function updateButtonUI(type, isoTime) {
            const time = new Date(isoTime).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
            const isBtnIn = type === 'check-in';
            const btn = document.getElementById(isBtnIn ? 'btn-check-in' : 'btn-check-out');
            btn.onclick = null;
            btn.style.backgroundColor = '#f1f5f9';
            btn.innerHTML = `
                <div class="icon">${isBtnIn ? 'âœ…' : 'ğŸ'}</div>
                <span style="color: #94a3b8;">${isBtnIn ? 'ì¶œê·¼' : 'í‡´ê·¼'} ì™„ë£Œ</span>
                <small style="font-size: 0.8rem; color: #64748b; font-weight: bold;">${time}</small>
            `;
        }

        async function handleAttendance(type) {
            const modeName = type === 'check-in' ? 'ì¶œê·¼' : 'í‡´ê·¼';
            if (!confirm(`${modeName} ì²´í¬ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            
            try {
                const res = await fetch(`/api/attendance/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, nickname: currentNick })
                });
                if (res.ok) { location.reload(); } 
                else { const data = await res.json(); alert(data.message); }
            } catch (err) { alert("í†µì‹  ì˜¤ë¥˜"); }
        }

        function logout() {
            localStorage.clear();
            location.href = '/';
        }
    </script>
</body>
</html>