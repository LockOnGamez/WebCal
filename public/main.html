<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ  ìŠ¤ë§ˆíŠ¸ ê³µì¥ ì‹œìŠ¤í…œ</title>
    <style>
        body { padding: 20px; font-family: 'Pretendard', sans-serif; background-color: #f4f7f9; margin: 0; color: #333; }
        .header { margin-bottom: 30px; text-align: center; }
        .header h1 { font-size: 1.5rem; color: #1e293b; }
        .user-name { color: #2196F3; font-weight: 800; }

        /* ì¹´ë“œ ê·¸ë¦¬ë“œ ë ˆì´ì•„ì›ƒ */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; max-width: 500px; margin: 0 auto; }
        @media (max-width: 350px) { .menu-grid { grid-template-columns: 1fr; } }

        .menu-card {
            background: white; border-radius: 24px; padding: 25px 15px; text-align: center;
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); border: none; cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex; flex-direction: column; align-items: center; gap: 12px;
            min-height: 160px; justify-content: center;
        }
        .menu-card:active { transform: scale(0.95); background-color: #f8fafc; }
        .menu-card .icon { font-size: 2.5rem; }
        .menu-card span { font-weight: 700; font-size: 1.1rem; }

        /* ìƒ‰ìƒ í¬ì¸íŠ¸ */
        .card-in { color: #10b981; }
        .card-out { color: #ef4444; }
        .card-stock { color: #3b82f6; }
        .card-cal { color: #f59e0b; }
        .card-admin { color: #6366f1; border: 2px dashed #6366f1; } /* ê´€ë¦¬ì ë²„íŠ¼ ê°•ì¡° */

        .logout-btn {
            margin-top: 40px; width: 100%; max-width: 200px; padding: 12px;
            background: #cbd5e1; color: #475569; border: none; border-radius: 12px;
            font-weight: bold; cursor: pointer; display: block; margin: 40px auto 0 auto;
        }

        /* ê´€ë¦¬ì ë²„íŠ¼ ì´ˆê¸° ìˆ¨ê¹€ */
        #admin-menu { display: none; }
    </style>
</head>
<body>
    <div class="header">
        <h1>ì•ˆë…•í•˜ì„¸ìš”, <span id="user-display" class="user-name">...</span>ë‹˜!</h1>
        <p style="color: #64748b; font-size: 0.9rem;">ì˜¤ëŠ˜ì˜ ì—…ë¬´ë¥¼ ì„ íƒí•´ ì£¼ì„¸ìš”.</p>
    </div>

    <div class="menu-grid">
        <button class="menu-card card-in" id="btn-check-in" onclick="handleAttendance('check-in')">
            <div class="icon">ğŸŒ…</div>
            <span>ì¶œê·¼ ì²´í¬</span>
        </button>
        <button class="menu-card card-out" id="btn-check-out" onclick="handleAttendance('check-out')">
            <div class="icon">ğŸŒ™</div>
            <span>í‡´ê·¼ ì²´í¬</span>
        </button>
        <button class="menu-card card-stock" onclick="location.href='/inventory.html'">
            <div class="icon">ğŸ“¦</div>
            <span>ì¬ê³  ê´€ë¦¬</span>
        </button>
        <button class="menu-card card-cal" onclick="location.href='/calendar.html'">
            <div class="icon">ğŸ“…</div>
            <span>ì‘ì—…/ê·¼ë¬´ ë‹¬ë ¥</span>
        </button>
        
        <button id="admin-menu" class="menu-card card-admin" onclick="location.href='/admin.html'">
            <div class="icon">ğŸ›¡ï¸</div>
            <span>ì‹œìŠ¤í…œ ê´€ë¦¬</span>
        </button>
    </div>

    <button class="logout-btn" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>

    <script>
        const currentUser = localStorage.getItem('username');
        const currentNick = localStorage.getItem('nickname');

        window.onload = async () => {
            if (!currentUser) { location.href = '/'; return; }
            document.getElementById('user-display').innerText = currentNick || currentUser;
            
            // 1. ê´€ë¦¬ì ê¶Œí•œ í™•ì¸ ë° ë²„íŠ¼ ë…¸ì¶œ
            await checkAdminStatus();
            
            // 2. ì˜¤ëŠ˜ì˜ ì¶œí‡´ê·¼ ìƒíƒœ í™•ì¸
            await checkAttendanceStatus();
            
            // 3. ê³µíœ´ì¼ ë¯¸ë¦¬ ë¡œë“œ
            prefetchHolidays();
        };

        // [ì¶”ê°€] ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸ í•¨ìˆ˜
        async function checkAdminStatus() {
            try {
                // ì„œë²„ ì„¸ì…˜ ì •ë³´ë¥¼ í™•ì¸í•˜ëŠ” ê²½ë¡œ (ì—†ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ ê¸°ì¡´ ë°ì´í„° í™œìš© ê°€ëŠ¥)
                // ì—¬ê¸°ì„œëŠ” ë¡œê·¸ì¸ ì‹œ ì €ì¥ëœ role ì •ë³´ë¥¼ ì‚¬ìš©í•˜ê±°ë‚˜ ì„œë²„ì— ì§ì ‘ ë¬¼ì–´ë´…ë‹ˆë‹¤.
                const res = await fetch(`/api/admin/check`); // ì„œë²„ì— ê´€ë¦¬ì ì—¬ë¶€ í™•ì¸ API í˜¸ì¶œ
                const data = await res.json();

                if (data.isAdmin) {
                    document.getElementById('admin-menu').style.display = 'flex';
                    // ê´€ë¦¬ìì¼ ê²½ìš° ê·¸ë¦¬ë“œë¥¼ í™€ìˆ˜ ê°œ(5ê°œ)ì— ë§ì¶° ì¡°ì •í•˜ê±°ë‚˜ ìŠ¤íƒ€ì¼ ë³€ê²½ ê°€ëŠ¥
                    const grid = document.querySelector('.menu-grid');
                    grid.style.maxWidth = '600px'; 
                }
            } catch (err) {
                console.log("ì¼ë°˜ ì‚¬ìš©ì ëª¨ë“œë¡œ ì§„ì…í•©ë‹ˆë‹¤.");
            }
        }

        async function prefetchHolidays() {
            const currentYear = new Date().getFullYear();
            const yearsToFetch = [currentYear, currentYear + 1]; 
            let cache = JSON.parse(localStorage.getItem('holiday_cache')) || {};
            for (const year of yearsToFetch) {
                if (cache[year]) continue;
                try {
                    const res = await fetch(`/api/holidays/${year}`);
                    const data = await res.json();
                    cache[year] = data;
                    localStorage.setItem('holiday_cache', JSON.stringify(cache));
                } catch (e) { console.error(e); }
            }
        }

        async function checkAttendanceStatus() {
            try {
                const res = await fetch(`/api/attendance/status/${currentUser}`);
                const data = await res.json();
                if (data) {
                    if (data.clockIn) {
                        const inTime = new Date(data.clockIn).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        updateButtonUI('check-in', inTime);
                    }
                    if (data.clockOut) {
                        const outTime = new Date(data.clockOut).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        updateButtonUI('check-out', outTime);
                    }
                }
            } catch (err) { console.error(err); }
        }

        function updateButtonUI(type, time) {
            const isBtnIn = type === 'check-in';
            const btn = document.getElementById(isBtnIn ? 'btn-check-in' : 'btn-check-out');
            btn.onclick = null;
            btn.style.background = '#f1f5f9';
            btn.innerHTML = `
                <div class="icon">${isBtnIn ? 'âœ…' : 'ğŸ'}</div>
                <span style="color: #94a3b8;">${isBtnIn ? 'ì¶œê·¼' : 'í‡´ê·¼'} ì™„ë£Œ</span>
                <small style="font-size: 0.85rem; color: #64748b; margin-top: 5px; font-weight: bold;">${time}</small>
            `;
        }

        async function handleAttendance(type) {
            const modeName = type === 'check-in' ? 'ì¶œê·¼' : 'í‡´ê·¼';
            if (!confirm(`${modeName} ì²´í¬ë¥¼ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            try {
                const res = await fetch(`/api/attendance/${type}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: currentUser, nickname: currentNick })
                });
                if (res.ok) { await checkAttendanceStatus(); } 
                else { const data = await res.json(); alert(data.message); }
            } catch (err) { alert("í†µì‹  ì˜¤ë¥˜"); }
        }

        function logout() {
            localStorage.removeItem('username');
            localStorage.removeItem('nickname');
            location.href = '/';
        }
    </script>
</body>
</html>