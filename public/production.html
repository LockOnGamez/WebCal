<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ”¨ ìƒì‚° ê¸°ë¡ ë“±ë¡</title>
    <style>
        /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        body { background-color: #f4f7f9; padding: 10px; font-family: -apple-system, sans-serif; margin: 0; }
        .prod-container { 
            width: 100%; max-width: 500px; margin: 0 auto; background: white; 
            padding: 20px; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.05); box-sizing: border-box; 
        }
        h1 { font-size: 1.4rem; text-align: center; margin-bottom: 20px; color: #1e293b; }
        
        /* ë§ˆì§€ë§‰ ë°˜ì˜ ì‹œê°„ í‘œì‹œ */
        #last-update-info {
            text-align: center; color: #64748b; font-size: 0.9rem; margin-bottom: 20px; 
            background: #f1f5f9; padding: 10px; border-radius: 12px;
        }

        .input-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 8px; font-weight: bold; color: #475569; font-size: 0.95rem; }
        
        select, input { 
            width: 100%; height: 55px; padding: 0 15px; font-size: 17px; 
            border-radius: 12px; border: 1px solid #ddd; background-color: #fff; box-sizing: border-box; 
        }
        
        .tube-selection { display: flex; gap: 15px; padding: 5px 0; }
        .tube-selection label { font-weight: normal; font-size: 1rem; display: flex; align-items: center; gap: 5px; }
        .tube-selection input { width: 22px; height: 22px; }

        .submit-btn { 
            width: 100%; height: 60px; font-size: 1.2rem; background: #28a745; color: white; 
            border: none; border-radius: 15px; cursor: pointer; font-weight: bold; margin-top: 15px; 
        }
        .submit-btn:active { transform: scale(0.98); }
        .back-link { display: block; text-align: center; margin-top: 20px; color: #64748b; text-decoration: none; }

        /* [ì¶”ê°€] í™•ì¸ íŒì—… (Modal) ìŠ¤íƒ€ì¼ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-box {
            background: white; width: 90%; max-width: 400px; padding: 25px; 
            border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); text-align: center;
        }
        .modal-box h3 { margin: 0 0 15px 0; color: #1e293b; font-size: 1.3rem; }
        .modal-info { text-align: left; background: #f8fafc; padding: 15px; border-radius: 12px; margin-bottom: 20px; }
        .modal-info p { margin: 8px 0; font-size: 1rem; color: #475569; display: flex; justify-content: space-between; }
        .modal-info b { color: #1e293b; }
        .modal-btns { display: flex; gap: 10px; }
        .modal-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: #e2e8f0; color: #64748b; }
        .btn-confirm { background: #28a745; color: white; }

        /* [ì¶”ê°€] ë¡œë”© ë ˆì´ì–´ ìŠ¤íƒ€ì¼ */
        #loading-layer { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(255,255,255,0.8); z-index: 2000; 
            justify-content: center; align-items: center; flex-direction: column; 
        }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #28a745; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-layer">
        <div class="spinner"></div>
        <p style="margin-top: 15px; font-weight: bold; color: #28a745;">ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>ğŸ“‹ ê¸°ë¡ í™•ì¸</h3>
            <div class="modal-info">
                <p>í’ˆëª…: <b id="conf-name"></b></p>
                <p>í­: <b id="conf-width"></b></p>
                <p>ê¸¸ì´: <b id="conf-length"></b></p>
                <p>ì§€ê´€: <b id="conf-tube"></b></p>
                <p style="font-size: 1.2rem; margin-top: 10px; border-top: 1px solid #ddd; padding-top: 10px;">ìƒì‚° ìˆ˜ëŸ‰: <b id="conf-qty" style="color:#28a745;"></b></p>
            </div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn btn-confirm" onclick="finalSubmit()">í™•ì¸ (ì €ì¥)</button>
            </div>
        </div>
    </div>

    <div class="prod-container">
        <h1>ğŸ”¨ ìƒì‚° ê¸°ë¡ ë“±ë¡</h1>
        
        <div id="last-update-info">
            ë§ˆì§€ë§‰ ë°˜ì˜: <span id="last-update-time" style="font-weight: bold;">ë¡œë”© ì¤‘...</span>
        </div>

        <div class="input-group">
            <label>ì‚¬ìš© ì§€ê´€ ì„ íƒ</label>
            <div class="tube-selection">
                <label><input type="radio" name="tubeType" value="ì¢…ì´ì§€ê´€(6)" checked> ì¢…ì´(6)</label>
                <label><input type="radio" name="tubeType" value="ppì§€ê´€(6)"> PP(6)</label>
            </div>
        </div>
        
        <div class="input-group">
            <label>ì‚¬ìš©í•œ ì›ë‹¨</label>
            <select id="select-material"><option value="">ì›ë‹¨ ì„ íƒ</option></select>
        </div>

        <div class="input-group">
            <label>í­ (Width)</label>
            <select id="width"><option value="">í­ ì„ íƒ</option></select>
        </div>

        <div class="input-group">
            <label>ì‚¬ì´ì¦ˆ (ê¸¸ì´)</label>
            <select id="size"><option value="">ì‚¬ì´ì¦ˆ ì„ íƒ</option></select>
        </div>

        <div class="input-group">
            <label>ìƒì‚° ìˆ˜ëŸ‰ (ê°œ)</label>
            <input type="number" id="quantity" placeholder="ìˆ˜ëŸ‰ ì…ë ¥" inputmode="numeric">
        </div>

        <button class="submit-btn" onclick="openConfirmation()">ê¸°ë¡ ì €ì¥</button>
        <a href="main.html" class="back-link">ğŸ  ë©”ì¸ í™”ë©´ìœ¼ë¡œ</a>
    </div>

    <script>
        let pendingData = null; // ì „ì†¡ ëŒ€ê¸° ì¤‘ì¸ ë°ì´í„°

        window.onload = async () => {
            try {
                const [invRes, optRes] = await Promise.all([fetch('/api/inventory'), fetch('/api/options')]);
                const inventory = await invRes.json();
                const options = await optRes.json();

                // 1. ì›ìì¬ ë“œë¡­ë‹¤ìš´
                const materialSelect = document.getElementById('select-material');
                inventory.filter(item => item.category === 'ì›ìì¬').forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m._id;
                    opt.dataset.rawName = m.name;
                    opt.textContent = `${m.name} (ì”ì—¬: ${m.quantity})`;
                    materialSelect.appendChild(opt);
                });

                // 2. ì˜µì…˜ ë¶„ë¥˜
                const widthSelect = document.getElementById('width');
                const sizeSelect = document.getElementById('size');
                options.forEach(opt => {
                    const element = document.createElement('option');
                    element.value = opt.value;
                    element.textContent = opt.value;
                    if (opt.type === 'size') widthSelect.appendChild(element);
                    else if (opt.type === 'length') {
                        element.textContent = opt.value + "m";
                        sizeSelect.appendChild(element);
                    }
                });

                // 3. ë§ˆì§€ë§‰ ë°˜ì˜ ì‹œê°„ í‘œì‹œ
                if (inventory && inventory.length > 0) {
                    const sorted = inventory.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                    const lastItem = sorted[0];
                    if (lastItem && lastItem.updatedAt) {
                        const timeStr = new Date(lastItem.updatedAt).toLocaleString('ko-KR', {
                            month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                        document.getElementById('last-update-time').innerText = timeStr + " (" + lastItem.name + ")";
                    } else {
                        document.getElementById('last-update-time').innerText = "ê¸°ë¡ ì—†ìŒ";
                    }
                } else {
                    document.getElementById('last-update-time').innerText = "ê¸°ë¡ ì—†ìŒ";
                }

            } catch (err) { 
                alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"); 
                document.getElementById('last-update-time').innerText = "í†µì‹  ì˜¤ë¥˜";
            }
        };

        // 1ë‹¨ê³„: íŒì—… ë„ìš°ê¸°
        function openConfirmation() {
            const materialEl = document.getElementById('select-material');
            if (!materialEl.value) return alert("ì›ë‹¨ì„ ì„ íƒí•˜ì„¸ìš”.");
            
            const tubeName = document.querySelector('input[name="tubeType"]:checked').value;
            const width = document.getElementById('width').value;
            const size = document.getElementById('size').value;
            const quantity = document.getElementById('quantity').value;

            if(!width || !size || !quantity) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");

            // ë°ì´í„° ì„ì‹œ ì €ì¥
            pendingData = {
                materialId: materialEl.value,
                materialName: materialEl.options[materialEl.selectedIndex].text,
                category: materialEl.options[materialEl.selectedIndex].dataset.rawName,
                width: width,
                size: size.replace('m', ''),
                quantity: parseInt(quantity),
                tubeName: tubeName
            };

            // íŒì—… í…ìŠ¤íŠ¸ ì±„ìš°ê¸°
            document.getElementById('conf-name').innerText = pendingData.category;
            document.getElementById('conf-width').innerText = pendingData.width;
            document.getElementById('conf-length').innerText = pendingData.size + "m";
            document.getElementById('conf-tube').innerText = pendingData.tubeName;
            document.getElementById('conf-qty').innerText = pendingData.quantity + "ê°œ";

            // íŒì—… í‘œì‹œ
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            pendingData = null;
        }

        // 2ë‹¨ê³„: ì‹¤ì œ ì €ì¥ (ë¡œë”© í¬í•¨)
        async function finalSubmit() {
            if (!pendingData) return;

            // ë¡œë”© í‘œì‹œ
            document.getElementById('confirm-modal').style.display = 'none'; // íŒì—… ë‹«ê³ 
            document.getElementById('loading-layer').style.display = 'flex'; // ë¡œë”© ì—´ê³ 

            try {
                const res = await fetch('/api/inventory/produce', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pendingData)
                });

                if(res.ok) {
                    alert("âœ… ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    location.reload();
                } else {
                    const err = await res.json();
                    alert("âŒ ì˜¤ë¥˜: " + err.error);
                    document.getElementById('loading-layer').style.display = 'none';
                }
            } catch (err) {
                alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
                document.getElementById('loading-layer').style.display = 'none';
            }
        }
    </script>
</body>
</html>