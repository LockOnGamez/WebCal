<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ”¨ ìƒì‚° ê¸°ë¡ ë“±ë¡</title>
    <style>
        /* [UI ì»¨ì…‰] Smart Factory Dark Mode */
        body { 
            background-color: #0f172a; /* Deep Navy */
            color: #f1f5f9;
            padding: 20px; 
            font-family: 'Pretendard', -apple-system, sans-serif; 
            margin: 0; 
            display: flex;
            justify-content: center;
            min-height: 100vh;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ (Glass Card) */
        .prod-container { 
            width: 100%; 
            max-width: 500px; 
            background: rgba(30, 41, 59, 0.7); /* ë°˜íˆ¬ëª… ë„¤ì´ë¹„ */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            padding: 30px; 
            border-radius: 24px; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); 
            box-sizing: border-box; 
            height: fit-content;
            margin-top: 20px;
        }

        h1 { 
            font-size: 1.6rem; 
            text-align: center; 
            margin: 0 0 25px 0; 
            font-weight: 800;
            background: linear-gradient(to right, #4ade80, #3b82f6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì •ë³´ ë°°ì§€ */
        #last-update-info {
            text-align: center; 
            color: #94a3b8; 
            font-size: 0.9rem; 
            margin-bottom: 25px; 
            background: rgba(15, 23, 42, 0.6); 
            padding: 12px; 
            border-radius: 12px;
            border: 1px solid #334155;
        }

        .input-group { margin-bottom: 20px; }
        
        label { 
            display: block; 
            margin-bottom: 10px; 
            font-weight: 600; 
            color: #cbd5e1; 
            font-size: 0.95rem; 
        }
        
        /* ë‹¤í¬ ëª¨ë“œ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        select, input[type="number"], input[type="text"] { 
            width: 100%; 
            height: 55px; 
            padding: 0 15px; 
            font-size: 16px; 
            border-radius: 12px; 
            border: 1px solid #334155; 
            background-color: #0f172a; 
            color: white;
            box-sizing: border-box; 
            transition: 0.2s;
            appearance: none; /* ê¸°ë³¸ í™”ì‚´í‘œ ì œê±° (í•„ìš” ì‹œ ì»¤ìŠ¤í…€) */
        }
        
        select:focus, input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* ë¼ë””ì˜¤ ë²„íŠ¼ ê·¸ë£¹ ìŠ¤íƒ€ì¼ */
        .tube-selection { 
            display: flex; 
            gap: 15px; 
            padding: 5px 0; 
        }
        .tube-selection label { 
            font-weight: normal; 
            font-size: 1rem; 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            cursor: pointer;
            background: rgba(30, 41, 59, 0.5);
            padding: 10px 15px;
            border-radius: 10px;
            border: 1px solid #334155;
            transition: 0.2s;
        }
        .tube-selection label:hover { background: #334155; }
        .tube-selection input { 
            width: 20px; 
            height: 20px; 
            accent-color: #3b82f6; 
            margin: 0;
        }

        /* ë©”ì¸ ì•¡ì…˜ ë²„íŠ¼ (ìƒì‚° ë“±ë¡) */
        .submit-btn { 
            width: 100%; 
            height: 60px; 
            font-size: 1.1rem; 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: white; 
            border: none; 
            border-radius: 16px; 
            cursor: pointer; 
            font-weight: 800; 
            margin-top: 10px; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            transition: 0.2s;
        }
        .submit-btn:active { transform: scale(0.98); }

        /* ë’¤ë¡œê°€ê¸° ë§í¬ */
        .back-link { 
            display: flex; 
            justify-content: center; 
            align-items: center;
            margin-top: 20px; 
            color: #64748b; 
            text-decoration: none; 
            font-weight: 600;
            padding: 10px;
            border-radius: 10px;
            transition: 0.2s;
        }
        .back-link:hover { background: rgba(255,255,255,0.05); color: #94a3b8; }

        /* [ëª¨ë‹¬] ë‹¤í¬ í…Œë§ˆ */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.7); z-index: 1000; align-items: center; justify-content: center;
            backdrop-filter: blur(5px);
        }
        .modal-box {
            background: #1e293b; /* ë‹¤í¬ ê·¸ë ˆì´ */
            width: 90%; max-width: 400px; padding: 30px; 
            border-radius: 24px; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); 
            text-align: center;
            border: 1px solid #334155;
            color: #f1f5f9;
        }
        .modal-box h3 { margin: 0 0 20px 0; color: #f1f5f9; font-size: 1.4rem; }
        
        .modal-info { 
            text-align: left; 
            background: #0f172a; 
            padding: 20px; 
            border-radius: 16px; 
            margin-bottom: 25px; 
            border: 1px solid #334155;
        }
        .modal-info p { 
            margin: 10px 0; 
            font-size: 1rem; 
            color: #cbd5e1; 
            display: flex; 
            justify-content: space-between; 
        }
        .modal-info b { color: white; }
        
        .modal-btns { display: flex; gap: 12px; }
        .modal-btn { 
            flex: 1; padding: 15px; border: none; border-radius: 12px; 
            font-size: 1rem; font-weight: bold; cursor: pointer; 
        }
        .btn-cancel { background: #334155; color: #94a3b8; }
        .btn-confirm { background: #3b82f6; color: white; }

        /* [ë¡œë”©] ë‹¤í¬ í…Œë§ˆ */
        #loading-layer { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(15, 23, 42, 0.9); z-index: 2000; 
            justify-content: center; align-items: center; flex-direction: column; 
        }
        .spinner { 
            width: 50px; height: 50px; 
            border: 4px solid #334155; 
            border-top: 4px solid #10b981; 
            border-radius: 50%; 
            animation: spin 1s linear infinite; 
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="loading-layer">
        <div class="spinner"></div>
        <p style="margin-top: 20px; font-weight: bold; color: #94a3b8;">ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3>ğŸ“‹ ê¸°ë¡ í™•ì¸</h3>
            <div class="modal-info">
                <p>í’ˆëª…: <b id="conf-name"></b></p>
                <p>í­: <b id="conf-width"></b></p>
                <p>ê¸¸ì´: <b id="conf-length"></b></p>
                <p>ì§€ê´€: <b id="conf-tube"></b></p>
                <p style="font-size: 1.2rem; margin-top: 15px; border-top: 1px dashed #334155; padding-top: 15px;">ìƒì‚° ìˆ˜ëŸ‰: <b id="conf-qty" style="color:#4ade80;"></b></p>
            </div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn btn-confirm" onclick="finalSubmit()">í™•ì¸ (ì €ì¥)</button>
            </div>
        </div>
    </div>

    <div class="prod-container">
        <h1>ğŸ”¨ ìƒì‚° ê¸°ë¡ ë“±ë¡</h1>
        
        <div id="last-update-info">
            ë§ˆì§€ë§‰ ë°˜ì˜: <span id="last-update-time" style="font-weight: bold; color: #cbd5e1;">ë¡œë”© ì¤‘...</span>
        </div>

        <div class="input-group">
            <label>ì‚¬ìš© ì§€ê´€ ì„ íƒ</label>
            <div class="tube-selection">
                <label><input type="radio" name="tubeType" value="ì¢…ì´ì§€ê´€(6)" checked> ì¢…ì´(6)</label>
                <label><input type="radio" name="tubeType" value="ppì§€ê´€(6)"> PP(6)</label>
            </div>
        </div>
        
        <div class="input-group">
            <label>ì‚¬ìš©í•œ ì›ë‹¨</label>
            <select id="select-material"><option value="">ì›ë‹¨ ì„ íƒ</option></select>
        </div>

        <div class="input-group">
            <label>í­ (Width)</label>
            <select id="width"><option value="">í­ ì„ íƒ</option></select>
        </div>

        <div class="input-group">
            <label>ì‚¬ì´ì¦ˆ (ê¸¸ì´)</label>
            <select id="size"><option value="">ì‚¬ì´ì¦ˆ ì„ íƒ</option></select>
        </div>

        <div class="input-group">
            <label>ìƒì‚° ìˆ˜ëŸ‰ (ê°œ)</label>
            <input type="number" id="quantity" placeholder="ìˆ˜ëŸ‰ ì…ë ¥" inputmode="numeric">
        </div>

        <button class="submit-btn" onclick="openConfirmation()">ê¸°ë¡ ì €ì¥</button>
        <a href="main.html" class="back-link">ğŸ  ë©”ì¸ í™”ë©´ìœ¼ë¡œ</a>
    </div>

    <script>
        // ê¸°ì¡´ ë¡œì§ 100% ìœ ì§€ (ìŠ¤í¬ë¦½íŠ¸ ë¶€ë¶„ì€ ìˆ˜ì • ì—†ìŒ)
        let pendingData = null; 

        window.onload = async () => {
            try {
                const [invRes, optRes] = await Promise.all([fetch('/api/inventory'), fetch('/api/options')]);
                const inventory = await invRes.json();
                const options = await optRes.json();

                // 1. ì›ìì¬ ë“œë¡­ë‹¤ìš´
                const materialSelect = document.getElementById('select-material');
                inventory.filter(item => item.category === 'ì›ìì¬').forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m._id;
                    opt.dataset.rawName = m.name;
                    opt.textContent = `${m.name} (ì”ì—¬: ${m.quantity})`;
                    materialSelect.appendChild(opt);
                });

                // 2. ì˜µì…˜ ë¶„ë¥˜
                const widthSelect = document.getElementById('width');
                const sizeSelect = document.getElementById('size');
                options.forEach(opt => {
                    const element = document.createElement('option');
                    element.value = opt.value;
                    element.textContent = opt.value;
                    if (opt.type === 'size') widthSelect.appendChild(element);
                    else if (opt.type === 'length') {
                        element.textContent = opt.value + "m";
                        sizeSelect.appendChild(element);
                    }
                });

                // 3. ë§ˆì§€ë§‰ ë°˜ì˜ ì‹œê°„ í‘œì‹œ
                if (inventory && inventory.length > 0) {
                    const sorted = inventory.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                    const lastItem = sorted[0];
                    if (lastItem && lastItem.updatedAt) {
                        const timeStr = new Date(lastItem.updatedAt).toLocaleString('ko-KR', {
                            month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit'
                        });
                        document.getElementById('last-update-time').innerText = timeStr + " (" + lastItem.name + ")";
                    } else {
                        document.getElementById('last-update-time').innerText = "ê¸°ë¡ ì—†ìŒ";
                    }
                } else {
                    document.getElementById('last-update-time').innerText = "ê¸°ë¡ ì—†ìŒ";
                }

            } catch (err) { 
                alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"); 
                document.getElementById('last-update-time').innerText = "í†µì‹  ì˜¤ë¥˜";
            }
        };

        // 1ë‹¨ê³„: íŒì—… ë„ìš°ê¸°
        function openConfirmation() {
            const materialEl = document.getElementById('select-material');
            if (!materialEl.value) return alert("ì›ë‹¨ì„ ì„ íƒí•˜ì„¸ìš”.");
            
            const tubeName = document.querySelector('input[name="tubeType"]:checked').value;
            const width = document.getElementById('width').value;
            const size = document.getElementById('size').value;
            const quantity = document.getElementById('quantity').value;

            if(!width || !size || !quantity) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");

            // ë°ì´í„° ì„ì‹œ ì €ì¥
            pendingData = {
                materialId: materialEl.value,
                materialName: materialEl.options[materialEl.selectedIndex].text,
                category: materialEl.options[materialEl.selectedIndex].dataset.rawName,
                width: width,
                size: size.replace('m', ''),
                quantity: parseInt(quantity),
                tubeName: tubeName
            };

            // íŒì—… í…ìŠ¤íŠ¸ ì±„ìš°ê¸°
            document.getElementById('conf-name').innerText = pendingData.category;
            document.getElementById('conf-width').innerText = pendingData.width;
            document.getElementById('conf-length').innerText = pendingData.size + "m";
            document.getElementById('conf-tube').innerText = pendingData.tubeName;
            document.getElementById('conf-qty').innerText = pendingData.quantity + "ê°œ";

            // íŒì—… í‘œì‹œ
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('confirm-modal').style.display = 'none';
            pendingData = null;
        }

        // 2ë‹¨ê³„: ì‹¤ì œ ì €ì¥ (ë¡œë”© í¬í•¨)
        async function finalSubmit() {
            if (!pendingData) return;

            // ë¡œë”© í‘œì‹œ
            document.getElementById('confirm-modal').style.display = 'none'; // íŒì—… ë‹«ê³ 
            document.getElementById('loading-layer').style.display = 'flex'; // ë¡œë”© ì—´ê³ 

            try {
                const res = await fetch('/api/inventory/produce', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(pendingData)
                });

                if(res.ok) {
                    alert("âœ… ì„±ê³µì ìœ¼ë¡œ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!");
                    location.reload();
                } else {
                    const err = await res.json();
                    alert("âŒ ì˜¤ë¥˜: " + err.error);
                    document.getElementById('loading-layer').style.display = 'none';
                }
            } catch (err) {
                alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
                document.getElementById('loading-layer').style.display = 'none';
            }
        }
    </script>
</body>
</html>