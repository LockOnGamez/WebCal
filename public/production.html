<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ”¨ ìƒì‚° ê¸°ë¡ ë“±ë¡</title>
    <style>
        /* [í…Œë§ˆ ë³€ìˆ˜] */
        :root {
            --bg-color: #f3f4f6;
            --text-main: #1f2937;
            --text-sub: #666;
            --card-bg: rgba(255,255,255,0.9);
            --card-border: #ddd;
            --input-bg: #fff;
            --input-border: #ccc;
            --modal-bg: #fff;
        }
        [data-theme="dark"] {
            --bg-color: #0f172a;
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            --card-bg: rgba(30, 41, 59, 0.7);
            --card-border: rgba(255, 255, 255, 0.1);
            --input-bg: #0f172a;
            --input-border: #334155;
            --modal-bg: #1e293b;
        }

        body { 
            background-color: var(--bg-color); color: var(--text-main);
            padding: 20px; font-family: 'Pretendard', -apple-system, sans-serif; 
            margin: 0; display: flex; justify-content: center; min-height: 100vh;
            transition: 0.3s;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .prod-container { 
            width: 100%; max-width: 500px; 
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            border: 1px solid var(--card-border);
            padding: 30px; border-radius: 24px; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.1); 
            box-sizing: border-box; height: fit-content; margin-top: 20px;
        }

        h1 { 
            font-size: 1.6rem; text-align: center; margin: 0 0 25px 0; font-weight: 800;
            background: linear-gradient(to right, #4ade80, #3b82f6); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
        }
        
        #last-update-info {
            text-align: center; color: var(--text-sub); font-size: 0.9rem; margin-bottom: 25px; 
            background: var(--input-bg); padding: 12px; border-radius: 12px; border: 1px solid var(--card-border);
        }

        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 10px; font-weight: 600; color: var(--text-sub); font-size: 0.95rem; }
        
        select, input[type="number"], input[type="text"] { 
            width: 100%; height: 55px; padding: 0 15px; font-size: 16px; 
            border-radius: 12px; border: 1px solid var(--input-border); 
            background-color: var(--input-bg); color: var(--text-main);
            box-sizing: border-box; transition: 0.2s;
        }
        select:focus, input:focus { outline: none; border-color: #3b82f6; }

        /* ë¼ë””ì˜¤ */
        .tube-selection { display: flex; gap: 15px; padding: 5px 0; }
        .tube-selection label { 
            font-weight: normal; font-size: 1rem; display: flex; align-items: center; gap: 8px; 
            cursor: pointer; background: var(--input-bg); padding: 10px 15px; border-radius: 10px; border: 1px solid var(--input-border);
        }
        .tube-selection label:hover { border-color: #3b82f6; }
        .tube-selection input { width: 20px; height: 20px; accent-color: #3b82f6; margin: 0; }

        .submit-btn { 
            width: 100%; height: 60px; font-size: 1.1rem; 
            background: linear-gradient(135deg, #10b981, #059669); 
            color: white; border: none; border-radius: 16px; 
            cursor: pointer; font-weight: 800; margin-top: 10px; 
        }
        
        /* ëª¨ë‹¬ */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1000; align-items: center; justify-content: center; backdrop-filter: blur(5px); }
        .modal-box {
            background: var(--modal-bg); width: 90%; max-width: 400px; padding: 30px; 
            border-radius: 24px; text-align: center; border: 1px solid var(--card-border); color: var(--text-main);
        }
        .modal-info { text-align: left; background: var(--bg-color); padding: 20px; border-radius: 16px; margin-bottom: 25px; border: 1px solid var(--card-border); }
        .modal-info p { margin: 10px 0; font-size: 1rem; color: var(--text-sub); display: flex; justify-content: space-between; }
        .modal-info b { color: var(--text-main); }
        
        .modal-btns { display: flex; gap: 12px; }
        .modal-btn { flex: 1; padding: 15px; border: none; border-radius: 12px; font-size: 1rem; font-weight: bold; cursor: pointer; }
        .btn-cancel { background: var(--input-bg); color: var(--text-sub); border:1px solid var(--input-border); }
        .btn-confirm { background: #3b82f6; color: white; }

        /* ë¡œë”© */
        #loading-layer { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); opacity:0.9; z-index: 2000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 4px solid var(--card-border); border-top: 4px solid #10b981; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* í™ˆë²„íŠ¼ & í…Œë§ˆë²„íŠ¼ */
        .nav-actions { margin-top: 20px; display: flex; justify-content: center; gap: 15px; }
        .nav-link { text-decoration: none; color: var(--text-sub); font-weight: 600; padding: 10px; border-radius: 10px; cursor: pointer; background: var(--input-bg); border: 1px solid var(--input-border); }
    </style>
</head>
<body>
    <div id="loading-layer">
        <div class="spinner"></div>
        <p style="margin-top: 20px; font-weight: bold; color: var(--text-sub);">ì €ì¥ ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>

    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0;">ğŸ“‹ ê¸°ë¡ í™•ì¸</h3>
            <div class="modal-info">
                <p>í’ˆëª…: <b id="conf-name"></b></p>
                <p>í­: <b id="conf-width"></b></p>
                <p>ê¸¸ì´: <b id="conf-length"></b></p>
                <p>ì§€ê´€: <b id="conf-tube"></b></p>
                <p style="font-size: 1.2rem; margin-top: 15px; border-top: 1px dashed var(--card-border); padding-top: 15px;">ìƒì‚° ìˆ˜ëŸ‰: <b id="conf-qty" style="color:#4ade80;"></b></p>
            </div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn btn-confirm" onclick="finalSubmit()">í™•ì¸ (ì €ì¥)</button>
            </div>
        </div>
    </div>

    <div class="prod-container">
        <h1>ğŸ”¨ ìƒì‚° ê¸°ë¡ ë“±ë¡</h1>
        
        <div id="last-update-info">
            ë§ˆì§€ë§‰ ë°˜ì˜: <span id="last-update-time" style="font-weight: bold;">ë¡œë”© ì¤‘...</span>
        </div>

        <div class="input-group">
            <label>ì‚¬ìš© ì§€ê´€ ì„ íƒ</label>
            <div class="tube-selection">
                <label><input type="radio" name="tubeType" value="ì¢…ì´ì§€ê´€(6)" checked> ì¢…ì´(6)</label>
                <label><input type="radio" name="tubeType" value="ppì§€ê´€(6)"> PP(6)</label>
            </div>
        </div>
        
        <div class="input-group">
            <label>ì‚¬ìš©í•œ ì›ë‹¨</label>
            <select id="select-material"><option value="">ì›ë‹¨ ì„ íƒ</option></select>
        </div>

        <div class="input-group">
            <label>í­ (Width)</label>
            <select id="width"><option value="">í­ ì„ íƒ</option></select>
        </div>

        <div class="input-group">
            <label>ì‚¬ì´ì¦ˆ (ê¸¸ì´)</label>
            <select id="size"><option value="">ì‚¬ì´ì¦ˆ ì„ íƒ</option></select>
        </div>

        <div class="input-group">
            <label>ìƒì‚° ìˆ˜ëŸ‰ (ê°œ)</label>
            <input type="number" id="quantity" placeholder="ìˆ˜ëŸ‰ ì…ë ¥" inputmode="numeric">
        </div>

        <button class="submit-btn" onclick="openConfirmation()">ê¸°ë¡ ì €ì¥</button>
        
        <div class="nav-actions">
            <button class="nav-link" onclick="toggleTheme()" id="theme-btn">ğŸŒ™</button>
            <a href="main.html" class="nav-link">ğŸ  í™ˆìœ¼ë¡œ</a>
        </div>
    </div>

    <script>
        function initTheme() {
            const saved = localStorage.getItem('theme') || 'dark';
            document.body.setAttribute('data-theme', saved);
            document.getElementById('theme-btn').innerText = saved === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
        }
        function toggleTheme() {
            const nxt = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', nxt);
            localStorage.setItem('theme', nxt);
            document.getElementById('theme-btn').innerText = nxt === 'dark' ? 'ğŸŒ™' : 'â˜€ï¸';
        }
        initTheme();

        let pendingData = null; 

        window.onload = async () => {
            initTheme();
            try {
                const [invRes, optRes] = await Promise.all([fetch('/api/inventory'), fetch('/api/options')]);
                const inventory = await invRes.json();
                const options = await optRes.json();

                // 1. ì›ìì¬ ë“œë¡­ë‹¤ìš´
                const materialSelect = document.getElementById('select-material');
                inventory.filter(item => item.category === 'ì›ìì¬').forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m._id;
                    opt.dataset.rawName = m.name;
                    opt.textContent = `${m.name} (ì”ì—¬: ${m.quantity})`;
                    materialSelect.appendChild(opt);
                });

                // 2. ì˜µì…˜ ë¶„ë¥˜
                const widthSelect = document.getElementById('width');
                const sizeSelect = document.getElementById('size');
                options.forEach(opt => {
                    const element = document.createElement('option');
                    element.value = opt.value;
                    element.textContent = opt.value;
                    if (opt.type === 'size') widthSelect.appendChild(element);
                    else if (opt.type === 'length') {
                        element.textContent = opt.value + "m";
                        sizeSelect.appendChild(element);
                    }
                });

                // 3. ë§ˆì§€ë§‰ ë°˜ì˜ ì‹œê°„
                if (inventory && inventory.length > 0) {
                    const sorted = inventory.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                    const lastItem = sorted[0];
                    if (lastItem && lastItem.updatedAt) {
                        const timeStr = new Date(lastItem.updatedAt).toLocaleString('ko-KR', { month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        document.getElementById('last-update-time').innerText = timeStr + " (" + lastItem.name + ")";
                    } else { document.getElementById('last-update-time').innerText = "ê¸°ë¡ ì—†ìŒ"; }
                } else { document.getElementById('last-update-time').innerText = "ê¸°ë¡ ì—†ìŒ"; }

            } catch (err) { alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨"); document.getElementById('last-update-time').innerText = "í†µì‹  ì˜¤ë¥˜"; }
        };

        function openConfirmation() {
            const materialEl = document.getElementById('select-material');
            if (!materialEl.value) return alert("ì›ë‹¨ì„ ì„ íƒí•˜ì„¸ìš”.");
            
            const tubeName = document.querySelector('input[name="tubeType"]:checked').value;
            const width = document.getElementById('width').value;
            const size = document.getElementById('size').value;
            const quantity = document.getElementById('quantity').value;

            if(!width || !size || !quantity) return alert("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.");

            pendingData = {
                materialId: materialEl.value, materialName: materialEl.options[materialEl.selectedIndex].text,
                category: materialEl.options[materialEl.selectedIndex].dataset.rawName,
                width: width, size: size.replace('m', ''), quantity: parseInt(quantity), tubeName: tubeName
            };

            document.getElementById('conf-name').innerText = pendingData.category;
            document.getElementById('conf-width').innerText = pendingData.width;
            document.getElementById('conf-length').innerText = pendingData.size + "m";
            document.getElementById('conf-tube').innerText = pendingData.tubeName;
            document.getElementById('conf-qty').innerText = pendingData.quantity + "ê°œ";
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; pendingData = null; }

        async function finalSubmit() {
            if (!pendingData) return;
            document.getElementById('confirm-modal').style.display = 'none';
            document.getElementById('loading-layer').style.display = 'flex';

            try {
                const res = await fetch('/api/inventory/produce', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(pendingData) });
                if(res.ok) { alert("âœ… ê¸°ë¡ ì™„ë£Œ!"); location.reload(); } 
                else { const err = await res.json(); alert("âŒ ì˜¤ë¥˜: " + err.error); document.getElementById('loading-layer').style.display = 'none'; }
            } catch (err) { alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨"); document.getElementById('loading-layer').style.display = 'none'; }
        }
    </script>
</body>
</html>