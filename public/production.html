<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ğŸ”¨ ìƒì‚° ê¸°ë¡ ë“±ë¡</title>
    <link rel="stylesheet" href="css/themes.css">
    <style>
        body {
            background-color: var(--bg-color);
            color: var(--text-main);
            padding: 20px;
            font-family: 'Pretendard', -apple-system, sans-serif;
            margin: 0;
            display: flex;
            justify-content: center;
            min-height: 100vh;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
            overflow-x: hidden;
            align-items: center;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .prod-container {
            width: 100%;
            max-width: 520px;
            background: var(--card-bg);
            backdrop-filter: var(--glass-blur);
            -webkit-backdrop-filter: var(--glass-blur);
            border: 1px solid var(--card-border);
            padding: 40px;
            border-radius: 32px;
            box-shadow: var(--card-shadow);
            box-sizing: border-box;
            height: fit-content;
            position: relative;
            z-index: 10;
            animation: slideUp 0.6s cubic-bezier(0.22, 1, 0.36, 1);
        }

        h1 {
            font-size: 1.8rem;
            text-align: center;
            margin: 0 0 30px 0;
            font-weight: 900;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -1px;
            filter: drop-shadow(0 0 10px var(--highlight-glow));
        }

        #last-update-info {
            text-align: center;
            color: var(--text-sub);
            font-size: 0.95rem;
            margin-bottom: 30px;
            background: var(--highlight-glow);
            padding: 15px;
            border-radius: 16px;
            border: 1px solid var(--card-border);
            font-weight: 700;
        }

        .input-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 12px;
            font-weight: 800;
            color: var(--text-sub);
            font-size: 0.95rem;
        }

        select,
        input[type="number"],
        input[type="text"] {
            width: 100%;
            height: 60px;
            padding: 0 20px;
            font-size: 17px;
            border-radius: 16px;
            border: 1px solid var(--card-border);
            background-color: var(--card-bg);
            color: var(--text-main);
            box-sizing: border-box;
            transition: all 0.3s ease;
        }

        select:focus,
        input:focus {
            outline: none;
            border-color: var(--highlight);
            box-shadow: 0 0 0 4px var(--highlight-glow);
            transform: translateY(-2px);
        }

        /* ë¼ë””ì˜¤ */
        .tube-selection {
            display: flex;
            gap: 15px;
            padding: 5px 0;
        }

        .tube-selection label {
            flex: 1;
            font-weight: 700;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            cursor: pointer;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 14px;
            border: 1px solid var(--card-border);
            transition: all 0.3s ease;
        }

        .tube-selection label:hover {
            border-color: var(--highlight);
            transform: translateY(-2px);
        }

        .tube-selection input {
            width: 22px;
            height: 22px;
            accent-color: var(--highlight);
            margin: 0;
        }

        .submit-btn {
            width: 100%;
            height: 65px;
            font-size: 1.2rem;
            background: var(--accent-gradient);
            color: white;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 900;
            margin-top: 15px;
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 8px 20px var(--highlight-glow);
            letter-spacing: 1.5px;
        }

        .submit-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 30px var(--highlight-glow);
            filter: brightness(1.1);
        }

        .submit-btn:active {
            transform: scale(0.96);
        }

        /* ëª¨ë‹¬ */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.4);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .modal-box {
            background: var(--card-bg);
            width: 95%;
            max-width: 420px;
            padding: 40px;
            border-radius: 32px;
            text-align: center;
            border: 1px solid var(--card-border);
            color: var(--text-main);
            box-shadow: var(--card-shadow);
            animation: slideUp 0.5s cubic-bezier(0.22, 1, 0.36, 1);
        }

        .modal-info {
            text-align: left;
            background: var(--highlight-glow);
            padding: 25px;
            border-radius: 20px;
            margin-bottom: 30px;
            border: 1px solid var(--card-border);
        }

        .modal-info p {
            margin: 12px 0;
            font-size: 1.05rem;
            color: var(--text-sub);
            display: flex;
            justify-content: space-between;
            font-weight: 700;
        }

        .modal-info b {
            color: var(--text-main);
            font-weight: 900;
        }

        .modal-btns {
            display: flex;
            gap: 15px;
        }

        .modal-btn {
            flex: 1;
            padding: 18px;
            border: none;
            border-radius: 16px;
            font-size: 1.1rem;
            font-weight: 900;
            cursor: pointer;
            transition: 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
        }

        .btn-cancel {
            background: var(--btn-hover);
            color: var(--text-sub);
            border: 1px solid var(--card-border);
        }

        .btn-confirm {
            background: var(--accent-gradient);
            color: white;
            box-shadow: 0 4px 15px var(--highlight-glow);
        }

        .modal-btn:hover {
            transform: translateY(-3px);
            filter: brightness(1.1);
        }

        /* ë°°ê²½ ì¥ì‹ */
        .bg-blob {
            position: fixed;
            width: 500px;
            height: 500px;
            background: var(--highlight-glow);
            filter: blur(120px);
            border-radius: 50%;
            z-index: -1;
            opacity: 0.2;
            display: none;
        }

        [data-theme="glass"] .bg-blob {
            display: block;
        }

        .blob-1 {
            top: -200px;
            left: -200px;
        }

        .blob-2 {
            bottom: -200px;
            right: -200px;
        }

        /* ë¡œë”© */
        #loading-layer {
            display: flex;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--loading-bg);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            transition: opacity 0.5s ease;
        }

        /* ë„¤ë¹„ê²Œì´ì…˜ */
        .nav-actions {
            margin-top: 30px;
            display: flex;
            justify-content: center;
            gap: 20px;
            position: relative;
            z-index: 10;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-sub);
            font-weight: 800;
            padding: 12px 24px;
            border-radius: 14px;
            cursor: pointer;
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: var(--card-shadow);
        }

        .nav-link:hover {
            transform: translateY(-3px);
            border-color: var(--highlight);
            color: var(--highlight);
        }

        .theme-toggle {
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            padding: 0;
        }

        /* [ëª¨ë°”ì¼ ëŒ€ì‘] ë¯¸ë””ì–´ ì¿¼ë¦¬ ì¡°ì • ë° ê°•ì œ ì ìš© */
        @media (max-width: 768px) {
            body {
                padding: 15px !important;
            }

            .prod-container {
                width: 95% !important;
                max-width: none !important;
                padding: 30px 20px !important;
                border-radius: 24px !important;
            }

            h1 {
                font-size: 1.6rem !important;
                margin-bottom: 20px !important;
            }

            #last-update-info {
                font-size: 0.85rem !important;
                padding: 12px !important;
            }

            select,
            input[type="number"],
            input[type="text"] {
                height: 55px !important;
                font-size: 16px !important;
            }

            .tube-selection label {
                padding: 12px !important;
                font-size: 0.9rem !important;
            }

            .submit-btn {
                height: 60px !important;
                font-size: 1.1rem !important;
            }

            .modal-box {
                width: 95% !important;
                max-width: none !important;
                padding: 30px 20px !important;
                border-radius: 24px !important;
            }

            .nav-link {
                padding: 10px 15px !important;
                font-size: 0.9rem !important;
            }
        }
    </style>
</head>

<body class="animate-fade">
    <div class="bg-blob blob-1"></div>
    <div class="bg-blob blob-2"></div>
    <div id="loading-layer">
        <div class="flashy-loader"></div>
        <p
            style="margin-top: 25px; font-weight: 900; letter-spacing: 2px; color: var(--text-main); text-transform: uppercase; animation: pulse-glow 1.5s infinite;">
            Processing Record...</p>
    </div>


    <div id="confirm-modal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-top:0;">ğŸ“‹ ê¸°ë¡ í™•ì¸</h3>
            <div class="modal-info">
                <p>í’ˆëª…: <b id="conf-name"></b></p>
                <p>í­: <b id="conf-width"></b></p>
                <p>ê¸¸ì´: <b id="conf-length"></b></p>
                <p>ì§€ê´€: <b id="conf-tube"></b></p>
                <p
                    style="font-size: 1.2rem; margin-top: 15px; border-top: 1px dashed var(--card-border); padding-top: 15px;">
                    ìƒì‚° ìˆ˜ëŸ‰: <b id="conf-qty" style="color:#4ade80;"></b></p>
            </div>
            <div class="modal-btns">
                <button class="modal-btn btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
                <button class="modal-btn btn-confirm" onclick="finalSubmit()">í™•ì¸ (ì €ì¥)</button>
            </div>
        </div>
    </div>

    <div class="prod-container">
        <h1>ğŸ”¨ ìƒì‚° ê¸°ë¡ ë“±ë¡</h1>

        <div id="last-update-info">
            ë§ˆì§€ë§‰ ë°˜ì˜: <span id="last-update-time" style="font-weight: bold;">ë¡œë”© ì¤‘...</span>
        </div>

        <div class="input-group">
            <label>ì‚¬ìš© ì§€ê´€ ì„ íƒ</label>
            <div class="tube-selection">
                <label><input type="radio" name="tubeType" value="ì¢…ì´ì§€ê´€(6)" checked> ì¢…ì´(6)</label>
                <label><input type="radio" name="tubeType" value="ppì§€ê´€(6)"> PP(6)</label>
            </div>
        </div>

        <div class="input-group">
            <label>ì‚¬ìš©í•œ ì›ë‹¨</label>
            <select id="select-material">
                <option value="">ì›ë‹¨ ì„ íƒ</option>
            </select>
        </div>

        <div class="input-group">
            <label>í­ (Width)</label>
            <select id="width">
                <option value="">í­ ì„ íƒ</option>
            </select>
        </div>

        <div class="input-group">
            <label>ì‚¬ì´ì¦ˆ (ê¸¸ì´)</label>
            <select id="size">
                <option value="">ì‚¬ì´ì¦ˆ ì„ íƒ</option>
            </select>
        </div>

        <div class="input-group">
            <label>ìƒì‚° ìˆ˜ëŸ‰ (ê°œ)</label>
            <input type="number" id="quantity" placeholder="ìˆ˜ëŸ‰ ì…ë ¥" inputmode="numeric">
        </div>

        <button class="submit-btn" onclick="openConfirmation()">ê¸°ë¡ ì €ì¥</button>

        <div class="nav-actions">
            <a href="main.html" class="nav-link">ğŸ  í™ˆìœ¼ë¡œ</a>
        </div>
    </div>

    <script src="js/ui.js"></script>
    <script src="js/nav.js"></script>
    <script>
        const themes = ['light', 'dark', 'glass', 'street'];
        const themeIcons = {
            'light': 'â˜€ï¸', 'dark': 'ğŸŒ™', 'glass': 'ğŸ’', 'street': 'ğŸ¤'
        };

        function initTheme() {
            const savedTheme = localStorage.getItem('theme') || 'dark';
            applyTheme(savedTheme);
        }

        function toggleTheme() {
            // Removed per user request
        }

        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            const btn = document.getElementById('theme-btn');
            if (btn) btn.innerHTML = themeIcons[theme] || 'ğŸŒ™';

            document.body.classList.remove('animate-fade');
            void document.body.offsetWidth;
            document.body.classList.add('animate-fade');
        }
        initTheme();

        let pendingData = null;

        window.onload = async () => {
            initTheme();
            try {
                const [invRes, optRes] = await Promise.all([fetch('/api/inventory'), fetch('/api/options')]);
                const inventory = await invRes.json();
                const options = await optRes.json();

                // 1. ì›ìì¬ ë“œë¡­ë‹¤ìš´
                const materialSelect = document.getElementById('select-material');
                inventory.filter(item => item.category === 'ì›ìì¬').forEach(m => {
                    const opt = document.createElement('option');
                    opt.value = m._id;
                    opt.dataset.rawName = m.name;
                    opt.textContent = `${m.name} (ì”ì—¬: ${m.quantity})`;
                    materialSelect.appendChild(opt);
                });

                // 2. ì˜µì…˜ ë¶„ë¥˜
                const widthSelect = document.getElementById('width');
                const sizeSelect = document.getElementById('size');
                options.forEach(opt => {
                    const element = document.createElement('option');
                    element.value = opt.value;
                    element.textContent = opt.value;
                    if (opt.type === 'size') widthSelect.appendChild(element);
                    else if (opt.type === 'length') {
                        element.textContent = opt.value + "m";
                        sizeSelect.appendChild(element);
                    }
                });

                // 3. ë§ˆì§€ë§‰ ë°˜ì˜ ì‹œê°„
                if (inventory && inventory.length > 0) {
                    const sorted = inventory.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                    const lastItem = sorted[0];
                    if (lastItem && lastItem.updatedAt) {
                        const timeStr = new Date(lastItem.updatedAt).toLocaleString('ko-KR', { month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                        document.getElementById('last-update-time').innerText = timeStr + " (" + lastItem.name + ")";
                    } else { document.getElementById('last-update-time').innerText = "ê¸°ë¡ ì—†ìŒ"; }
                } else { document.getElementById('last-update-time').innerText = "ê¸°ë¡ ì—†ìŒ"; }

            } catch (err) {
                UI.showToast("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", "error");
                document.getElementById('last-update-time').innerText = "í†µì‹  ì˜¤ë¥˜";
            } finally {
                document.getElementById('loading-layer').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('loading-layer').style.display = 'none';
                }, 500);
            }
        };

        function openConfirmation() {
            const materialEl = document.getElementById('select-material');
            if (!materialEl.value) return UI.showToast("ì›ë‹¨ì„ ì„ íƒí•˜ì„¸ìš”.", "warning");

            const tubeName = document.querySelector('input[name="tubeType"]:checked').value;
            const width = document.getElementById('width').value;
            const size = document.getElementById('size').value;
            const quantity = document.getElementById('quantity').value;

            if (!width || !size || !quantity) return UI.showToast("ëª¨ë“  í•­ëª©ì„ ì…ë ¥í•˜ì„¸ìš”.", "warning");

            pendingData = {
                materialId: materialEl.value, materialName: materialEl.options[materialEl.selectedIndex].text,
                category: materialEl.options[materialEl.selectedIndex].dataset.rawName,
                width: width, size: size.replace('m', ''), quantity: parseInt(quantity), tubeName: tubeName
            };

            document.getElementById('conf-name').innerText = pendingData.category;
            document.getElementById('conf-width').innerText = pendingData.width;
            document.getElementById('conf-length').innerText = pendingData.size + "m";
            document.getElementById('conf-tube').innerText = pendingData.tubeName;
            document.getElementById('conf-qty').innerText = pendingData.quantity + "ê°œ";
            document.getElementById('confirm-modal').style.display = 'flex';
        }

        function closeModal() { document.getElementById('confirm-modal').style.display = 'none'; pendingData = null; }

        async function finalSubmit() {
            if (!pendingData) return;
            document.getElementById('confirm-modal').style.display = 'none';

            // ë¡œë”© ë ˆì´ì–´ í‘œì‹œ ë° ë¶ˆíˆ¬ëª…ë„ ì¡°ì ˆ
            const loader = document.getElementById('loading-layer');
            const loaderText = loader.querySelector('p');
            if (loaderText) loaderText.innerText = "Saving Production Record...";

            loader.style.display = 'flex';
            void loader.offsetWidth; // ë¦¬í”Œë¡œìš° ê°•ì œ (íŠ¸ëœì§€ì…˜ íŠ¸ë¦¬ê±°)
            loader.style.opacity = '1';

            try {
                const res = await fetch('/api/inventory/produce', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(pendingData) });
                if (res.ok) {
                    UI.showToast("âœ… ê¸°ë¡ ì™„ë£Œ!", "success");
                    setTimeout(() => location.reload(), 1500);
                } else {
                    const err = await res.json();
                    UI.alert("ê¸°ë¡ ì‹¤íŒ¨", (err.message || err.error || "ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤."), "error");
                    loader.style.opacity = '0';
                    setTimeout(() => loader.style.display = 'none', 500);
                }
            } catch (err) {
                UI.alert("ì—°ê²° ì˜¤ë¥˜", "ì„œë²„ì™€ í†µì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.", "error");
                loader.style.opacity = '0';
                setTimeout(() => loader.style.display = 'none', 500);
            }
        }
    </script>
</body>

</html>